import{_ as $e,r as i,s as ve,i as Te,c as N,o as x,f as k,b as a,w as o,d as v,j as U,E as C,k as he,l as Ee,h as y,x as Ie,y as qe,n as R,t as fe,F as Q,v as W,p as Re,q as Oe}from"./app-C7b5dp06.js";const Ae={style:{"margin-bottom":"20px"}},Be={style:{display:"flex",gap:"10px",width:"100%"}},Fe={__name:"Index",setup(De){const Y=i([]),M=i([]),ee=i([]),L=i(!1),K=i(!1),z=i(!1),O=i(null),P=i(""),A=i(1),Z=i(15),le=i(0),B=i(null),T=i(!1),F=i(null),G=i(!1),ae=i(null),r=i({api_url:"",username:"",password:"",environment:"production",sync_mode:{inventory:"manual",price:"manual",order:"manual"},order_provider:null,credentials:{ctrip:{username:"",password:""},meituan:{username:"",password:""},fliggy:{username:"",password:""}},is_active:!0}),H=ve(()=>B.value!==null),ge=ve(()=>H.value?"编辑景区":"创建景区"),u=i({name:"",code:"",address:"",contact_phone:"",description:"",software_provider_id:null,is_active:!0}),_e={name:[{required:!0,message:"请输入景区名称",trigger:"blur"},{max:255,message:"景区名称不能超过255个字符",trigger:"blur"}],code:[{required:!0,message:"请输入景区编码",trigger:"blur"},{pattern:/^[a-zA-Z0-9_-]+$/,message:"景区编码只能包含字母、数字、下划线和连字符",trigger:"blur"}],contact_phone:[{pattern:/^1[3-9]\d{9}$|^0\d{2,3}-?\d{7,8}$/,message:"请输入正确的电话号码",trigger:"blur"}]},ye={api_url:[{required:!0,message:"请输入接口地址",trigger:"blur"},{type:"url",message:"请输入有效的URL",trigger:["blur","change"]}],username:[{required:!0,message:"请输入默认用户名",trigger:"blur"}],password:[{min:0,max:255,message:"密码长度不能超过255个字符",trigger:"blur"}],environment:[{required:!0,message:"请选择环境",trigger:"change"}],"sync_mode.inventory":[{required:!0,message:"请选择库存同步方式",trigger:"change"}],"sync_mode.price":[{required:!0,message:"请选择价格同步方式",trigger:"change"}],"sync_mode.order":[{required:!0,message:"请选择订单处理方式",trigger:"change"}]},S=async()=>{L.value=!0;try{const t={page:A.value,per_page:Z.value};P.value;const e=await U.get("/scenic-spots",{params:t});Y.value=e.data.data||[],le.value=e.data.total||0}catch(t){C.error("获取景区列表失败"),console.error(t)}finally{L.value=!1}},we=async()=>{try{const t=await U.get("/software-providers");M.value=t.data.data||[]}catch(t){console.error("获取软件服务商列表失败",t)}},be=async()=>{try{const t=await U.get("/ota-platforms");ee.value=t.data.data||[]}catch(t){console.error("获取OTA平台列表失败",t)}},Ve=()=>{A.value=1,S()},xe=()=>{B.value=null,oe(),z.value=!0},Ce=t=>{B.value=t.id,u.value={name:t.name,code:t.code,address:t.address||"",contact_phone:t.contact_phone||"",description:t.description||"",software_provider_id:t.software_provider_id,is_active:t.is_active},z.value=!0},Ue=async()=>{O.value&&await O.value.validate(async t=>{var e,p,b,n,s,f;if(t){K.value=!0;try{H.value?(await U.put(`/scenic-spots/${B.value}`,u.value),C.success("景区更新成功")):(await U.post("/scenic-spots",u.value),C.success("景区创建成功")),z.value=!1,S()}catch(w){const c=((p=(e=w.response)==null?void 0:e.data)==null?void 0:p.message)||((f=(s=(n=(b=w.response)==null?void 0:b.data)==null?void 0:n.errors)==null?void 0:s.code)==null?void 0:f[0])||"操作失败";C.error(c)}finally{K.value=!1}}})},Se=async t=>{try{await Oe.confirm(`确定要删除景区"${t.name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await U.delete(`/scenic-spots/${t.id}`),C.success("删除成功"),S()}catch(e){e!=="cancel"&&(C.error("删除失败"),console.error(e))}},oe=()=>{var t;u.value={name:"",code:"",address:"",contact_phone:"",description:"",software_provider_id:null,is_active:!0},(t=O.value)==null||t.clearValidate()},ke=async t=>{var e,p,b,n,s,f,w,c,D,d,g,V,h,E,I,j,q,X,l,_,te,re,se,ne,de,ue,ie,pe,me,ce;ae.value=t.id,T.value=!0;try{const $=await U.get(`/scenic-spots/${t.id}/resource-config`);if($.data.success&&$.data.data){const m=$.data.data;r.value={api_url:m.api_url||"",username:m.username||"",password:m.password==="***EXISTS***"?"":m.password||"",environment:m.environment||"production",sync_mode:((e=m.extra_config)==null?void 0:e.sync_mode)||{inventory:"manual",price:"manual",order:"manual"},order_provider:((p=m.extra_config)==null?void 0:p.order_provider)||null,credentials:{ctrip:{username:((s=(n=(b=m.extra_config)==null?void 0:b.credentials)==null?void 0:n.ctrip)==null?void 0:s.username)||"",password:((c=(w=(f=m.extra_config)==null?void 0:f.credentials)==null?void 0:w.ctrip)==null?void 0:c.password)==="***EXISTS***"?"":((g=(d=(D=m.extra_config)==null?void 0:D.credentials)==null?void 0:d.ctrip)==null?void 0:g.password)||""},meituan:{username:((E=(h=(V=m.extra_config)==null?void 0:V.credentials)==null?void 0:h.meituan)==null?void 0:E.username)||"",password:((q=(j=(I=m.extra_config)==null?void 0:I.credentials)==null?void 0:j.meituan)==null?void 0:q.password)==="***EXISTS***"?"":((_=(l=(X=m.extra_config)==null?void 0:X.credentials)==null?void 0:l.meituan)==null?void 0:_.password)||""},fliggy:{username:((se=(re=(te=m.extra_config)==null?void 0:te.credentials)==null?void 0:re.fliggy)==null?void 0:se.username)||"",password:((ue=(de=(ne=m.extra_config)==null?void 0:ne.credentials)==null?void 0:de.fliggy)==null?void 0:ue.password)==="***EXISTS***"?"":((me=(pe=(ie=m.extra_config)==null?void 0:ie.credentials)==null?void 0:pe.fliggy)==null?void 0:me.password)||""}},is_active:m.is_active??!0}}else J()}catch($){((ce=$.response)==null?void 0:ce.status)!==404&&(C.error("获取资源配置失败"),console.error($)),J()}},ze=async()=>{F.value&&await F.value.validate(async t=>{var e,p,b,n;if(t){G.value=!0;try{const s={};for(const[w,c]of Object.entries(r.value.credentials||{}))c&&(c.username||c.password)&&(s[w]={username:c.username||"",password:c.password||""});const f={api_url:r.value.api_url,username:r.value.username,...r.value.password&&r.value.password!=="***EXISTS***"?{password:String(r.value.password)}:{},environment:r.value.environment,is_active:r.value.is_active,sync_mode:r.value.sync_mode,order_provider:r.value.order_provider||null,credentials:Object.keys(s).length>0?s:{}};await U.post(`/scenic-spots/${ae.value}/resource-config`,f),C.success("资源配置保存成功"),T.value=!1,S()}catch(s){let f="保存失败";if((p=(e=s.response)==null?void 0:e.data)!=null&&p.message)f=s.response.data.message;else if((n=(b=s.response)==null?void 0:b.data)!=null&&n.errors){const w=s.response.data.errors,c=Object.values(w)[0];f=Array.isArray(c)?c[0]:c}C.error(f),console.error("保存资源配置失败:",s)}finally{G.value=!1}}})},J=()=>{var t;r.value={api_url:"",username:"",password:"",environment:"production",sync_mode:{inventory:"manual",price:"manual",order:"manual"},order_provider:null,credentials:{ctrip:{username:"",password:""},meituan:{username:"",password:""},fliggy:{username:"",password:""}},is_active:!0},(t=F.value)==null||t.clearValidate()};return Te(()=>{S(),we(),be()}),(t,e)=>{const p=v("el-button"),b=v("el-icon"),n=v("el-input"),s=v("el-table-column"),f=v("el-tag"),w=v("el-table"),c=v("el-pagination"),D=v("el-card"),d=v("el-form-item"),g=v("el-option"),V=v("el-select"),h=v("el-switch"),E=v("el-form"),I=v("el-dialog"),j=v("el-alert"),q=v("el-divider"),X=he("loading");return x(),N("div",null,[e[37]||(e[37]=k("h2",null,"景区管理",-1)),a(D,null,{default:o(()=>[k("div",Ae,[a(p,{type:"primary",onClick:xe},{default:o(()=>[...e[23]||(e[23]=[y("创建景区",-1)])]),_:1}),a(n,{modelValue:P.value,"onUpdate:modelValue":e[0]||(e[0]=l=>P.value=l),placeholder:"搜索景区名称或编码",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:Ve},{prefix:o(()=>[a(b,null,{default:o(()=>[a(Ie(qe))]),_:1})]),_:1},8,["modelValue"])]),Ee((x(),R(w,{data:Y.value,border:""},{default:o(()=>[a(s,{prop:"name",label:"景区名称",width:"200"}),a(s,{prop:"code",label:"景区编码",width:"150"}),a(s,{prop:"address",label:"地址","show-overflow-tooltip":""}),a(s,{prop:"contact_phone",label:"联系电话",width:"150"}),a(s,{label:"软件服务商",width:"150"},{default:o(({row:l})=>{var _;return[y(fe(((_=l.software_provider)==null?void 0:_.name)||"-"),1)]}),_:1}),a(s,{prop:"is_active",label:"状态",width:"100"},{default:o(({row:l})=>[a(f,{type:l.is_active?"success":"danger"},{default:o(()=>[y(fe(l.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(s,{label:"操作",width:"280",fixed:"right"},{default:o(({row:l})=>[a(p,{size:"small",onClick:_=>Ce(l)},{default:o(()=>[...e[24]||(e[24]=[y("编辑",-1)])]),_:1},8,["onClick"]),a(p,{size:"small",type:"info",onClick:_=>ke(l)},{default:o(()=>[...e[25]||(e[25]=[y("配置资源方",-1)])]),_:1},8,["onClick"]),a(p,{size:"small",type:"danger",onClick:_=>Se(l)},{default:o(()=>[...e[26]||(e[26]=[y("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[X,L.value]]),a(c,{"current-page":A.value,"onUpdate:currentPage":e[1]||(e[1]=l=>A.value=l),"page-size":Z.value,"onUpdate:pageSize":e[2]||(e[2]=l=>Z.value=l),"page-sizes":[10,20,50,100],total:le.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:S,onCurrentChange:S},null,8,["current-page","page-size","total"])]),_:1}),a(I,{modelValue:z.value,"onUpdate:modelValue":e[11]||(e[11]=l=>z.value=l),title:ge.value,width:"600px",onClose:oe},{footer:o(()=>[a(p,{onClick:e[10]||(e[10]=l=>z.value=!1)},{default:o(()=>[...e[27]||(e[27]=[y("取消",-1)])]),_:1}),a(p,{type:"primary",onClick:Ue,loading:K.value},{default:o(()=>[...e[28]||(e[28]=[y("确定",-1)])]),_:1},8,["loading"])]),default:o(()=>[a(E,{ref_key:"formRef",ref:O,model:u.value,rules:_e,"label-width":"120px"},{default:o(()=>[a(d,{label:"景区名称",prop:"name"},{default:o(()=>[a(n,{modelValue:u.value.name,"onUpdate:modelValue":e[3]||(e[3]=l=>u.value.name=l),placeholder:"请输入景区名称"},null,8,["modelValue"])]),_:1}),a(d,{label:"景区编码",prop:"code"},{default:o(()=>[a(n,{modelValue:u.value.code,"onUpdate:modelValue":e[4]||(e[4]=l=>u.value.code=l),placeholder:"请输入景区编码（唯一）",disabled:H.value},null,8,["modelValue","disabled"])]),_:1}),a(d,{label:"地址",prop:"address"},{default:o(()=>[a(n,{modelValue:u.value.address,"onUpdate:modelValue":e[5]||(e[5]=l=>u.value.address=l),placeholder:"请输入景区地址"},null,8,["modelValue"])]),_:1}),a(d,{label:"联系电话",prop:"contact_phone"},{default:o(()=>[a(n,{modelValue:u.value.contact_phone,"onUpdate:modelValue":e[6]||(e[6]=l=>u.value.contact_phone=l),placeholder:"请输入联系电话"},null,8,["modelValue"])]),_:1}),a(d,{label:"软件服务商",prop:"software_provider_id"},{default:o(()=>[a(V,{modelValue:u.value.software_provider_id,"onUpdate:modelValue":e[7]||(e[7]=l=>u.value.software_provider_id=l),placeholder:"请选择软件服务商",clearable:"",style:{width:"100%"}},{default:o(()=>[(x(!0),N(Q,null,W(M.value,l=>(x(),R(g,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"描述",prop:"description"},{default:o(()=>[a(n,{modelValue:u.value.description,"onUpdate:modelValue":e[8]||(e[8]=l=>u.value.description=l),type:"textarea",rows:4,placeholder:"请输入景区描述"},null,8,["modelValue"])]),_:1}),a(d,{label:"状态",prop:"is_active"},{default:o(()=>[a(h,{modelValue:u.value.is_active,"onUpdate:modelValue":e[9]||(e[9]=l=>u.value.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(I,{modelValue:T.value,"onUpdate:modelValue":e[22]||(e[22]=l=>T.value=l),title:"资源配置",width:"800px",onClose:J},{footer:o(()=>[a(p,{onClick:e[21]||(e[21]=l=>T.value=!1)},{default:o(()=>[...e[35]||(e[35]=[y("取消",-1)])]),_:1}),a(p,{type:"primary",onClick:ze,loading:G.value},{default:o(()=>[...e[36]||(e[36]=[y("保存",-1)])]),_:1},8,["loading"])]),default:o(()=>[a(j,{title:"重要提示",type:"warning",description:"不同OTA平台的订单需要使用不同的用户名和密码。请为每个OTA平台配置对应的认证信息。",closable:!1,style:{"margin-bottom":"20px"}}),a(E,{ref_key:"resourceConfigFormRef",ref:F,model:r.value,rules:ye,"label-width":"140px"},{default:o(()=>[a(d,{label:"接口地址",prop:"api_url"},{default:o(()=>[a(n,{modelValue:r.value.api_url,"onUpdate:modelValue":e[12]||(e[12]=l=>r.value.api_url=l),placeholder:"例如：https://e.hengdianworld.com/Interface/hotel_order.aspx"},null,8,["modelValue"])]),_:1}),a(d,{label:"默认用户名",prop:"username"},{default:o(()=>[a(n,{modelValue:r.value.username,"onUpdate:modelValue":e[13]||(e[13]=l=>r.value.username=l),placeholder:"用于库存推送订阅等非订单场景"},null,8,["modelValue"])]),_:1}),a(d,{label:"默认密码",prop:"password"},{default:o(()=>[a(n,{modelValue:r.value.password,"onUpdate:modelValue":e[14]||(e[14]=l=>r.value.password=l),type:"password","show-password":"",placeholder:"用于库存推送订阅等非订单场景"},null,8,["modelValue"])]),_:1}),a(d,{label:"环境",prop:"environment"},{default:o(()=>[a(V,{modelValue:r.value.environment,"onUpdate:modelValue":e[15]||(e[15]=l=>r.value.environment=l),style:{width:"100%"}},{default:o(()=>[a(g,{label:"生产环境",value:"production"})]),_:1},8,["modelValue"])]),_:1}),a(q,null,{default:o(()=>[...e[29]||(e[29]=[y("同步方式配置",-1)])]),_:1}),a(d,{label:"库存同步方式",prop:"sync_mode.inventory"},{default:o(()=>[a(V,{modelValue:r.value.sync_mode.inventory,"onUpdate:modelValue":e[16]||(e[16]=l=>r.value.sync_mode.inventory=l),style:{width:"100%"}},{default:o(()=>[a(g,{label:"资源方推送",value:"push"}),a(g,{label:"手工维护",value:"manual"})]),_:1},8,["modelValue"]),e[30]||(e[30]=k("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}},' 选择"资源方推送"后，系统将自动接收资源方推送的库存信息 ',-1))]),_:1}),a(d,{label:"价格同步方式",prop:"sync_mode.price"},{default:o(()=>[a(V,{modelValue:r.value.sync_mode.price,"onUpdate:modelValue":e[17]||(e[17]=l=>r.value.sync_mode.price=l),style:{width:"100%"}},{default:o(()=>[a(g,{label:"资源方推送",value:"push"}),a(g,{label:"手工维护",value:"manual"})]),_:1},8,["modelValue"]),e[31]||(e[31]=k("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}},' 选择"资源方推送"后，系统将自动接收资源方推送的价格信息 ',-1))]),_:1}),a(d,{label:"订单处理方式",prop:"sync_mode.order"},{default:o(()=>[a(V,{modelValue:r.value.sync_mode.order,"onUpdate:modelValue":e[18]||(e[18]=l=>r.value.sync_mode.order=l),style:{width:"100%"}},{default:o(()=>[a(g,{label:"系统直连",value:"auto"}),a(g,{label:"手工操作",value:"manual"}),a(g,{label:"其他系统",value:"other"})]),_:1},8,["modelValue"]),e[32]||(e[32]=k("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}},' 选择"系统直连"后，订单将自动调用资源方接口；选择"其他系统"需要指定系统服务商 ',-1))]),_:1}),r.value.sync_mode.order==="other"?(x(),R(d,{key:0,label:"订单系统服务商",prop:"order_provider"},{default:o(()=>[a(V,{modelValue:r.value.order_provider,"onUpdate:modelValue":e[19]||(e[19]=l=>r.value.order_provider=l),placeholder:"请选择系统服务商",style:{width:"100%"}},{default:o(()=>[(x(!0),N(Q,null,W(M.value,l=>(x(),R(g,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):Re("",!0),a(q,null,{default:o(()=>[...e[33]||(e[33]=[y("OTA平台认证信息",-1)])]),_:1}),(x(!0),N(Q,null,W(ee.value,l=>(x(),R(d,{key:l.id,label:`${l.name}认证信息`},{default:o(()=>[k("div",Be,[a(n,{modelValue:r.value.credentials[l.code].username,"onUpdate:modelValue":_=>r.value.credentials[l.code].username=_,placeholder:"用户名",style:{flex:"1"}},null,8,["modelValue","onUpdate:modelValue"]),a(n,{modelValue:r.value.credentials[l.code].password,"onUpdate:modelValue":_=>r.value.credentials[l.code].password=_,type:"password",placeholder:"密码",style:{flex:"1"},"show-password":""},null,8,["modelValue","onUpdate:modelValue"])]),e[34]||(e[34]=k("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}}," 该平台订单将使用此认证信息调用资源方接口 ",-1))]),_:2},1032,["label"]))),128)),a(d,{label:"状态",prop:"is_active"},{default:o(()=>[a(h,{modelValue:r.value.is_active,"onUpdate:modelValue":e[20]||(e[20]=l=>r.value.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Xe=$e(Fe,[["__scopeId","data-v-ac9018a5"]]);export{Xe as default};
