import{_ as Ee,u as Fe,r as p,A as ue,i as Re,c as _,o as r,f as U,b as a,w as s,d as c,k as f,E as x,e as He,l as Ie,m as Pe,h as m,F as b,p as h,q as k,y as E,B as Ne,t as C,s as Ae,D as re,G as ie,v as Ke}from"./app-De5uvzDL.js";const je={style:{"margin-bottom":"20px"}},Ge={key:0},Le={key:1},Je={key:0},Oe={key:0},Qe={key:1},We={style:{width:"100%"}},Xe={style:{width:"100%"}},Ze={__name:"Index",setup(et){const F=Fe(),O=He(),Q=p([]),D=p([]),A=p(!1),R=p(""),H=p(null),I=p(null),Y=p(1),K=p(15),W=p(0),$=p(!1),j=p(!1),M=p(null),P=p(null),n=p({scenic_spot_id:null,product_name:"",stay_days:1,description:"",status:1,sale_start_date:null,sale_end_date:null,bundle_items:[],hotel_room_types:[]}),T=p([]),z=p([]),S=p([]),N=ue(()=>P.value!==null),pe=ue(()=>N.value?"编辑打包产品":"创建打包产品"),_e={scenic_spot_id:[{required:!0,message:"请选择所属景区",trigger:"change"}],product_name:[{required:!0,message:"请输入产品名称",trigger:"blur"},{max:100,message:"产品名称不能超过100个字符",trigger:"blur"}],stay_days:[{required:!0,message:"请输入入住天数",trigger:"blur"},{type:"number",min:1,max:30,message:"入住天数必须在1-30天之间",trigger:"blur"}],bundle_items:[{validator:(t,e,o)=>{if(!e||e.length===0)o(new Error("请至少添加一个关联门票"));else{const d=e.map(V=>V.ticket_id),v=[...new Set(d)];d.length!==v.length?o(new Error("不能添加重复的门票")):o()}},trigger:"change"}],hotel_room_types:[{validator:(t,e,o)=>{if(!e||e.length===0)o(new Error("请至少添加一个关联酒店房型"));else{const d=e.map(V=>`${V.hotel_id}_${V.room_type_id}`),v=[...new Set(d)];d.length!==v.length?o(new Error("不能添加重复的酒店房型组合")):o()}},trigger:"change"}],sale_start_date:[{type:"date",message:"请选择有效的日期",trigger:"change"}],sale_end_date:[{type:"date",message:"请选择有效的日期",trigger:"change"},{validator:(t,e,o)=>{e&&n.value.sale_start_date&&new Date(e)<new Date(n.value.sale_start_date)?o(new Error("销售结束日期不能早于销售开始日期")):o()},trigger:"change"}]},w=async()=>{A.value=!0;try{const t={page:Y.value,per_page:K.value};H.value&&(t.scenic_spot_id=H.value),I.value!==null&&(t.status=I.value),R.value&&(t.search=R.value);const e=await f.get("/pkg-products",{params:t});Q.value=e.data.data||[],W.value=e.data.total||0}catch(t){x.error("获取打包产品列表失败"),console.error(t)}finally{A.value=!1}},ce=async()=>{var t,e,o;try{if(((t=F.user)==null?void 0:t.role)!=="admin")D.value=((e=F.user)==null?void 0:e.scenic_spots)||[];else{const d=await f.get("/scenic-spots");D.value=d.data.data||[]}}catch(d){console.error("获取景区列表失败",d),(o=F.user)!=null&&o.scenic_spots&&(D.value=F.user.scenic_spots)}},me=()=>{Y.value=1,w()},X=()=>{Y.value=1,w()},ve=()=>{P.value=null,ae(),$.value=!0},ye=t=>{O.push(`/pkg-products/${t.id}/detail`)},ge=t=>{O.push(`/pkg-products/${t.id}/price-management`)},Z=t=>{if(!t)return null;if(typeof t=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(t))return t;if(typeof t=="string"&&t.includes("T"))return t.split("T")[0];if(t instanceof Date){const e=t.getUTCFullYear(),o=String(t.getUTCMonth()+1).padStart(2,"0"),d=String(t.getUTCDate()).padStart(2,"0");return`${e}-${o}-${d}`}if(typeof t=="string"){const e=t.match(/^(\d{4}-\d{2}-\d{2})/);if(e)return e[1]}return t},fe=async t=>{P.value=t.id;try{const o=(await f.get(`/pkg-products/${t.id}`)).data.data;n.value={scenic_spot_id:o.scenic_spot_id,product_name:o.product_name,stay_days:o.stay_days||1,description:o.description||"",status:o.status,sale_start_date:Z(o.sale_start_date),sale_end_date:Z(o.sale_end_date),bundle_items:(o.bundle_items||[]).map(d=>({ticket_id:d.ticket_id,quantity:d.quantity||1})),hotel_room_types:(o.hotel_room_types||[]).map(d=>({hotel_id:d.hotel_id,room_type_id:d.room_type_id}))},n.value.scenic_spot_id&&(await ee(n.value.scenic_spot_id),await te(n.value.scenic_spot_id),await le()),$.value=!0}catch(e){x.error("获取产品信息失败"),console.error(e)}},be=async t=>{var e,o;try{await Ke.confirm(`确定要删除打包产品"${t.product_name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await f.delete(`/pkg-products/${t.id}`),x.success("删除成功"),w()}catch(d){if(d!=="cancel"){const v=((o=(e=d.response)==null?void 0:e.data)==null?void 0:o.message)||"删除失败";x.error(v)}}},he=t=>{if(!t)return"";const e=new Date(t),o=e.getFullYear(),d=String(e.getMonth()+1).padStart(2,"0"),v=String(e.getDate()).padStart(2,"0"),V=String(e.getHours()).padStart(2,"0"),q=String(e.getMinutes()).padStart(2,"0");return`${o}-${d}-${v} ${V}:${q}`},Ve=()=>{n.value.bundle_items.push({ticket_id:null,quantity:1})},ke=t=>{n.value.bundle_items.splice(t,1),G()},G=()=>{var t;(t=M.value)==null||t.validateField("bundle_items")},we=()=>{n.value.hotel_room_types.push({hotel_id:null,room_type_id:null})},xe=t=>{n.value.hotel_room_types.splice(t,1),L()},Ce=t=>{n.value.hotel_room_types[t].room_type_id=null,L()},L=()=>{var t;(t=M.value)==null||t.validateField("hotel_room_types")},$e=t=>t?S.value.filter(e=>e.hotel_id===t&&e.is_active):[],Ue=async t=>{t?(await ee(t),await te(t),await le()):(T.value=[],z.value=[],S.value=[])},ee=async t=>{try{const e=await f.get("/tickets",{params:{scenic_spot_id:t,is_active:!0,per_page:1e3}});T.value=e.data.data||[]}catch(e){console.error("获取门票列表失败",e),T.value=[]}},te=async t=>{try{const e=await f.get("/res-hotels",{params:{scenic_spot_id:t,is_active:!0,per_page:1e3}});z.value=e.data.data||[]}catch(e){console.error("获取酒店列表失败",e),z.value=[]}},le=async()=>{try{const t=await f.get("/res-room-types",{params:{is_active:!0,per_page:1e3}});S.value=t.data.data||[]}catch(t){console.error("获取房型列表失败",t),S.value=[]}},De=async()=>{var t,e;try{await M.value.validate(),j.value=!0;const o={scenic_spot_id:n.value.scenic_spot_id,product_name:n.value.product_name,stay_days:n.value.stay_days,description:n.value.description||"",status:n.value.status,sale_start_date:n.value.sale_start_date||null,sale_end_date:n.value.sale_end_date||null,bundle_items:n.value.bundle_items.map(d=>({ticket_id:d.ticket_id,quantity:d.quantity||1})),hotel_room_types:n.value.hotel_room_types.map(d=>({hotel_id:d.hotel_id,room_type_id:d.room_type_id}))};N.value?(await f.put(`/pkg-products/${P.value}`,o),x.success("更新成功")):(await f.post("/pkg-products",o),x.success("创建成功")),$.value=!1,w()}catch(o){if(o!==!1){const d=((e=(t=o.response)==null?void 0:t.data)==null?void 0:e.message)||(N.value?"更新失败":"创建失败");x.error(d),console.error(o)}}finally{j.value=!1}},ae=()=>{var t;n.value={scenic_spot_id:null,product_name:"",stay_days:1,description:"",status:1,sale_start_date:null,sale_end_date:null,bundle_items:[],hotel_room_types:[]},T.value=[],z.value=[],S.value=[],(t=M.value)==null||t.clearValidate()};return Re(()=>{w(),ce()}),(t,e)=>{const o=c("el-button"),d=c("el-option"),v=c("el-select"),V=c("el-icon"),q=c("el-input"),y=c("el-table-column"),J=c("el-tag"),Ye=c("el-table"),Me=c("el-pagination"),Te=c("el-card"),g=c("el-form-item"),oe=c("el-input-number"),se=c("el-radio"),ze=c("el-radio-group"),ne=c("el-date-picker"),Se=c("el-form"),qe=c("el-dialog"),Be=Ie("loading");return r(),_("div",null,[e[27]||(e[27]=U("h2",null,"打包产品管理",-1)),a(Te,null,{default:s(()=>[U("div",je,[a(o,{type:"primary",onClick:ve},{default:s(()=>[...e[14]||(e[14]=[m("创建打包产品",-1)])]),_:1}),a(v,{modelValue:H.value,"onUpdate:modelValue":e[0]||(e[0]=l=>H.value=l),placeholder:"筛选景区",clearable:"",style:{width:"200px","margin-left":"10px"},onChange:X},{default:s(()=>[(r(!0),_(b,null,h(D.value,l=>(r(),k(d,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(v,{modelValue:I.value,"onUpdate:modelValue":e[1]||(e[1]=l=>I.value=l),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:X},{default:s(()=>[a(d,{label:"启用",value:1}),a(d,{label:"禁用",value:0})]),_:1},8,["modelValue"]),a(q,{modelValue:R.value,"onUpdate:modelValue":e[2]||(e[2]=l=>R.value=l),placeholder:"搜索产品名称或编码",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:me},{prefix:s(()=>[a(V,null,{default:s(()=>[a(E(Ne))]),_:1})]),_:1},8,["modelValue"])]),Pe((r(),k(Ye,{data:Q.value,border:""},{default:s(()=>[a(y,{prop:"product_name",label:"产品名称",width:"200"}),a(y,{prop:"product_code",label:"产品编码",width:"150"}),a(y,{label:"所属景区",width:"150"},{default:s(({row:l})=>{var i;return[m(C(((i=l.scenic_spot)==null?void 0:i.name)||"-"),1)]}),_:1}),a(y,{label:"关联门票",width:"200"},{default:s(({row:l})=>[l.bundle_items&&l.bundle_items.length>0?(r(),_("div",Ge,[(r(!0),_(b,null,h(l.bundle_items,(i,u)=>(r(),k(J,{key:u,size:"small",style:{"margin-right":"5px"}},{default:s(()=>{var B;return[m(C(((B=i.ticket)==null?void 0:B.name)||"未知")+" x"+C(i.quantity||1),1)]}),_:2},1024))),128))])):(r(),_("span",Le,"-"))]),_:1}),a(y,{label:"关联酒店房型",width:"200"},{default:s(({row:l})=>[l.hotel_room_types&&l.hotel_room_types.length>0?(r(),_("div",Je,[(r(!0),_(b,null,h(l.hotel_room_types.slice(0,2),(i,u)=>(r(),k(J,{key:u,size:"small",style:{"margin-right":"5px"}},{default:s(()=>{var B,de;return[m(C(((B=i.hotel)==null?void 0:B.name)||"未知")+"-"+C(((de=i.room_type)==null?void 0:de.name)||"未知"),1)]}),_:2},1024))),128)),l.hotel_room_types.length>2?(r(),_("span",Oe,"...")):Ae("",!0)])):(r(),_("span",Qe,"-"))]),_:1}),a(y,{prop:"stay_days",label:"入住天数",width:"100"}),a(y,{prop:"description",label:"描述","show-overflow-tooltip":""}),a(y,{prop:"status",label:"状态",width:"100"},{default:s(({row:l})=>[a(J,{type:l.status===1?"success":"danger"},{default:s(()=>[m(C(l.status===1?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(y,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:l})=>[m(C(he(l.created_at)),1)]),_:1}),a(y,{label:"操作",width:"280",fixed:"right"},{default:s(({row:l})=>[a(o,{size:"small",onClick:i=>ye(l)},{default:s(()=>[...e[15]||(e[15]=[m("详情",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",type:"primary",onClick:i=>ge(l)},{default:s(()=>[...e[16]||(e[16]=[m("价格管理",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",onClick:i=>fe(l)},{default:s(()=>[...e[17]||(e[17]=[m("编辑",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",type:"danger",onClick:i=>be(l)},{default:s(()=>[...e[18]||(e[18]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Be,A.value]]),a(Me,{"current-page":Y.value,"onUpdate:currentPage":e[3]||(e[3]=l=>Y.value=l),"page-size":K.value,"onUpdate:pageSize":e[4]||(e[4]=l=>K.value=l),"page-sizes":[10,20,50,100],total:W.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:w,onCurrentChange:w},null,8,["current-page","page-size","total"])]),_:1}),a(qe,{modelValue:$.value,"onUpdate:modelValue":e[13]||(e[13]=l=>$.value=l),title:pe.value,width:"900px",onClose:ae},{footer:s(()=>[a(o,{onClick:e[12]||(e[12]=l=>$.value=!1)},{default:s(()=>[...e[25]||(e[25]=[m("取消",-1)])]),_:1}),a(o,{type:"primary",onClick:De,loading:j.value},{default:s(()=>[...e[26]||(e[26]=[m("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[a(Se,{ref_key:"formRef",ref:M,model:n.value,rules:_e,"label-width":"120px"},{default:s(()=>[a(g,{label:"所属景区",prop:"scenic_spot_id"},{default:s(()=>[a(v,{modelValue:n.value.scenic_spot_id,"onUpdate:modelValue":e[5]||(e[5]=l=>n.value.scenic_spot_id=l),placeholder:"请选择景区",style:{width:"100%"},disabled:N.value,onChange:Ue},{default:s(()=>[(r(!0),_(b,null,h(D.value,l=>(r(),k(d,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),a(g,{label:"产品名称",prop:"product_name"},{default:s(()=>[a(q,{modelValue:n.value.product_name,"onUpdate:modelValue":e[6]||(e[6]=l=>n.value.product_name=l),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),a(g,{label:"入住天数",prop:"stay_days"},{default:s(()=>[a(oe,{modelValue:n.value.stay_days,"onUpdate:modelValue":e[7]||(e[7]=l=>n.value.stay_days=l),min:1,max:30,style:{width:"100%"},placeholder:"请输入入住天数"},null,8,["modelValue"])]),_:1}),a(g,{label:"描述",prop:"description"},{default:s(()=>[a(q,{modelValue:n.value.description,"onUpdate:modelValue":e[8]||(e[8]=l=>n.value.description=l),type:"textarea",rows:3,placeholder:"请输入描述"},null,8,["modelValue"])]),_:1}),a(g,{label:"状态",prop:"status"},{default:s(()=>[a(ze,{modelValue:n.value.status,"onUpdate:modelValue":e[9]||(e[9]=l=>n.value.status=l)},{default:s(()=>[a(se,{label:1},{default:s(()=>[...e[19]||(e[19]=[m("启用",-1)])]),_:1}),a(se,{label:0},{default:s(()=>[...e[20]||(e[20]=[m("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(g,{label:"销售开始日期",prop:"sale_start_date"},{default:s(()=>[a(ne,{modelValue:n.value.sale_start_date,"onUpdate:modelValue":e[10]||(e[10]=l=>n.value.sale_start_date=l),type:"date",placeholder:"选择销售开始日期（可选）",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"]),e[21]||(e[21]=U("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}}," 不设置表示不限制开始日期 ",-1))]),_:1}),a(g,{label:"销售结束日期",prop:"sale_end_date"},{default:s(()=>[a(ne,{modelValue:n.value.sale_end_date,"onUpdate:modelValue":e[11]||(e[11]=l=>n.value.sale_end_date=l),type:"date",placeholder:"选择销售结束日期（可选）",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD","disabled-date":l=>n.value.sale_start_date&&l<new Date(n.value.sale_start_date),style:{width:"100%"}},null,8,["modelValue","disabled-date"]),e[22]||(e[22]=U("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}}," 不设置表示不限制结束日期 ",-1))]),_:1}),a(g,{label:"关联门票",prop:"bundle_items"},{default:s(()=>[U("div",We,[(r(!0),_(b,null,h(n.value.bundle_items,(l,i)=>(r(),_("div",{key:i,style:{display:"flex",gap:"10px","margin-bottom":"10px","align-items":"center"}},[a(v,{modelValue:l.ticket_id,"onUpdate:modelValue":u=>l.ticket_id=u,placeholder:"选择门票",style:{flex:"1"},filterable:"",onChange:G},{default:s(()=>[(r(!0),_(b,null,h(T.value,u=>(r(),k(d,{key:u.id,label:`${u.name} (${u.code})`,value:u.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),a(oe,{modelValue:l.quantity,"onUpdate:modelValue":u=>l.quantity=u,min:1,max:10,placeholder:"数量",style:{width:"120px"},onChange:G},null,8,["modelValue","onUpdate:modelValue"]),a(o,{type:"danger",icon:E(re),circle:"",onClick:u=>ke(i)},null,8,["icon","onClick"])]))),128)),a(o,{type:"primary",icon:E(ie),onClick:Ve,disabled:!n.value.scenic_spot_id},{default:s(()=>[...e[23]||(e[23]=[m(" 添加门票 ",-1)])]),_:1},8,["icon","disabled"])])]),_:1}),a(g,{label:"关联酒店房型",prop:"hotel_room_types"},{default:s(()=>[U("div",Xe,[(r(!0),_(b,null,h(n.value.hotel_room_types,(l,i)=>(r(),_("div",{key:i,style:{display:"flex",gap:"10px","margin-bottom":"10px","align-items":"center"}},[a(v,{modelValue:l.hotel_id,"onUpdate:modelValue":u=>l.hotel_id=u,placeholder:"选择酒店",style:{flex:"1"},filterable:"",onChange:u=>Ce(i)},{default:s(()=>[(r(!0),_(b,null,h(z.value,u=>(r(),k(d,{key:u.id,label:u.name,value:u.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),a(v,{modelValue:l.room_type_id,"onUpdate:modelValue":u=>l.room_type_id=u,placeholder:"选择房型",style:{flex:"1"},filterable:"",disabled:!l.hotel_id,onChange:L},{default:s(()=>[(r(!0),_(b,null,h($e(l.hotel_id),u=>(r(),k(d,{key:u.id,label:u.name,value:u.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),a(o,{type:"danger",icon:E(re),circle:"",onClick:u=>xe(i)},null,8,["icon","onClick"])]))),128)),a(o,{type:"primary",icon:E(ie),onClick:we,disabled:!n.value.scenic_spot_id},{default:s(()=>[...e[24]||(e[24]=[m(" 添加酒店房型 ",-1)])]),_:1},8,["icon","disabled"])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},lt=Ee(Ze,[["__scopeId","data-v-b2b5a263"]]);export{lt as default};
