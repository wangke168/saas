import{_ as se,r as p,x as ue,i as ce,c as $,o as m,b as a,m as L,w as o,d as u,l as ie,q as b,k as D,B as de,E as g,e as pe,f as h,t as _,s as q,h as s,y as I,G as _e,H as me,I as fe,F as G,p as j,v as P}from"./app-CQIcOIsZ.js";const ge={key:0},ve={style:{"margin-bottom":"20px"}},ye={style:{"margin-bottom":"20px"}},he={__name:"PriceManagement",setup(be){const w=de(),J=pe(),M=p(!1),i=p(null),O=p(!1),B=p(!1),Y=p(!1),S=p(!1),A=p([]),f=p([]),v=p(null),k=p(null),E=p([]),C=p([]);ue(()=>v.value?C.value.filter(t=>t.hotel_id===v.value):C.value);const K=()=>{J.push("/pkg-products")},Q=t=>{if(!t)return"";const e=new Date(t),n=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),d=String(e.getDate()).padStart(2,"0"),c=String(e.getHours()).padStart(2,"0"),T=String(e.getMinutes()).padStart(2,"0");return`${n}-${r}-${d} ${c}:${T}`},W=t=>{if(!t)return"";const e=new Date(t),n=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),d=String(e.getDate()).padStart(2,"0");return`${n}-${r}-${d}`},R=t=>t?parseFloat(t).toFixed(2):"0.00",X=async()=>{M.value=!0;try{const t=await D.get(`/pkg-products/${w.params.id}`);if(i.value=t.data.data,i.value.hotel_room_types){const r=new Map,d=new Map;i.value.hotel_room_types.forEach(c=>{c.hotel&&!r.has(c.hotel.id)&&r.set(c.hotel.id,c.hotel),c.room_type&&!d.has(c.room_type.id)&&d.set(c.room_type.id,{...c.room_type,hotel_id:c.hotel_id})}),E.value=Array.from(r.values()),C.value=Array.from(d.values())}const e=new Date,n=new Date;n.setDate(e.getDate()+30),f.value=[e.toISOString().split("T")[0],n.toISOString().split("T")[0]],await x()}catch(t){g.error("获取产品详情失败"),console.error(t)}finally{M.value=!1}},x=async()=>{if(i.value){S.value=!0;try{const t={};f.value&&f.value.length===2&&(t.start_date=f.value[0],t.end_date=f.value[1]),v.value&&(t.hotel_id=v.value),k.value&&(t.room_type_id=k.value);const e=await D.get(`/pkg-products/${w.params.id}/prices/calendar`,{params:t});A.value=e.data.data||[]}catch(t){g.error("获取价格日历失败"),console.error(t)}finally{S.value=!1}}},Z=()=>{f.value=[],v.value=null,k.value=null,x()},ee=async()=>{var t,e;try{await P.confirm("确定要预计算未来60天的价格吗？这可能需要一些时间，将在后台异步处理。","提示",{type:"info"}),O.value=!0;try{await D.post(`/pkg-products/${w.params.id}/prices/calculate`),g.success("价格预计算任务已提交，正在后台处理，请稍后刷新查看结果")}catch(n){const r=((e=(t=n.response)==null?void 0:t.data)==null?void 0:e.message)||n.message||"操作失败";g.error(r),console.error(n)}finally{O.value=!1}}catch{}},te=async()=>{var t,e;try{await P.confirm("确定要重新计算价格吗？这将重新计算所有关联的门票和酒店价格，可能需要一些时间。","提示",{type:"warning"}),B.value=!0;try{await D.post(`/pkg-products/${w.params.id}/prices/recalculate`),g.success("价格重新计算任务已提交，正在后台处理，请稍后刷新查看结果")}catch(n){const r=((e=(t=n.response)==null?void 0:t.data)==null?void 0:e.message)||n.message||"操作失败";g.error(r),console.error(n)}finally{B.value=!1}}catch{}},ae=async()=>{var t,e;try{const{value:n}=await P.prompt("请选择要推送的OTA平台","推送价格到OTA",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"select",inputOptions:{ctrip:"携程",meituan:"美团"},inputPlaceholder:"请选择OTA平台"});if(!n)return;Y.value=!0;try{await D.post(`/pkg-products/${w.params.id}/prices/sync-to-ota`,{platform_code:n}),g.success("价格推送到OTA任务已提交，正在后台处理，请稍后查看结果")}catch(r){const d=((e=(t=r.response)==null?void 0:t.data)==null?void 0:e.message)||r.message||"操作失败";g.error(d),console.error(r)}finally{Y.value=!1}}catch{}};return ce(()=>{X()}),(t,e)=>{const n=u("el-page-header"),r=u("el-descriptions-item"),d=u("el-tag"),c=u("el-descriptions"),T=u("el-divider"),F=u("el-icon"),V=u("el-button"),le=u("el-alert"),oe=u("el-date-picker"),N=u("el-option"),z=u("el-select"),y=u("el-table-column"),ne=u("el-table"),H=u("el-empty"),re=u("el-card"),U=ie("loading");return m(),$("div",null,[a(n,{onBack:K,title:"返回打包产品列表"},{content:o(()=>{var l;return[h("span",null,"价格管理 - "+_(((l=i.value)==null?void 0:l.product_name)||"加载中..."),1)]}),_:1}),L((m(),b(re,{style:{"margin-top":"20px"}},{default:o(()=>[i.value?(m(),$("div",ge,[a(c,{title:"产品基本信息",column:2,border:"",style:{"margin-bottom":"20px"}},{default:o(()=>[a(r,{label:"产品名称"},{default:o(()=>[s(_(i.value.product_name),1)]),_:1}),a(r,{label:"产品编码"},{default:o(()=>[s(_(i.value.product_code),1)]),_:1}),a(r,{label:"所属景区"},{default:o(()=>{var l;return[s(_(((l=i.value.scenic_spot)==null?void 0:l.name)||"-"),1)]}),_:1}),a(r,{label:"入住天数"},{default:o(()=>[s(_(i.value.stay_days)+" 天",1)]),_:1}),a(r,{label:"状态"},{default:o(()=>[a(d,{type:i.value.status===1?"success":"danger"},{default:o(()=>[s(_(i.value.status===1?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1})]),_:1}),a(T,null,{default:o(()=>[...e[3]||(e[3]=[s("价格管理操作",-1)])]),_:1}),h("div",ve,[a(V,{type:"primary",onClick:ee,loading:O.value},{default:o(()=>[a(F,null,{default:o(()=>[a(I(_e))]),_:1}),e[4]||(e[4]=s(" 预计算价格（未来60天） ",-1))]),_:1},8,["loading"]),a(V,{type:"success",onClick:te,loading:B.value},{default:o(()=>[a(F,null,{default:o(()=>[a(I(me))]),_:1}),e[5]||(e[5]=s(" 重新计算价格 ",-1))]),_:1},8,["loading"]),a(V,{type:"warning",onClick:ae,loading:Y.value},{default:o(()=>[a(F,null,{default:o(()=>[a(I(fe))]),_:1}),e[6]||(e[6]=s(" 推送价格到OTA ",-1))]),_:1},8,["loading"]),a(le,{title:"提示",type:"info",closable:!1,style:{"margin-top":"10px"}},{default:o(()=>[...e[7]||(e[7]=[h("div",null,[h("p",null,"• 预计算价格：为产品计算未来60天的价格日历"),h("p",null,"• 重新计算价格：当门票或酒店价格变更后，重新计算产品价格"),h("p",null,"• 价格公式：酒店价格 + Σ(门票价格 × 张数)")],-1)])]),_:1})]),a(T,null,{default:o(()=>[...e[8]||(e[8]=[s("价格日历",-1)])]),_:1}),h("div",ye,[a(oe,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=l=>f.value=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{"margin-right":"10px"},onChange:x},null,8,["modelValue"]),a(z,{modelValue:v.value,"onUpdate:modelValue":e[1]||(e[1]=l=>v.value=l),placeholder:"筛选酒店",clearable:"",style:{width:"200px","margin-right":"10px"},onChange:x},{default:o(()=>[(m(!0),$(G,null,j(E.value,l=>(m(),b(N,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(z,{modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=l=>k.value=l),placeholder:"筛选房型",clearable:"",style:{width:"200px","margin-right":"10px"},onChange:x},{default:o(()=>[(m(!0),$(G,null,j(C.value,l=>(m(),b(N,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(V,{onClick:Z},{default:o(()=>[...e[9]||(e[9]=[s("重置筛选",-1)])]),_:1})]),L((m(),b(ne,{data:A.value,border:"",style:{width:"100%"},"max-height":"600"},{default:o(()=>[a(y,{prop:"biz_date",label:"日期",width:"120",fixed:"left"},{default:o(({row:l})=>[s(_(W(l.biz_date)),1)]),_:1}),a(y,{prop:"hotel.name",label:"酒店",width:"150"}),a(y,{prop:"room_type.name",label:"房型",width:"150"}),a(y,{prop:"composite_code",label:"OTA编码",width:"250","show-overflow-tooltip":""},{default:o(({row:l})=>[a(d,{size:"small"},{default:o(()=>[s(_(l.composite_code),1)]),_:2},1024)]),_:1}),a(y,{prop:"sale_price",label:"销售价",width:"120",align:"right"},{default:o(({row:l})=>[s(" ¥"+_(R(l.sale_price)),1)]),_:1}),a(y,{prop:"cost_price",label:"成本价",width:"120",align:"right"},{default:o(({row:l})=>[s(" ¥"+_(R(l.cost_price)),1)]),_:1}),a(y,{prop:"last_updated_at",label:"更新时间",width:"180"},{default:o(({row:l})=>[s(_(Q(l.last_updated_at)),1)]),_:1})]),_:1},8,["data"])),[[U,S.value]]),!S.value&&A.value.length===0?(m(),b(H,{key:0,description:"暂无价格数据，请先预计算价格"})):q("",!0)])):M.value?q("",!0):(m(),b(H,{key:1,description:"产品信息加载失败或不存在"}))]),_:1})),[[U,M.value]])])}}},ke=se(he,[["__scopeId","data-v-83acd0a0"]]);export{ke as default};
