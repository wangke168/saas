import{_ as fe,r as d,i as be,c as A,o as V,b as a,m as G,w as r,d as n,l as ye,q as P,k as h,x as ke,E as b,e as Ve,f as H,s as q,h as s,t as v,v as we}from"./app-Dg43ILXa.js";const De={key:0},Ye={style:{"margin-bottom":"20px"}},xe={__name:"Detail",setup(Pe){const J=ke(),K=Ve(),C=d(!1),_=d(null),E=d("prices"),F=d([]),R=d(!1),y=d([]),i=d({current_page:1,per_page:50,total:0,last_page:1}),D=d(!1),M=d(null),S=d(!1),u=d({dateRange:null,cost_price:0,sale_price:0,stock_available:0}),Q={dateRange:[{required:!0,message:"请选择日期范围",trigger:"change"}],cost_price:[{required:!0,message:"请输入成本价",trigger:"blur"}],sale_price:[{required:!0,message:"请输入销售价",trigger:"blur"},{validator:(t,e,c)=>{e<u.value.cost_price?c(new Error("销售价不能低于成本价")):c()},trigger:"blur"}],stock_available:[{required:!0,message:"请输入可用库存",trigger:"blur"}]},Y=d(!1),U=d(null),$=d(!1),B=d(null),p=d({date:null,cost_price:0,sale_price:0,stock_available:0}),W={cost_price:[{required:!0,message:"请输入成本价",trigger:"blur"}],sale_price:[{required:!0,message:"请输入销售价",trigger:"blur"},{validator:(t,e,c)=>{e<p.value.cost_price?c(new Error("销售价不能低于成本价")):c()},trigger:"blur"}],stock_available:[{required:!0,message:"请输入可用库存",trigger:"blur"}]},X=()=>{K.push("/tickets")},N=t=>t?parseFloat(t).toFixed(2):"0.00",Z=async()=>{C.value=!0;try{const t=await h.get(`/tickets/${J.params.id}`);_.value=t.data.data,_.value&&await m()}catch(t){b.error("获取门票详情失败"),console.error(t)}finally{C.value=!1}},m=async()=>{if(_.value){R.value=!0;try{const t={ticket_id:_.value.id,page:i.value.current_page,per_page:i.value.per_page};y.value&&y.value.length===2&&(t.start_date=y.value[0],t.end_date=y.value[1]);const e=await h.get("/ticket-prices",{params:t});F.value=e.data.data||[],e.data.current_page!==void 0&&(i.value={current_page:e.data.current_page,per_page:e.data.per_page,total:e.data.total,last_page:e.data.last_page})}catch(t){b.error("获取价库列表失败"),console.error(t)}finally{R.value=!1}}},ee=()=>{y.value=[],i.value.current_page=1,m()},ae=t=>{i.value.current_page=t,m()},le=t=>{i.value.per_page=t,i.value.current_page=1,m()},te=()=>{T(),D.value=!0},re=async()=>{M.value&&await M.value.validate(async t=>{var e,c;if(t){S.value=!0;try{const o={ticket_id:_.value.id,start_date:u.value.dateRange[0],end_date:u.value.dateRange[1],cost_price:u.value.cost_price,sale_price:u.value.sale_price,stock_available:u.value.stock_available};await h.post("/ticket-prices/batch",o),b.success("批量设置价库成功"),D.value=!1,i.value.current_page=1,await m()}catch(o){const k=((c=(e=o.response)==null?void 0:e.data)==null?void 0:c.message)||o.message||"操作失败";b.error(k),console.error(o)}finally{S.value=!1}}})},oe=t=>{B.value=t.id,p.value={date:t.date,cost_price:parseFloat(t.cost_price),sale_price:parseFloat(t.sale_price),stock_available:t.stock_available},Y.value=!0},se=async()=>{U.value&&await U.value.validate(async t=>{var e,c;if(t){$.value=!0;try{const o={cost_price:p.value.cost_price,sale_price:p.value.sale_price,stock_available:p.value.stock_available};await h.put(`/ticket-prices/${B.value}`,o),b.success("价库更新成功"),Y.value=!1,await m()}catch(o){const k=((c=(e=o.response)==null?void 0:e.data)==null?void 0:c.message)||o.message||"操作失败";b.error(k),console.error(o)}finally{$.value=!1}}})},ne=async t=>{try{await we.confirm(`确定要删除日期为"${t.date}"的价库记录吗？`,"提示",{type:"warning"}),await h.delete(`/ticket-prices/${t.id}`),b.success("删除成功"),F.value.length===1&&i.value.current_page>1&&i.value.current_page--,await m()}catch(e){e!=="cancel"&&(b.error("删除失败"),console.error(e))}},T=()=>{var t;(t=M.value)==null||t.resetFields(),u.value={dateRange:null,cost_price:0,sale_price:0,stock_available:0}},ie=()=>{var t;(t=U.value)==null||t.resetFields(),B.value=null,p.value={date:null,cost_price:0,sale_price:0,stock_available:0}},ue=t=>{if(!t)return"";const e=new Date(t),c=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),k=String(e.getDate()).padStart(2,"0");return`${c}-${o}-${k}`};return be(()=>{Z()}),(t,e)=>{const c=n("el-page-header"),o=n("el-descriptions-item"),k=n("el-tag"),de=n("el-descriptions"),g=n("el-button"),z=n("el-date-picker"),x=n("el-table-column"),pe=n("el-table"),ce=n("el-pagination"),j=n("el-empty"),f=n("el-form-item"),w=n("el-input-number"),I=n("el-form"),L=n("el-dialog"),_e=n("el-tab-pane"),ve=n("el-tabs"),me=n("el-card"),O=ye("loading");return V(),A("div",null,[a(c,{onBack:X,title:"返回门票列表"},{content:r(()=>[...e[16]||(e[16]=[H("span",null,"门票详情",-1)])]),_:1}),G((V(),P(me,{style:{"margin-top":"20px"}},{default:r(()=>[_.value?(V(),A("div",De,[a(de,{title:"门票基本信息",column:2,border:"",style:{"margin-bottom":"20px"}},{default:r(()=>[a(o,{label:"门票名称"},{default:r(()=>[s(v(_.value.name),1)]),_:1}),a(o,{label:"门票编码"},{default:r(()=>[s(v(_.value.code),1)]),_:1}),a(o,{label:"所属景区"},{default:r(()=>{var l;return[s(v(((l=_.value.scenic_spot)==null?void 0:l.name)||"-"),1)]}),_:1}),a(o,{label:"软件服务商"},{default:r(()=>{var l;return[s(v(((l=_.value.software_provider)==null?void 0:l.name)||"-"),1)]}),_:1}),a(o,{label:"外部门票编号"},{default:r(()=>[s(v(_.value.external_ticket_id||"-"),1)]),_:1}),a(o,{label:"状态"},{default:r(()=>[a(k,{type:_.value.is_active?"success":"danger"},{default:r(()=>[s(v(_.value.is_active?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),a(o,{label:"描述",span:2},{default:r(()=>[s(v(_.value.description||"-"),1)]),_:1})]),_:1}),a(ve,{modelValue:E.value,"onUpdate:modelValue":e[15]||(e[15]=l=>E.value=l),style:{"margin-top":"20px"}},{default:r(()=>[a(_e,{label:"价库管理",name:"prices"},{default:r(()=>[H("div",Ye,[a(g,{type:"primary",onClick:te},{default:r(()=>[...e[17]||(e[17]=[s("批量设置价库",-1)])]),_:1}),a(z,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=l=>y.value=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{"margin-left":"20px"},onChange:m},null,8,["modelValue"]),a(g,{style:{"margin-left":"10px"},onClick:ee},{default:r(()=>[...e[18]||(e[18]=[s("重置筛选",-1)])]),_:1})]),G((V(),P(pe,{data:F.value,border:""},{default:r(()=>[a(x,{prop:"date",label:"日期",width:"120",align:"right"},{default:r(({row:l})=>[s(v(ue(l.date)),1)]),_:1}),a(x,{prop:"cost_price",label:"成本价",width:"120",align:"right"},{default:r(({row:l})=>[s(" ¥"+v(N(l.cost_price)),1)]),_:1}),a(x,{prop:"sale_price",label:"销售价",width:"120",align:"right"},{default:r(({row:l})=>[s(" ¥"+v(N(l.sale_price)),1)]),_:1}),a(x,{prop:"stock_available",label:"可用库存",width:"120",align:"right"}),a(x,{label:"操作",width:"150",fixed:"right"},{default:r(({row:l})=>[a(g,{size:"small",onClick:ge=>oe(l)},{default:r(()=>[...e[19]||(e[19]=[s("编辑",-1)])]),_:1},8,["onClick"]),a(g,{size:"small",type:"danger",onClick:ge=>ne(l)},{default:r(()=>[...e[20]||(e[20]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[O,R.value]]),i.value.total>0?(V(),P(ce,{key:0,"current-page":i.value.current_page,"onUpdate:currentPage":e[1]||(e[1]=l=>i.value.current_page=l),"page-size":i.value.per_page,"onUpdate:pageSize":e[2]||(e[2]=l=>i.value.per_page=l),"page-sizes":[10,20,50,100],total:i.value.total,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px","justify-content":"flex-end"},onSizeChange:le,onCurrentChange:ae},null,8,["current-page","page-size","total"])):q("",!0),!R.value&&F.value.length===0?(V(),P(j,{key:1,description:"暂无价格数据"})):q("",!0),a(L,{modelValue:D.value,"onUpdate:modelValue":e[8]||(e[8]=l=>D.value=l),title:"批量设置价库",width:"600px","append-to-body":"",onClose:T},{footer:r(()=>[a(g,{onClick:e[7]||(e[7]=l=>D.value=!1)},{default:r(()=>[...e[21]||(e[21]=[s("取消",-1)])]),_:1}),a(g,{type:"primary",onClick:re,loading:S.value},{default:r(()=>[...e[22]||(e[22]=[s("确定",-1)])]),_:1},8,["loading"])]),default:r(()=>[a(I,{ref_key:"batchPriceFormRef",ref:M,model:u.value,rules:Q,"label-width":"120px"},{default:r(()=>[a(f,{label:"日期范围",prop:"dateRange"},{default:r(()=>[a(z,{modelValue:u.value.dateRange,"onUpdate:modelValue":e[3]||(e[3]=l=>u.value.dateRange=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(f,{label:"成本价",prop:"cost_price"},{default:r(()=>[a(w,{modelValue:u.value.cost_price,"onUpdate:modelValue":e[4]||(e[4]=l=>u.value.cost_price=l),min:0,precision:2,step:.01,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(f,{label:"销售价",prop:"sale_price"},{default:r(()=>[a(w,{modelValue:u.value.sale_price,"onUpdate:modelValue":e[5]||(e[5]=l=>u.value.sale_price=l),min:0,precision:2,step:.01,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(f,{label:"可用库存",prop:"stock_available"},{default:r(()=>[a(w,{modelValue:u.value.stock_available,"onUpdate:modelValue":e[6]||(e[6]=l=>u.value.stock_available=l),min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(L,{modelValue:Y.value,"onUpdate:modelValue":e[14]||(e[14]=l=>Y.value=l),title:"编辑价库",width:"500px","append-to-body":"",onClose:ie},{footer:r(()=>[a(g,{onClick:e[13]||(e[13]=l=>Y.value=!1)},{default:r(()=>[...e[23]||(e[23]=[s("取消",-1)])]),_:1}),a(g,{type:"primary",onClick:se,loading:$.value},{default:r(()=>[...e[24]||(e[24]=[s("确定",-1)])]),_:1},8,["loading"])]),default:r(()=>[a(I,{ref_key:"priceFormRef",ref:U,model:p.value,rules:W,"label-width":"120px"},{default:r(()=>[a(f,{label:"日期"},{default:r(()=>[a(z,{modelValue:p.value.date,"onUpdate:modelValue":e[9]||(e[9]=l=>p.value.date=l),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},disabled:""},null,8,["modelValue"])]),_:1}),a(f,{label:"成本价",prop:"cost_price"},{default:r(()=>[a(w,{modelValue:p.value.cost_price,"onUpdate:modelValue":e[10]||(e[10]=l=>p.value.cost_price=l),min:0,precision:2,step:.01,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(f,{label:"销售价",prop:"sale_price"},{default:r(()=>[a(w,{modelValue:p.value.sale_price,"onUpdate:modelValue":e[11]||(e[11]=l=>p.value.sale_price=l),min:0,precision:2,step:.01,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(f,{label:"可用库存",prop:"stock_available"},{default:r(()=>[a(w,{modelValue:p.value.stock_available,"onUpdate:modelValue":e[12]||(e[12]=l=>p.value.stock_available=l),min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])])):C.value?q("",!0):(V(),P(j,{key:1,description:"门票信息加载失败或不存在"}))]),_:1})),[[O,C.value]])])}}},Ce=fe(xe,[["__scopeId","data-v-c9e3ea7d"]]);export{Ce as default};
