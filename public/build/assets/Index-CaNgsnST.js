import{_ as de,r as u,x as A,i as pe,c as z,o as p,f as F,b as a,w as o,d as i,k as V,E as c,l as me,m as ve,h as m,y as ce,z as _e,q as x,t as U,s as q,F as G,p as H,v as ge}from"./app-C072kKQ9.js";const fe={style:{"margin-bottom":"20px"}},ye={key:0,style:{color:"#909399"}},be={key:0,style:{"margin-left":"10px",color:"#909399","font-size":"12px"}},Ve={__name:"Index",setup(xe){const P=u([]),T=u([]),I=u(!1),N=u(!1),y=u(!1),E=u(null),S=u(""),$=u(null),B=u(null),w=u(1),R=u(15),M=u(0),h=u(null),L=u(null),_=A(()=>h.value!==null),J=A(()=>_.value?"编辑用户":"创建用户"),r=u({name:"",email:"",password:"",role:"operator",resource_provider_ids:[],is_active:!0}),O={name:[{required:!0,message:"请输入姓名",trigger:"blur"},{max:255,message:"姓名不能超过255个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:8,message:"密码至少8位",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}],resource_provider_ids:[{validator:(t,e,n)=>{r.value.role==="operator"&&(!e||e.length===0)?n(new Error("运营用户必须绑定至少一个资源方")):n()},trigger:"change"}]},g=async()=>{I.value=!0;try{const t={page:w.value,per_page:R.value};$.value&&(t.role=$.value),B.value!==null&&(t.is_active=B.value),S.value&&(t.search=S.value);const e=await V.get("/users",{params:t});P.value=e.data.data||[],M.value=e.data.total||0}catch(t){c.error("获取用户列表失败"),console.error(t)}finally{I.value=!1}},Q=async()=>{try{const t=await V.get("/resource-providers",{params:{per_page:1e3,is_active:!0}});T.value=t.data.data||[]}catch(t){console.error("获取资源方列表失败",t),c.error("获取资源方列表失败")}},W=()=>{w.value=1,g()},j=()=>{w.value=1,g()},X=()=>{h.value=null,K(),y.value=!0},Y=t=>{var e;h.value=t.id,L.value=t.role,r.value={name:t.name,email:t.email,password:"",role:t.role,resource_provider_ids:((e=t.resource_providers)==null?void 0:e.map(n=>n.id))||[],is_active:t.is_active},y.value=!0},Z=async()=>{E.value&&await E.value.validate(async t=>{var e,n,d,v,D,f;if(t){N.value=!0;try{const s={...r.value};_.value&&!s.password&&delete s.password,s.role==="admin"?s.resource_provider_ids=[]:s.resource_provider_ids||(s.resource_provider_ids=[]),console.log("提交用户数据:",s),_.value?(await V.put(`/users/${h.value}`,s),c.success("用户更新成功")):(await V.post("/users",s),c.success("用户创建成功")),y.value=!1,g()}catch(s){const k=((n=(e=s.response)==null?void 0:e.data)==null?void 0:n.message)||((f=(D=(v=(d=s.response)==null?void 0:d.data)==null?void 0:v.errors)==null?void 0:D.email)==null?void 0:f[0])||"操作失败";c.error(k)}finally{N.value=!1}}})},ee=async t=>{var e,n;try{await ge.confirm(`确定要禁用用户"${t.name}"吗？禁用后该用户将无法登录系统。`,"提示",{type:"warning",confirmButtonText:"确定禁用",cancelButtonText:"取消"}),await V.post(`/users/${t.id}/disable`),c.success("用户已禁用"),g()}catch(d){if(d!=="cancel"){const v=((n=(e=d.response)==null?void 0:e.data)==null?void 0:n.message)||"操作失败";c.error(v)}}},le=async t=>{try{await V.post(`/users/${t.id}/enable`),c.success("用户已启用"),g()}catch(e){c.error("操作失败"),console.error(e)}},K=()=>{var t;h.value=null,L.value=null,r.value={name:"",email:"",password:"",role:"operator",resource_provider_ids:[],is_active:!0},(t=E.value)==null||t.clearValidate()},ae=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"";return pe(()=>{g(),Q()}),(t,e)=>{const n=i("el-button"),d=i("el-option"),v=i("el-select"),D=i("el-icon"),f=i("el-input"),s=i("el-table-column"),k=i("el-tag"),te=i("el-table"),oe=i("el-pagination"),re=i("el-card"),b=i("el-form-item"),se=i("el-switch"),ne=i("el-form"),ue=i("el-dialog"),ie=me("loading");return p(),z("div",null,[e[20]||(e[20]=F("h2",null,"用户管理",-1)),a(re,null,{default:o(()=>[F("div",fe,[a(n,{type:"primary",onClick:X},{default:o(()=>[...e[13]||(e[13]=[m("创建用户",-1)])]),_:1}),a(v,{modelValue:$.value,"onUpdate:modelValue":e[0]||(e[0]=l=>$.value=l),placeholder:"筛选角色",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:j},{default:o(()=>[a(d,{label:"超级管理员",value:"admin"}),a(d,{label:"运营",value:"operator"})]),_:1},8,["modelValue"]),a(v,{modelValue:B.value,"onUpdate:modelValue":e[1]||(e[1]=l=>B.value=l),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:j},{default:o(()=>[a(d,{label:"启用",value:!0}),a(d,{label:"禁用",value:!1})]),_:1},8,["modelValue"]),a(f,{modelValue:S.value,"onUpdate:modelValue":e[2]||(e[2]=l=>S.value=l),placeholder:"搜索姓名或邮箱",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:W},{prefix:o(()=>[a(D,null,{default:o(()=>[a(ce(_e))]),_:1})]),_:1},8,["modelValue"])]),ve((p(),x(te,{data:P.value,border:""},{default:o(()=>[a(s,{prop:"name",label:"姓名",width:"150"}),a(s,{prop:"email",label:"邮箱",width:"200"}),a(s,{prop:"role",label:"角色",width:"120"},{default:o(({row:l})=>[a(k,{type:l.role==="admin"?"danger":"primary"},{default:o(()=>[m(U(l.role==="admin"?"超级管理员":"运营"),1)]),_:2},1032,["type"])]),_:1}),a(s,{label:"绑定资源方",width:"200"},{default:o(({row:l})=>[(p(!0),z(G,null,H(l.resource_providers||[],C=>(p(),x(k,{key:C.id,size:"small",style:{"margin-right":"5px","margin-bottom":"5px"}},{default:o(()=>[m(U(C.name),1)]),_:2},1024))),128)),!l.resource_providers||l.resource_providers.length===0?(p(),z("span",ye,U(l.role==="admin"?"全部资源方":"未绑定"),1)):q("",!0)]),_:1}),a(s,{prop:"is_active",label:"状态",width:"100"},{default:o(({row:l})=>[a(k,{type:l.is_active?"success":"danger"},{default:o(()=>[m(U(l.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(s,{prop:"created_at",label:"创建时间",width:"180"},{default:o(({row:l})=>[m(U(ae(l.created_at)),1)]),_:1}),a(s,{label:"操作",width:"250",fixed:"right"},{default:o(({row:l})=>[a(n,{size:"small",onClick:C=>Y(l)},{default:o(()=>[...e[14]||(e[14]=[m("编辑",-1)])]),_:1},8,["onClick"]),l.is_active&&l.role!=="admin"?(p(),x(n,{key:0,size:"small",type:"warning",onClick:C=>ee(l)},{default:o(()=>[...e[15]||(e[15]=[m(" 禁用 ",-1)])]),_:1},8,["onClick"])):l.is_active?q("",!0):(p(),x(n,{key:1,size:"small",type:"success",onClick:C=>le(l)},{default:o(()=>[...e[16]||(e[16]=[m(" 启用 ",-1)])]),_:1},8,["onClick"]))]),_:1})]),_:1},8,["data"])),[[ie,I.value]]),a(oe,{"current-page":w.value,"onUpdate:currentPage":e[3]||(e[3]=l=>w.value=l),"page-size":R.value,"onUpdate:pageSize":e[4]||(e[4]=l=>R.value=l),"page-sizes":[10,20,50,100],total:M.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:g,onCurrentChange:g},null,8,["current-page","page-size","total"])]),_:1}),a(ue,{modelValue:y.value,"onUpdate:modelValue":e[12]||(e[12]=l=>y.value=l),title:J.value,width:"600px",onClose:K},{footer:o(()=>[a(n,{onClick:e[11]||(e[11]=l=>y.value=!1)},{default:o(()=>[...e[18]||(e[18]=[m("取消",-1)])]),_:1}),a(n,{type:"primary",onClick:Z,loading:N.value},{default:o(()=>[...e[19]||(e[19]=[m("确定",-1)])]),_:1},8,["loading"])]),default:o(()=>[a(ne,{ref_key:"formRef",ref:E,model:r.value,rules:O,"label-width":"120px"},{default:o(()=>[a(b,{label:"姓名",prop:"name"},{default:o(()=>[a(f,{modelValue:r.value.name,"onUpdate:modelValue":e[5]||(e[5]=l=>r.value.name=l),placeholder:"请输入姓名"},null,8,["modelValue"])]),_:1}),a(b,{label:"邮箱",prop:"email"},{default:o(()=>[a(f,{modelValue:r.value.email,"onUpdate:modelValue":e[6]||(e[6]=l=>r.value.email=l),placeholder:"请输入邮箱",disabled:_.value},null,8,["modelValue","disabled"])]),_:1}),a(b,{label:"密码",prop:_.value?"":"password"},{default:o(()=>[a(f,{modelValue:r.value.password,"onUpdate:modelValue":e[7]||(e[7]=l=>r.value.password=l),type:"password",placeholder:_.value?"留空则不修改密码":"请输入密码（至少8位）","show-password":""},null,8,["modelValue","placeholder"])]),_:1},8,["prop"]),a(b,{label:"角色",prop:"role"},{default:o(()=>[a(v,{modelValue:r.value.role,"onUpdate:modelValue":e[8]||(e[8]=l=>r.value.role=l),placeholder:"请选择角色",style:{width:"100%"},disabled:_.value&&r.value.role==="admin"},{default:o(()=>[a(d,{label:"超级管理员",value:"admin"}),a(d,{label:"运营",value:"operator"})]),_:1},8,["modelValue","disabled"]),_.value&&r.value.role==="admin"?(p(),z("span",be," 不能修改超级管理员角色 ")):q("",!0)]),_:1}),r.value.role==="operator"?(p(),x(b,{key:0,label:"绑定资源方",prop:"resource_provider_ids"},{default:o(()=>[a(v,{modelValue:r.value.resource_provider_ids,"onUpdate:modelValue":e[9]||(e[9]=l=>r.value.resource_provider_ids=l),placeholder:"请选择绑定的资源方（可多选）",multiple:"",style:{width:"100%"}},{default:o(()=>[(p(!0),z(G,null,H(T.value,l=>(p(),x(d,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[17]||(e[17]=F("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 运营用户必须绑定至少一个资源方 ",-1))]),_:1})):q("",!0),a(b,{label:"状态",prop:"is_active"},{default:o(()=>[a(se,{modelValue:r.value.is_active,"onUpdate:modelValue":e[10]||(e[10]=l=>r.value.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},he=de(Ve,[["__scopeId","data-v-c2d86596"]]);export{he as default};
