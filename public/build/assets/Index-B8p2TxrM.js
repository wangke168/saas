import{_ as ge,r as y,i as ve,j as fe,c as b,o as u,f as n,b as d,w as g,d as x,k as $,E as _,e as ye,l as he,m as ke,n as A,F as M,p as K,q as C,h as f,t as m,s as T,v as V}from"./app-JTASQpWe.js";const be={class:"order-management-container"},xe={class:"filter-bar"},$e={class:"order-list"},Ce={class:"order-header"},Se={class:"header-item"},De={class:"value"},Te={class:"header-item"},Ve={class:"value"},Ye={class:"header-item"},we={class:"value"},Me={class:"header-item"},je={class:"value"},ze={class:"order-body"},Be={class:"body-col col-checkbox"},Ue={class:"body-col col-product"},Fe={class:"product-name"},Oe={class:"body-col col-hotel"},qe={class:"hotel-name"},Ne={class:"hotel-details"},Pe={key:0,class:"room-type"},Ee={class:"date-range"},Le={class:"body-col col-guest"},Re={class:"guest-name"},Ae={class:"guest-phone"},Ke={class:"body-col col-amount"},He={class:"amount-item"},We={class:"amount-value"},Ie={class:"amount-item"},Ge={class:"amount-value"},Je={class:"amount-item"},Qe={class:"amount-value estimated"},Xe={class:"body-col col-status"},Ze={class:"body-col col-actions"},et={__name:"Index",setup(tt){ye();const j=y([]),P=y(!1),z=y(1),E=y(15),H=y(0),p=y({}),Y=y([]),W=y([]),I=y([]),B=y("total, sizes, prev, pager, next, jumper"),L=()=>{window.innerWidth<=768?B.value="prev, pager, next":window.innerWidth<=1200?B.value="total, prev, pager, next":B.value="total, sizes, prev, pager, next, jumper"},s=y({status:null,order_no:"",ota_order_no:"",contact_name:"",ota_platform_id:null,scenic_spot_id:null,check_in_date_range:null,created_at_range:null}),k=async()=>{P.value=!0;try{const t={page:z.value,per_page:E.value};s.value.status&&(t.status=s.value.status),s.value.order_no&&(t.order_no=s.value.order_no),s.value.ota_order_no&&(t.ota_order_no=s.value.ota_order_no),s.value.contact_name&&(t.contact_name=s.value.contact_name),s.value.ota_platform_id&&(t.ota_platform_id=s.value.ota_platform_id),s.value.scenic_spot_id&&(t.scenic_spot_id=s.value.scenic_spot_id),s.value.check_in_date_range&&s.value.check_in_date_range.length===2&&(t.check_in_date_start=s.value.check_in_date_range[0],t.check_in_date_end=s.value.check_in_date_range[1]),s.value.created_at_range&&s.value.created_at_range.length===2&&(t.created_at_start=s.value.created_at_range[0],t.created_at_end=s.value.created_at_range[1]);const e=await $.get("/orders",{params:t});if(j.value=e.data.data,H.value=e.data.total,j.value.length>0){const l=j.value[0];console.log("订单日期数据示例:",{check_in_date:l.check_in_date,check_out_date:l.check_out_date,check_in_date_type:typeof l.check_in_date,check_out_date_type:typeof l.check_out_date})}}catch{_.error("获取订单列表失败")}finally{P.value=!1}},v=()=>{z.value=1,k()},te=()=>{s.value={status:null,order_no:"",ota_order_no:"",contact_name:"",ota_platform_id:null,scenic_spot_id:null,check_in_date_range:null,created_at_range:null},v()},U=t=>t?parseFloat(t).toFixed(2):"0.00",ae=t=>{if(!t)return"";const e=new Date(t),l=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${l}-${o}-${c} ${i}:${r}`},ne=(t,e,l)=>{try{if(!t&&!e)return"";const o=r=>{if(!r)return null;if(typeof r=="string"){const h=r.match(/^(\d{4}-\d{2}-\d{2})/);return h?h[1]:r.split(" ")[0].split("T")[0]}if(r instanceof Date){const h=r.getFullYear(),S=String(r.getMonth()+1).padStart(2,"0"),w=String(r.getDate()).padStart(2,"0");return`${h}-${S}-${w}`}return String(r)},c=o(t),i=o(e);if(!c&&i)return`离店：${i.replace(/-/g,"/")}`;if(c&&!i)return`入住：${c.replace(/-/g,"/")}`;if(c&&i){const r=new Date(c+"T00:00:00"),h=new Date(i+"T00:00:00");if(isNaN(r.getTime())||isNaN(h.getTime()))return`${c.replace(/-/g,"/")}~${i.replace(/-/g,"/")}`;const S=Math.ceil((h-r)/(1e3*60*60*24)),w=S>0?`${S}晚`:"1晚",F=R=>{const a=new Date(R),O=a.getFullYear(),q=String(a.getMonth()+1).padStart(2,"0"),N=String(a.getDate()).padStart(2,"0");return`${O}/${q}/${N}`};return`${F(r)}~${F(h)} ${w} ${l||1}间`}return""}catch(o){return console.error("格式化日期范围错误:",o,{checkIn:t,checkOut:e,roomCount:l}),""}},se=(t,e)=>{e?Y.value.includes(t)||Y.value.push(t):Y.value=Y.value.filter(l=>l!==t)},le=t=>!t.total_amount||!t.settlement_amount?0:parseFloat(t.total_amount)-parseFloat(t.settlement_amount),G=t=>({paid_pending:"已支付/待确认",confirming:"确认中",confirmed:"预订成功",rejected:"预订失败/拒单",cancel_requested:"申请取消中",cancel_rejected:"取消拒绝",cancel_approved:"取消通过",verified:"核销订单"})[t]||t,oe=t=>({paid_pending:"warning",confirming:"info",confirmed:"success",rejected:"danger",cancel_requested:"warning",cancel_rejected:"info",cancel_approved:"info",verified:"success"})[t]||"",ce=t=>{V.alert(`
        <div style="text-align: left;">
            <p><strong>订单号：</strong>${t.order_no}</p>
            <p><strong>OTA订单号：</strong>${t.ota_order_no||"-"}</p>
            <p><strong>状态：</strong>${G(t.status)}</p>
            <p><strong>入住日期：</strong>${t.check_in_date}</p>
            <p><strong>离店日期：</strong>${t.check_out_date}</p>
            <p><strong>房间数：</strong>${t.room_count}</p>
            <p><strong>订单金额：</strong>¥${U(t.total_amount)}</p>
            <p><strong>联系人：</strong>${t.contact_name}</p>
            <p><strong>联系电话：</strong>${t.contact_phone}</p>
        </div>
        `,"订单详情",{dangerouslyUseHTMLString:!0})},re=async t=>{var e,l,o,c;try{await V.confirm((l=(e=t.hotel)==null?void 0:e.scenic_spot)!=null&&l.is_system_connected?"确定要接单吗？系统将自动调用资源方接口确认订单。":"确定要接单吗？","接单确认",{type:"info",confirmButtonText:"确定",cancelButtonText:"取消"}),p.value[t.id]="confirm";const i=await $.post(`/orders/${t.id}/confirm`,{remark:""});i.data.success?(_.success(i.data.message||"接单成功"),k()):_.error(i.data.message||"接单失败")}catch(i){if(i!=="cancel"){const r=((c=(o=i.response)==null?void 0:o.data)==null?void 0:c.message)||"接单失败";_.error(r)}}finally{p.value[t.id]=null}},ie=async t=>{var e,l;try{const{value:o}=await V.prompt("请输入拒单原因","拒单",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"请输入拒单原因",inputValidator:i=>!i||i.trim().length===0?"拒单原因不能为空":!0});p.value[t.id]="reject";const c=await $.post(`/orders/${t.id}/reject`,{reason:o.trim()});c.data.success?(_.success(c.data.message||"拒单成功"),k()):_.error(c.data.message||"拒单失败")}catch(o){if(o!=="cancel"){const c=((l=(e=o.response)==null?void 0:e.data)==null?void 0:l.message)||"拒单失败";_.error(c)}}finally{p.value[t.id]=null}},de=async t=>{var e,l,o,c;try{const i={use_start_date:t.check_in_date,use_end_date:t.check_out_date,use_quantity:t.room_count,passengers:[],vouchers:[]};await V.confirm((l=(e=t.hotel)==null?void 0:e.scenic_spot)!=null&&l.is_system_connected?"确定要核销订单吗？系统将自动调用资源方接口核销订单。":"确定要核销订单吗？","核销确认",{type:"info",confirmButtonText:"确定",cancelButtonText:"取消"}),p.value[t.id]="verify";const r=await $.post(`/orders/${t.id}/verify`,i);r.data.success?(_.success(r.data.message||"核销成功"),k()):_.error(r.data.message||"核销失败")}catch(i){if(i!=="cancel"){const r=((c=(o=i.response)==null?void 0:o.data)==null?void 0:c.message)||"核销失败";_.error(r)}}finally{p.value[t.id]=null}},ue=async t=>{var e,l;try{await V.confirm("确定要同意取消订单吗？同意后将释放库存并通知OTA平台。","同意取消确认",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"}),p.value[t.id]="approveCancel";const o=await $.post(`/orders/${t.id}/approve-cancel`,{reason:"人工同意取消"});o.data.success?(_.success(o.data.message||"同意取消成功"),k()):_.error(o.data.message||"同意取消失败")}catch(o){if(o!=="cancel"){const c=((l=(e=o.response)==null?void 0:e.data)==null?void 0:l.message)||"同意取消失败";_.error(c)}}finally{p.value[t.id]=null}},_e=async t=>{var e,l;try{const{value:o}=await V.prompt("请输入拒绝取消的原因","拒绝取消",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"请输入拒绝取消的原因",inputValidator:i=>!i||i.trim().length===0?"拒绝取消的原因不能为空":!0});p.value[t.id]="rejectCancel";const c=await $.post(`/orders/${t.id}/reject-cancel`,{reason:o.trim()});c.data.success?(_.success(c.data.message||"拒绝取消成功"),k()):_.error(c.data.message||"拒绝取消失败")}catch(o){if(o!=="cancel"){const c=((l=(e=o.response)==null?void 0:e.data)==null?void 0:l.message)||"拒绝取消失败";_.error(c)}}finally{p.value[t.id]=null}},pe=async()=>{try{const t=await $.get("/ota-platforms",{params:{active_only:!0}});W.value=t.data.data||[]}catch(t){console.error("获取渠道列表失败",t)}},me=async()=>{try{const t=await $.get("/scenic-spots",{params:{per_page:1e3}});I.value=t.data.data||[]}catch(t){console.error("获取景区列表失败",t)}};return ve(()=>{k(),pe(),me(),L(),window.addEventListener("resize",L)}),fe(()=>{window.removeEventListener("resize",L)}),(t,e)=>{const l=x("el-option"),o=x("el-select"),c=x("el-input"),i=x("el-date-picker"),r=x("el-button"),h=x("el-checkbox"),S=x("el-tag"),w=x("el-pagination"),F=x("el-card"),R=he("loading");return u(),b("div",be,[e[25]||(e[25]=n("h2",null,"订单管理",-1)),d(F,null,{default:g(()=>[n("div",xe,[d(o,{modelValue:s.value.status,"onUpdate:modelValue":e[0]||(e[0]=a=>s.value.status=a),placeholder:"订单状态",clearable:"",style:{width:"150px"},onChange:v},{default:g(()=>[d(l,{label:"已支付/待确认",value:"paid_pending"}),d(l,{label:"确认中",value:"confirming"}),d(l,{label:"预订成功",value:"confirmed"}),d(l,{label:"预订失败/拒单",value:"rejected"}),d(l,{label:"申请取消中",value:"cancel_requested"}),d(l,{label:"取消拒绝",value:"cancel_rejected"}),d(l,{label:"取消通过",value:"cancel_approved"}),d(l,{label:"核销订单",value:"verified"})]),_:1},8,["modelValue"]),d(c,{modelValue:s.value.order_no,"onUpdate:modelValue":e[1]||(e[1]=a=>s.value.order_no=a),placeholder:"订单号",clearable:"",style:{width:"200px"},onClear:v,onKeyup:A(v,["enter"])},null,8,["modelValue"]),d(c,{modelValue:s.value.ota_order_no,"onUpdate:modelValue":e[2]||(e[2]=a=>s.value.ota_order_no=a),placeholder:"OTA订单号",clearable:"",style:{width:"200px"},onClear:v,onKeyup:A(v,["enter"])},null,8,["modelValue"]),d(c,{modelValue:s.value.contact_name,"onUpdate:modelValue":e[3]||(e[3]=a=>s.value.contact_name=a),placeholder:"客人姓名",clearable:"",style:{width:"150px"},onClear:v,onKeyup:A(v,["enter"])},null,8,["modelValue"]),d(o,{modelValue:s.value.ota_platform_id,"onUpdate:modelValue":e[4]||(e[4]=a=>s.value.ota_platform_id=a),placeholder:"渠道",clearable:"",style:{width:"150px"},onChange:v},{default:g(()=>[(u(!0),b(M,null,K(W.value,a=>(u(),C(l,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),d(o,{modelValue:s.value.scenic_spot_id,"onUpdate:modelValue":e[5]||(e[5]=a=>s.value.scenic_spot_id=a),placeholder:"景区",clearable:"",style:{width:"150px"},onChange:v},{default:g(()=>[(u(!0),b(M,null,K(I.value,a=>(u(),C(l,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),d(i,{modelValue:s.value.check_in_date_range,"onUpdate:modelValue":e[6]||(e[6]=a=>s.value.check_in_date_range=a),type:"daterange","range-separator":"至","start-placeholder":"入住日期开始","end-placeholder":"入住日期结束",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"},onChange:v},null,8,["modelValue"]),d(i,{modelValue:s.value.created_at_range,"onUpdate:modelValue":e[7]||(e[7]=a=>s.value.created_at_range=a),type:"daterange","range-separator":"至","start-placeholder":"预定日期开始","end-placeholder":"预定日期结束",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"},onChange:v},null,8,["modelValue"]),d(r,{onClick:v},{default:g(()=>[...e[10]||(e[10]=[f("筛选",-1)])]),_:1}),d(r,{onClick:te},{default:g(()=>[...e[11]||(e[11]=[f("重置",-1)])]),_:1})]),ke((u(),b("div",$e,[(u(!0),b(M,null,K(j.value,a=>{var O,q,N,J,Q,X,Z,ee;return u(),b("div",{key:a.id,class:"order-item"},[n("div",Ce,[n("span",Se,[e[12]||(e[12]=n("span",{class:"label"},"系统订单号：",-1)),n("span",De,m(a.order_no),1)]),n("span",Te,[e[13]||(e[13]=n("span",{class:"label"},"渠道订单号：",-1)),n("span",Ve,m(a.ota_order_no||"-"),1)]),n("span",Ye,[e[14]||(e[14]=n("span",{class:"label"},"下单时间：",-1)),n("span",we,m(ae(a.created_at)),1)]),n("span",Me,[e[15]||(e[15]=n("span",{class:"label"},"来源：",-1)),n("span",je,m(((O=a.ota_platform)==null?void 0:O.name)||"-"),1)])]),n("div",ze,[n("div",Be,[d(h,{"model-value":Y.value.includes(a.id),"onUpdate:modelValue":D=>se(a.id,D)},null,8,["model-value","onUpdate:modelValue"])]),n("div",Ue,[n("div",Fe,m(((q=a.product)==null?void 0:q.name)||"-"),1),(J=(N=a.product)==null?void 0:N.scenic_spot)!=null&&J.name?(u(),C(S,{key:0,size:"small",type:"info",class:"scenic-tag"},{default:g(()=>[f(m(a.product.scenic_spot.name),1)]),_:2},1024)):T("",!0)]),n("div",Oe,[n("div",qe,m(((Q=a.hotel)==null?void 0:Q.name)||"-"),1),n("div",Ne,[(X=a.room_type)!=null&&X.name?(u(),b("div",Pe,m(a.room_type.name),1)):T("",!0),n("div",Ee,[a.check_in_date||a.check_out_date?(u(),b(M,{key:0},[f(m(ne(a.check_in_date,a.check_out_date,a.room_count)),1)],64)):(u(),b(M,{key:1},[f("-")],64))])])]),n("div",Le,[n("div",Re,m(a.contact_name||"-"),1),n("div",Ae,m(a.contact_phone||"-"),1)]),n("div",Ke,[n("div",He,[e[16]||(e[16]=n("span",{class:"amount-label"},"销售金额：",-1)),n("span",We,"¥"+m(U(a.total_amount)),1)]),n("div",Ie,[e[17]||(e[17]=n("span",{class:"amount-label"},"结算金额：",-1)),n("span",Ge,"¥"+m(U(a.settlement_amount)),1)]),n("div",Je,[e[18]||(e[18]=n("span",{class:"amount-label"},"预估收入：",-1)),n("span",Qe,"¥"+m(U(le(a))),1)])]),n("div",Xe,[d(S,{type:oe(a.status),size:"small",class:"status-tag"},{default:g(()=>[f(m(G(a.status)),1)]),_:2},1032,["type"])]),n("div",Ze,[d(r,{size:"small",text:"",type:"primary",onClick:D=>ce(a),class:"action-btn-text"},{default:g(()=>[...e[19]||(e[19]=[f(" 详情 ",-1)])]),_:1},8,["onClick"]),["paid_pending","confirming"].includes(a.status)?(u(),C(r,{key:0,size:"small",type:"success",onClick:D=>re(a),loading:p.value[a.id]==="confirm",class:"action-btn-primary"},{default:g(()=>[...e[20]||(e[20]=[f(" 接单 ",-1)])]),_:1},8,["onClick","loading"])):T("",!0),["paid_pending","confirming"].includes(a.status)?(u(),C(r,{key:1,size:"small",type:"danger",onClick:D=>ie(a),loading:p.value[a.id]==="reject",class:"action-btn-primary"},{default:g(()=>[...e[21]||(e[21]=[f(" 拒单 ",-1)])]),_:1},8,["onClick","loading"])):T("",!0),a.status==="confirmed"?(u(),C(r,{key:2,size:"small",type:"primary",onClick:D=>de(a),loading:p.value[a.id]==="verify",class:"action-btn-primary"},{default:g(()=>[...e[22]||(e[22]=[f(" 核销 ",-1)])]),_:1},8,["onClick","loading"])):T("",!0),a.status==="cancel_requested"||((Z=a.status)==null?void 0:Z.value)==="cancel_requested"?(u(),C(r,{key:3,size:"small",type:"success",onClick:D=>ue(a),loading:p.value[a.id]==="approveCancel",class:"action-btn-primary"},{default:g(()=>[...e[23]||(e[23]=[f(" 同意取消 ",-1)])]),_:1},8,["onClick","loading"])):T("",!0),a.status==="cancel_requested"||((ee=a.status)==null?void 0:ee.value)==="cancel_requested"?(u(),C(r,{key:4,size:"small",type:"danger",onClick:D=>_e(a),loading:p.value[a.id]==="rejectCancel",class:"action-btn-primary"},{default:g(()=>[...e[24]||(e[24]=[f(" 拒绝取消 ",-1)])]),_:1},8,["onClick","loading"])):T("",!0)])])])}),128))])),[[R,P.value]]),d(w,{"current-page":z.value,"onUpdate:currentPage":e[8]||(e[8]=a=>z.value=a),"page-size":E.value,"onUpdate:pageSize":e[9]||(e[9]=a=>E.value=a),total:H.value,onCurrentChange:k,onSizeChange:k,class:"pagination-container",layout:B.value},null,8,["current-page","page-size","total","layout"])]),_:1})])}}},nt=ge(et,[["__scopeId","data-v-35337d7f"]]);export{nt as default};
