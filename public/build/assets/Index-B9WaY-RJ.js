import{_ as be,u as xe,r as p,A as W,i as Ve,c as w,o as c,f as b,b as a,w as s,d as _,k,E as f,e as we,l as he,m as ke,h as y,F as N,p as R,q as C,y as X,B as Ce,t as I,C as De,s as Z,v as Ue}from"./app-DOnxzBSC.js";const ze={style:{"margin-bottom":"20px"}},Se={key:0,style:{"font-size":"12px",color:"#909399","margin-top":"5px"}},$e={key:1,style:{"font-size":"12px",color:"#f56c6c","margin-top":"5px"}},Ye={key:2,style:{"font-size":"12px",color:"#909399","margin-top":"5px"}},Ee={__name:"Index",setup(Me){const g=xe(),ee=we(),Y=p([]),x=p([]),V=p([]),L=p(!1),F=p(!1),O=p({}),D=p(!1),z=p(null),E=p(""),M=p(null),T=p(null),S=p(1),P=p(15),j=p(0),$=p(null),q=W(()=>$.value!==null),le=W(()=>q.value?"编辑产品":"创建产品"),o=p({scenic_spot_id:null,software_provider_id:null,name:"",code:"",description:"",price_source:"manual",stay_days:1,sale_start_date:null,sale_end_date:null,order_mode:null,order_provider_id:null,is_active:!0}),ae={scenic_spot_id:[{required:!0,message:"请选择所属景区",trigger:"change"}],software_provider_id:[{required:!0,message:"请选择软件服务商",trigger:"change"}],name:[{required:!0,message:"请输入产品名称",trigger:"blur"},{max:255,message:"产品名称不能超过255个字符",trigger:"blur"}],external_code:[{max:255,message:"外部产品编码不能超过255个字符",trigger:"blur"}],price_source:[{required:!0,message:"请选择价格来源",trigger:"change"}],stay_days:[{required:!0,message:"请输入入住天数",trigger:"blur"},{type:"number",min:1,max:30,message:"入住天数必须在1-30之间",trigger:"blur"}],sale_start_date:[{required:!0,message:"请选择销售开始日期",trigger:"change"}],sale_end_date:[{validator:(t,e,r)=>{e?o.value.sale_start_date&&e<o.value.sale_start_date?r(new Error("销售结束日期不能早于开始日期")):r():r(new Error("请选择销售结束日期"))},trigger:"change"}]},h=async()=>{L.value=!0;try{const t={page:S.value,per_page:P.value};M.value&&(t.scenic_spot_id=M.value),T.value!==null&&(t.is_active=T.value),E.value&&(t.search=E.value);const e=await k.get("/products",{params:t});e.data&&e.data.data?(Y.value=e.data.data||[],j.value=e.data.total||0):(Y.value=e.data||[],j.value=Y.value.length)}catch(t){f.error("获取产品列表失败"),console.error(t)}finally{L.value=!1}},J=async()=>{var t,e,r,n;try{if(((t=g.user)==null?void 0:t.role)!=="admin")(!g.user||!g.user.scenic_spots||g.user.scenic_spots.length===0)&&await g.fetchUser(),x.value=((e=g.user)==null?void 0:e.scenic_spots)||[],x.value.length===0&&console.warn("运营用户未绑定任何景区");else{const u=await k.get("/scenic-spots");x.value=u.data.data||[]}}catch(u){if(console.error("获取景区列表失败",u),(r=g.user)!=null&&r.scenic_spots&&g.user.scenic_spots.length>0)x.value=g.user.scenic_spots;else try{await g.fetchUser(),x.value=((n=g.user)==null?void 0:n.scenic_spots)||[]}catch(m){console.error("获取用户信息失败",m)}}},te=()=>{S.value=1,h()},K=()=>{S.value=1,h()},oe=async()=>{var t;if($.value=null,A(),x.value.length===0&&await J(),((t=g.user)==null?void 0:t.role)!=="admin"&&x.value.length===0){f.warning("您未绑定任何景区，请联系管理员为您分配景区");return}D.value=!0},se=t=>{ee.push(`/products/${t.id}/detail`)},G=async(t,e=!1)=>{const r=e?o.value.software_provider_id:null;if(o.value.software_provider_id=null,V.value=[],t)try{const u=(await k.get(`/scenic-spots/${t}`)).data.data;V.value=u.software_providers||[],e&&r&&(V.value.some(i=>i.id===r)?o.value.software_provider_id=r:(o.value.software_provider_id=null,f.warning("该产品配置的服务商不属于当前景区的服务商列表，请重新选择"))),V.value.length===0&&f.warning("该景区尚未配置服务商，请先在景区管理页面添加服务商")}catch(n){f.error("获取景区服务商列表失败"),console.error(n)}},H=t=>t?typeof t=="string"&&t.includes("T")?t.split("T")[0]:(typeof t=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(t),t):null,re=async t=>{$.value=t.id,o.value={scenic_spot_id:t.scenic_spot_id,software_provider_id:t.software_provider_id||null,name:t.name,code:t.code,external_code:t.external_code||"",description:t.description||"",price_source:t.price_source||"manual",stay_days:t.stay_days||1,sale_start_date:H(t.sale_start_date),sale_end_date:H(t.sale_end_date),order_mode:t.order_mode||null,order_provider_id:t.order_provider_id||null,is_active:t.is_active},t.scenic_spot_id&&await G(t.scenic_spot_id,!0),D.value=!0},ne=async()=>{z.value&&z.value.validate(async t=>{var e,r,n,u,m,i;if(t){F.value=!0;try{const d={...o.value,stay_days:o.value.stay_days||1,sale_start_date:o.value.sale_start_date||null,sale_end_date:o.value.sale_end_date||null};delete d.code,d.external_code===""&&(d.external_code=null),d.order_mode===""&&(d.order_mode=null),d.order_provider_id===""&&(d.order_provider_id=null),d.order_mode!=="other"&&(d.order_provider_id=null),q.value?(await k.put(`/products/${$.value}`,d),f.success("产品更新成功")):(await k.post("/products",d),f.success("产品创建成功")),D.value=!1,A(),setTimeout(()=>{h()},100)}catch(d){const B=((r=(e=d.response)==null?void 0:e.data)==null?void 0:r.message)||((i=(m=(u=(n=d.response)==null?void 0:n.data)==null?void 0:u.errors)==null?void 0:m.code)==null?void 0:i[0])||"操作失败";f.error(B)}finally{F.value=!1}}})},de=async t=>{var e,r;try{await Ue.confirm(`确定要删除产品"${t.name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await k.delete(`/products/${t.id}`),f.success("删除成功"),h()}catch(n){if(n!=="cancel"){const u=((r=(e=n.response)==null?void 0:e.data)==null?void 0:r.message)||"删除失败";f.error(u)}}},A=()=>{$.value=null,o.value={scenic_spot_id:null,software_provider_id:null,name:"",code:"",external_code:"",description:"",price_source:"manual",stay_days:1,sale_start_date:null,sale_end_date:null,order_mode:null,order_provider_id:null,is_active:!0},V.value=[],z.value&&z.value.clearValidate()},ue=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",ie=async t=>{O.value[t.id]=!0;try{const e=await k.get(`/products/${t.id}/export`,{responseType:"blob",validateStatus:m=>m<500});if((e.headers["content-type"]||"").includes("application/json")||e.status>=400){const m=await e.data.text();let i="导出失败";try{i=JSON.parse(m).message||i}catch{i=m||i}f.error(i),console.error("导出失败",i);return}const n=window.URL.createObjectURL(new Blob([e.data])),u=document.createElement("a");u.href=n,u.setAttribute("download",`product_${t.code}_${new Date().toISOString().slice(0,10)}.csv`),document.body.appendChild(u),u.click(),u.remove(),window.URL.revokeObjectURL(n),f.success("导出成功")}catch(e){let r="导出失败";if(e.response){if(e.response.data)if(typeof e.response.data=="string")try{r=JSON.parse(e.response.data).message||r}catch{r=e.response.data||r}else e.response.data.message&&(r=e.response.data.message)}else e.message&&(r=e.message);f.error(r),console.error("导出失败",e)}finally{O.value[t.id]=!1}};return Ve(()=>{h(),J()}),(t,e)=>{const r=_("el-button"),n=_("el-option"),u=_("el-select"),m=_("el-icon"),i=_("el-input"),d=_("el-table-column"),B=_("el-tag"),pe=_("el-table"),_e=_("el-pagination"),ce=_("el-card"),v=_("el-form-item"),me=_("el-input-number"),Q=_("el-date-picker"),ve=_("el-switch"),fe=_("el-form"),ge=_("el-dialog"),ye=he("loading");return c(),w("div",null,[e[35]||(e[35]=b("h2",null,"产品管理",-1)),a(ce,null,{default:s(()=>[b("div",ze,[a(r,{type:"primary",onClick:oe},{default:s(()=>[...e[20]||(e[20]=[y("创建产品",-1)])]),_:1}),a(u,{modelValue:M.value,"onUpdate:modelValue":e[0]||(e[0]=l=>M.value=l),placeholder:"筛选景区",clearable:"",style:{width:"200px","margin-left":"10px"},onChange:K},{default:s(()=>[(c(!0),w(N,null,R(x.value,l=>(c(),C(n,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(u,{modelValue:T.value,"onUpdate:modelValue":e[1]||(e[1]=l=>T.value=l),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:K},{default:s(()=>[a(n,{label:"启用",value:!0}),a(n,{label:"禁用",value:!1})]),_:1},8,["modelValue"]),a(i,{modelValue:E.value,"onUpdate:modelValue":e[2]||(e[2]=l=>E.value=l),placeholder:"搜索产品名称或编码",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:te},{prefix:s(()=>[a(m,null,{default:s(()=>[a(X(Ce))]),_:1})]),_:1},8,["modelValue"])]),ke((c(),C(pe,{data:Y.value,border:""},{default:s(()=>[a(d,{prop:"name",label:"产品名称",width:"200"}),a(d,{prop:"code",label:"产品编码",width:"150"}),a(d,{prop:"external_code",label:"外部产品编码",width:"150"}),a(d,{label:"所属景区",width:"150"},{default:s(({row:l})=>{var U;return[y(I(((U=l.scenic_spot)==null?void 0:U.name)||"-"),1)]}),_:1}),a(d,{prop:"description",label:"描述","show-overflow-tooltip":""}),a(d,{prop:"price_source",label:"价格来源",width:"120"},{default:s(({row:l})=>[a(B,{type:l.price_source==="manual"?"primary":"success"},{default:s(()=>[y(I(l.price_source==="manual"?"人工维护":"接口推送"),1)]),_:2},1032,["type"])]),_:1}),a(d,{prop:"is_active",label:"状态",width:"100"},{default:s(({row:l})=>[a(B,{type:l.is_active?"success":"danger"},{default:s(()=>[y(I(l.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(d,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:l})=>[y(I(ue(l.created_at)),1)]),_:1}),a(d,{label:"操作",width:"350",fixed:"right"},{default:s(({row:l})=>[a(r,{size:"small",onClick:U=>se(l)},{default:s(()=>[...e[21]||(e[21]=[y("详情",-1)])]),_:1},8,["onClick"]),a(r,{size:"small",onClick:U=>re(l)},{default:s(()=>[...e[22]||(e[22]=[y("编辑",-1)])]),_:1},8,["onClick"]),a(r,{size:"small",type:"success",onClick:U=>ie(l),loading:O.value[l.id]},{default:s(()=>[a(m,null,{default:s(()=>[a(X(De))]),_:1}),e[23]||(e[23]=y(" 导出 ",-1))]),_:1},8,["onClick","loading"]),a(r,{size:"small",type:"danger",onClick:U=>de(l)},{default:s(()=>[...e[24]||(e[24]=[y("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ye,L.value]]),a(_e,{"current-page":S.value,"onUpdate:currentPage":e[3]||(e[3]=l=>S.value=l),"page-size":P.value,"onUpdate:pageSize":e[4]||(e[4]=l=>P.value=l),"page-sizes":[10,20,50,100],total:j.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:h,onCurrentChange:h},null,8,["current-page","page-size","total"])]),_:1}),a(ge,{modelValue:D.value,"onUpdate:modelValue":e[19]||(e[19]=l=>D.value=l),title:le.value,width:"600px",onClose:A},{footer:s(()=>[a(r,{onClick:e[18]||(e[18]=l=>D.value=!1)},{default:s(()=>[...e[33]||(e[33]=[y("取消",-1)])]),_:1}),a(r,{type:"primary",onClick:ne,loading:F.value},{default:s(()=>[...e[34]||(e[34]=[y("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[a(fe,{ref_key:"formRef",ref:z,model:o.value,rules:ae,"label-width":"120px"},{default:s(()=>[a(v,{label:"所属景区",prop:"scenic_spot_id"},{default:s(()=>[a(u,{modelValue:o.value.scenic_spot_id,"onUpdate:modelValue":e[5]||(e[5]=l=>o.value.scenic_spot_id=l),placeholder:"请选择景区",style:{width:"100%"},disabled:q.value,onChange:G},{default:s(()=>[(c(!0),w(N,null,R(x.value,l=>(c(),C(n,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),a(v,{label:"软件服务商",prop:"software_provider_id",required:""},{default:s(()=>[a(u,{modelValue:o.value.software_provider_id,"onUpdate:modelValue":e[6]||(e[6]=l=>o.value.software_provider_id=l),placeholder:"请先选择景区",style:{width:"100%"},disabled:!o.value.scenic_spot_id},{default:s(()=>[(c(!0),w(N,null,R(V.value,l=>(c(),C(n,{key:l.id,label:`${l.name} (${l.api_type||"无类型"})`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),o.value.scenic_spot_id?V.value.length===0?(c(),w("div",$e," 该景区尚未配置服务商，请先在景区管理页面添加服务商 ")):(c(),w("div",Ye," 选择产品使用的软件服务商（必填） ")):(c(),w("div",Se," 请先选择景区，然后选择该景区下的服务商 "))]),_:1}),a(v,{label:"产品名称",prop:"name"},{default:s(()=>[a(i,{modelValue:o.value.name,"onUpdate:modelValue":e[7]||(e[7]=l=>o.value.name=l),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),q.value?(c(),C(v,{key:0,label:"产品编码",prop:"code"},{default:s(()=>[a(i,{modelValue:o.value.code,"onUpdate:modelValue":e[8]||(e[8]=l=>o.value.code=l),placeholder:"系统自动生成",disabled:""},null,8,["modelValue"]),e[25]||(e[25]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品编码由系统自动生成，不可修改 ",-1))]),_:1})):Z("",!0),a(v,{label:"外部产品编码",prop:"external_code"},{default:s(()=>[a(i,{modelValue:o.value.external_code,"onUpdate:modelValue":e[9]||(e[9]=l=>o.value.external_code=l),placeholder:"请输入外部产品编码（可选，用于和景区系统对接，如横店）"},null,8,["modelValue"]),e[26]||(e[26]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 用于和景区系统（如横店）对接的产品编码，如果产品不需要对接外部系统，可留空 ",-1))]),_:1}),a(v,{label:"描述",prop:"description"},{default:s(()=>[a(i,{modelValue:o.value.description,"onUpdate:modelValue":e[10]||(e[10]=l=>o.value.description=l),type:"textarea",rows:4,placeholder:"请输入产品描述"},null,8,["modelValue"])]),_:1}),a(v,{label:"价格来源",prop:"price_source"},{default:s(()=>[a(u,{modelValue:o.value.price_source,"onUpdate:modelValue":e[11]||(e[11]=l=>o.value.price_source=l),placeholder:"请选择价格来源",style:{width:"100%"}},{default:s(()=>[a(n,{label:"人工维护",value:"manual"}),a(n,{label:"接口推送",value:"api"})]),_:1},8,["modelValue"]),e[27]||(e[27]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 选择接口推送后，价格将通过资源方接口自动更新 ",-1))]),_:1}),a(v,{label:"入住天数",prop:"stay_days",required:""},{default:s(()=>[a(me,{modelValue:o.value.stay_days,"onUpdate:modelValue":e[12]||(e[12]=l=>o.value.stay_days=l),min:1,max:30,placeholder:"请输入入住天数（必填）",style:{width:"100%"}},null,8,["modelValue"]),e[28]||(e[28]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品需要连续入住的天数，至少为1 ",-1))]),_:1}),a(v,{label:"销售开始日期",prop:"sale_start_date"},{default:s(()=>[a(Q,{modelValue:o.value.sale_start_date,"onUpdate:modelValue":e[13]||(e[13]=l=>o.value.sale_start_date=l),type:"date",placeholder:"选择销售开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":l=>o.value.sale_end_date&&l>new Date(o.value.sale_end_date)},null,8,["modelValue","disabled-date"]),e[29]||(e[29]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品开始销售的日期（必填） ",-1))]),_:1}),a(v,{label:"销售结束日期",prop:"sale_end_date"},{default:s(()=>[a(Q,{modelValue:o.value.sale_end_date,"onUpdate:modelValue":e[14]||(e[14]=l=>o.value.sale_end_date=l),type:"date",placeholder:"选择销售结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":l=>o.value.sale_start_date&&l<new Date(o.value.sale_start_date)},null,8,["modelValue","disabled-date"]),e[30]||(e[30]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品结束销售的日期（必填），不能早于开始日期 ",-1))]),_:1}),a(v,{label:"订单处理方式",prop:"order_mode"},{default:s(()=>[a(u,{modelValue:o.value.order_mode,"onUpdate:modelValue":e[15]||(e[15]=l=>o.value.order_mode=l),placeholder:"使用景区配置（默认）",clearable:"",style:{width:"100%"}},{default:s(()=>[a(n,{label:"使用景区配置（默认）",value:null}),a(n,{label:"系统直连",value:"auto"}),a(n,{label:"手工接单",value:"manual"}),a(n,{label:"其他系统",value:"other"})]),_:1},8,["modelValue"]),e[31]||(e[31]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 选择订单处理方式。留空则使用景区配置；系统直连=自动调用资源方接口；手工接单=需要人工处理；其他系统=对接其他订单系统 ",-1))]),_:1}),o.value.order_mode==="other"?(c(),C(v,{key:1,label:"订单下发服务商",prop:"order_provider_id"},{default:s(()=>[a(u,{modelValue:o.value.order_provider_id,"onUpdate:modelValue":e[16]||(e[16]=l=>o.value.order_provider_id=l),placeholder:"请选择订单下发服务商",clearable:"",style:{width:"100%"},disabled:!o.value.scenic_spot_id},{default:s(()=>[(c(!0),w(N,null,R(V.value,l=>(c(),C(n,{key:l.id,label:`${l.name} (${l.api_type||"无类型"})`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),e[32]||(e[32]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}},' 当订单处理方式为"其他系统"时，需要选择具体的订单下发服务商。留空则使用景区配置的订单下发服务商。 ',-1))]),_:1})):Z("",!0),a(v,{label:"状态",prop:"is_active"},{default:s(()=>[a(ve,{modelValue:o.value.is_active,"onUpdate:modelValue":e[17]||(e[17]=l=>o.value.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Be=be(Ee,[["__scopeId","data-v-74a3036b"]]);export{Be as default};
