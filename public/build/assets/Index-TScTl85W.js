import{_ as ve,u as fe,r as p,s as J,i as ge,c as j,o as w,f as h,b as l,w as s,d as i,j as D,E as f,e as ye,k as be,l as Ve,h as v,F as K,v as Z,n as O,x as G,y as xe,t as q,z as we,q as he}from"./app-DNdcCPa2.js";const De={style:{"margin-bottom":"20px"}},Ce={__name:"Index",setup(Se){const _=fe(),H=ye(),S=p([]),g=p([]),B=p(!1),T=p(!1),I=p({}),V=p(!1),k=p(null),U=p(""),z=p(null),Y=p(null),C=p(1),R=p(15),L=p(0),$=p(null),E=J(()=>$.value!==null),Q=J(()=>E.value?"编辑产品":"创建产品"),o=p({scenic_spot_id:null,name:"",code:"",description:"",price_source:"manual",stay_days:1,sale_start_date:null,sale_end_date:null,is_active:!0}),W={scenic_spot_id:[{required:!0,message:"请选择所属景区",trigger:"change"}],name:[{required:!0,message:"请输入产品名称",trigger:"blur"},{max:255,message:"产品名称不能超过255个字符",trigger:"blur"}],code:[{required:!0,message:"请输入产品编码",trigger:"blur"},{pattern:/^[a-zA-Z0-9_-]+$/,message:"产品编码只能包含字母、数字、下划线和连字符",trigger:"blur"}],price_source:[{required:!0,message:"请选择价格来源",trigger:"change"}],stay_days:[{required:!0,message:"请输入入住天数",trigger:"blur"},{type:"number",min:1,max:30,message:"入住天数必须在1-30之间",trigger:"blur"}],sale_start_date:[{required:!0,message:"请选择销售开始日期",trigger:"change"}],sale_end_date:[{validator:(t,e,n)=>{e?o.value.sale_start_date&&e<o.value.sale_start_date?n(new Error("销售结束日期不能早于开始日期")):n():n(new Error("请选择销售结束日期"))},trigger:"change"}]},b=async()=>{B.value=!0;try{const t={page:C.value,per_page:R.value};z.value&&(t.scenic_spot_id=z.value),Y.value!==null&&(t.is_active=Y.value),U.value&&(t.search=U.value);const e=await D.get("/products",{params:t});e.data&&e.data.data?(S.value=e.data.data||[],L.value=e.data.total||0):(S.value=e.data||[],L.value=S.value.length)}catch(t){f.error("获取产品列表失败"),console.error(t)}finally{B.value=!1}},F=async()=>{var t,e,n,r;try{if(((t=_.user)==null?void 0:t.role)!=="admin")(!_.user||!_.user.scenic_spots||_.user.scenic_spots.length===0)&&await _.fetchUser(),g.value=((e=_.user)==null?void 0:e.scenic_spots)||[],g.value.length===0&&console.warn("运营用户未绑定任何景区");else{const d=await D.get("/scenic-spots");g.value=d.data.data||[]}}catch(d){if(console.error("获取景区列表失败",d),(n=_.user)!=null&&n.scenic_spots&&_.user.scenic_spots.length>0)g.value=_.user.scenic_spots;else try{await _.fetchUser(),g.value=((r=_.user)==null?void 0:r.scenic_spots)||[]}catch(m){console.error("获取用户信息失败",m)}}},X=()=>{C.value=1,b()},A=()=>{C.value=1,b()},ee=async()=>{var t;if($.value=null,N(),g.value.length===0&&await F(),((t=_.user)==null?void 0:t.role)!=="admin"&&g.value.length===0){f.warning("您未绑定任何景区，请联系管理员为您分配景区");return}V.value=!0},ae=t=>{H.push(`/products/${t.id}/detail`)},le=t=>{$.value=t.id,o.value={scenic_spot_id:t.scenic_spot_id,name:t.name,code:t.code,description:t.description||"",price_source:t.price_source||"manual",stay_days:t.stay_days||1,sale_start_date:t.sale_start_date||null,sale_end_date:t.sale_end_date||null,is_active:t.is_active},V.value=!0},te=async()=>{k.value&&await k.value.validate(async t=>{var e,n,r,d,m,c;if(t){T.value=!0;try{const u={...o.value,stay_days:o.value.stay_days||1,sale_start_date:o.value.sale_start_date||null,sale_end_date:o.value.sale_end_date||null};E.value?(await D.put(`/products/${$.value}`,u),f.success("产品更新成功")):(await D.post("/products",u),f.success("产品创建成功")),V.value=!1,N(),setTimeout(()=>{b()},100)}catch(u){const M=((n=(e=u.response)==null?void 0:e.data)==null?void 0:n.message)||((c=(m=(d=(r=u.response)==null?void 0:r.data)==null?void 0:d.errors)==null?void 0:m.code)==null?void 0:c[0])||"操作失败";f.error(M)}finally{T.value=!1}}})},se=async t=>{var e,n;try{await he.confirm(`确定要删除产品"${t.name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await D.delete(`/products/${t.id}`),f.success("删除成功"),b()}catch(r){if(r!=="cancel"){const d=((n=(e=r.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败";f.error(d)}}},N=()=>{var t;o.value={scenic_spot_id:null,name:"",code:"",description:"",price_source:"manual",stay_days:1,sale_start_date:null,sale_end_date:null,is_active:!0},(t=k.value)==null||t.clearValidate()},oe=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",ne=async t=>{I.value[t.id]=!0;try{const e=await D.get(`/products/${t.id}/export`,{responseType:"blob",validateStatus:m=>m<500});if((e.headers["content-type"]||"").includes("application/json")||e.status>=400){const m=await e.data.text();let c="导出失败";try{c=JSON.parse(m).message||c}catch{c=m||c}f.error(c),console.error("导出失败",c);return}const r=window.URL.createObjectURL(new Blob([e.data])),d=document.createElement("a");d.href=r,d.setAttribute("download",`product_${t.code}_${new Date().toISOString().slice(0,10)}.csv`),document.body.appendChild(d),d.click(),d.remove(),window.URL.revokeObjectURL(r),f.success("导出成功")}catch(e){let n="导出失败";if(e.response){if(e.response.data)if(typeof e.response.data=="string")try{n=JSON.parse(e.response.data).message||n}catch{n=e.response.data||n}else e.response.data.message&&(n=e.response.data.message)}else e.message&&(n=e.message);f.error(n),console.error("导出失败",e)}finally{I.value[t.id]=!1}};return ge(()=>{b(),F()}),(t,e)=>{const n=i("el-button"),r=i("el-option"),d=i("el-select"),m=i("el-icon"),c=i("el-input"),u=i("el-table-column"),M=i("el-tag"),re=i("el-table"),de=i("el-pagination"),ue=i("el-card"),y=i("el-form-item"),ie=i("el-input-number"),P=i("el-date-picker"),pe=i("el-switch"),ce=i("el-form"),_e=i("el-dialog"),me=be("loading");return w(),j("div",null,[e[27]||(e[27]=h("h2",null,"产品管理",-1)),l(ue,null,{default:s(()=>[h("div",De,[l(n,{type:"primary",onClick:ee},{default:s(()=>[...e[16]||(e[16]=[v("创建产品",-1)])]),_:1}),l(d,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=a=>z.value=a),placeholder:"筛选景区",clearable:"",style:{width:"200px","margin-left":"10px"},onChange:A},{default:s(()=>[(w(!0),j(K,null,Z(g.value,a=>(w(),O(r,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(d,{modelValue:Y.value,"onUpdate:modelValue":e[1]||(e[1]=a=>Y.value=a),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:A},{default:s(()=>[l(r,{label:"启用",value:!0}),l(r,{label:"禁用",value:!1})]),_:1},8,["modelValue"]),l(c,{modelValue:U.value,"onUpdate:modelValue":e[2]||(e[2]=a=>U.value=a),placeholder:"搜索产品名称或编码",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:X},{prefix:s(()=>[l(m,null,{default:s(()=>[l(G(xe))]),_:1})]),_:1},8,["modelValue"])]),Ve((w(),O(re,{data:S.value,border:""},{default:s(()=>[l(u,{prop:"name",label:"产品名称",width:"200"}),l(u,{prop:"code",label:"产品编码",width:"150"}),l(u,{label:"所属景区",width:"150"},{default:s(({row:a})=>{var x;return[v(q(((x=a.scenic_spot)==null?void 0:x.name)||"-"),1)]}),_:1}),l(u,{prop:"description",label:"描述","show-overflow-tooltip":""}),l(u,{prop:"price_source",label:"价格来源",width:"120"},{default:s(({row:a})=>[l(M,{type:a.price_source==="manual"?"primary":"success"},{default:s(()=>[v(q(a.price_source==="manual"?"人工维护":"接口推送"),1)]),_:2},1032,["type"])]),_:1}),l(u,{prop:"is_active",label:"状态",width:"100"},{default:s(({row:a})=>[l(M,{type:a.is_active?"success":"danger"},{default:s(()=>[v(q(a.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(u,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:a})=>[v(q(oe(a.created_at)),1)]),_:1}),l(u,{label:"操作",width:"350",fixed:"right"},{default:s(({row:a})=>[l(n,{size:"small",onClick:x=>ae(a)},{default:s(()=>[...e[17]||(e[17]=[v("详情",-1)])]),_:1},8,["onClick"]),l(n,{size:"small",onClick:x=>le(a)},{default:s(()=>[...e[18]||(e[18]=[v("编辑",-1)])]),_:1},8,["onClick"]),l(n,{size:"small",type:"success",onClick:x=>ne(a),loading:I.value[a.id]},{default:s(()=>[l(m,null,{default:s(()=>[l(G(we))]),_:1}),e[19]||(e[19]=v(" 导出 ",-1))]),_:1},8,["onClick","loading"]),l(n,{size:"small",type:"danger",onClick:x=>se(a)},{default:s(()=>[...e[20]||(e[20]=[v("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[me,B.value]]),l(de,{"current-page":C.value,"onUpdate:currentPage":e[3]||(e[3]=a=>C.value=a),"page-size":R.value,"onUpdate:pageSize":e[4]||(e[4]=a=>R.value=a),"page-sizes":[10,20,50,100],total:L.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:b,onCurrentChange:b},null,8,["current-page","page-size","total"])]),_:1}),l(_e,{modelValue:V.value,"onUpdate:modelValue":e[15]||(e[15]=a=>V.value=a),title:Q.value,width:"600px",onClose:N},{footer:s(()=>[l(n,{onClick:e[14]||(e[14]=a=>V.value=!1)},{default:s(()=>[...e[25]||(e[25]=[v("取消",-1)])]),_:1}),l(n,{type:"primary",onClick:te,loading:T.value},{default:s(()=>[...e[26]||(e[26]=[v("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(ce,{ref_key:"formRef",ref:k,model:o.value,rules:W,"label-width":"120px"},{default:s(()=>[l(y,{label:"所属景区",prop:"scenic_spot_id"},{default:s(()=>[l(d,{modelValue:o.value.scenic_spot_id,"onUpdate:modelValue":e[5]||(e[5]=a=>o.value.scenic_spot_id=a),placeholder:"请选择景区",style:{width:"100%"},disabled:E.value},{default:s(()=>[(w(!0),j(K,null,Z(g.value,a=>(w(),O(r,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),l(y,{label:"产品名称",prop:"name"},{default:s(()=>[l(c,{modelValue:o.value.name,"onUpdate:modelValue":e[6]||(e[6]=a=>o.value.name=a),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),l(y,{label:"产品编码",prop:"code"},{default:s(()=>[l(c,{modelValue:o.value.code,"onUpdate:modelValue":e[7]||(e[7]=a=>o.value.code=a),placeholder:"请输入产品编码（唯一）",disabled:E.value},null,8,["modelValue","disabled"])]),_:1}),l(y,{label:"描述",prop:"description"},{default:s(()=>[l(c,{modelValue:o.value.description,"onUpdate:modelValue":e[8]||(e[8]=a=>o.value.description=a),type:"textarea",rows:4,placeholder:"请输入产品描述"},null,8,["modelValue"])]),_:1}),l(y,{label:"价格来源",prop:"price_source"},{default:s(()=>[l(d,{modelValue:o.value.price_source,"onUpdate:modelValue":e[9]||(e[9]=a=>o.value.price_source=a),placeholder:"请选择价格来源",style:{width:"100%"}},{default:s(()=>[l(r,{label:"人工维护",value:"manual"}),l(r,{label:"接口推送",value:"api"})]),_:1},8,["modelValue"]),e[21]||(e[21]=h("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 选择接口推送后，价格将通过资源方接口自动更新 ",-1))]),_:1}),l(y,{label:"入住天数",prop:"stay_days",required:""},{default:s(()=>[l(ie,{modelValue:o.value.stay_days,"onUpdate:modelValue":e[10]||(e[10]=a=>o.value.stay_days=a),min:1,max:30,placeholder:"请输入入住天数（必填）",style:{width:"100%"}},null,8,["modelValue"]),e[22]||(e[22]=h("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品需要连续入住的天数，至少为1 ",-1))]),_:1}),l(y,{label:"销售开始日期",prop:"sale_start_date"},{default:s(()=>[l(P,{modelValue:o.value.sale_start_date,"onUpdate:modelValue":e[11]||(e[11]=a=>o.value.sale_start_date=a),type:"date",placeholder:"选择销售开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":a=>o.value.sale_end_date&&a>new Date(o.value.sale_end_date)},null,8,["modelValue","disabled-date"]),e[23]||(e[23]=h("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品开始销售的日期（必填） ",-1))]),_:1}),l(y,{label:"销售结束日期",prop:"sale_end_date"},{default:s(()=>[l(P,{modelValue:o.value.sale_end_date,"onUpdate:modelValue":e[12]||(e[12]=a=>o.value.sale_end_date=a),type:"date",placeholder:"选择销售结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":a=>o.value.sale_start_date&&a<new Date(o.value.sale_start_date)},null,8,["modelValue","disabled-date"]),e[24]||(e[24]=h("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品结束销售的日期（必填），不能早于开始日期 ",-1))]),_:1}),l(y,{label:"状态",prop:"is_active"},{default:s(()=>[l(pe,{modelValue:o.value.is_active,"onUpdate:modelValue":e[13]||(e[13]=a=>o.value.is_active=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},ze=ve(Ce,[["__scopeId","data-v-4f87eb36"]]);export{ze as default};
