import{_ as $e,r as c,x as De,i as Be,j as Ae,c as V,o as p,b as s,m as J,w as l,d as _,l as Se,q as b,k as x,B as Me,E as f,e as Pe,f as O,t as m,s as se,h as i,y as oe,G as Ie,H as Ye,F as K,p as Q,v as B}from"./app-C072kKQ9.js";const Fe={key:0},je={style:{"margin-bottom":"20px"}},Ee={style:{"margin-bottom":"20px"}},Ue={style:{"margin-bottom":"20px"}},ze={key:0},Re={key:1,style:{color:"#909399"}},Ne={__name:"PriceManagement",setup(He){const $=Me(),ne=Pe(),I=c(!1),d=c(null),E=c(!1),U=c(!1);c(!1);const Y=c(!1),z=c([]),k=c([]),C=c(null),A=c(null),W=c("priceCalendar"),X=c([]),F=c([]),T=c([]),R=c(!1),N=c([]),S=c(!1),H=c(!1),D=c({ota_platform_id:null}),g=c({});De(()=>C.value?F.value.filter(t=>t.hotel_id===C.value):F.value);const re=()=>{ne.push("/pkg-products")},Z=t=>{if(!t)return"";const e=new Date(t),u=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),v=String(e.getMinutes()).padStart(2,"0");return`${u}-${o}-${r} ${n}:${v}`},ue=t=>{if(!t)return"";const e=new Date(t),u=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${u}-${o}-${r}`},ee=t=>t?parseFloat(t).toFixed(2):"0.00",de=async()=>{I.value=!0;try{const t=await x.get(`/pkg-products/${$.params.id}`);if(d.value=t.data.data,d.value.hotel_room_types){const o=new Map,r=new Map;d.value.hotel_room_types.forEach(n=>{n.hotel&&!o.has(n.hotel.id)&&o.set(n.hotel.id,n.hotel),n.room_type&&!r.has(n.room_type.id)&&r.set(n.room_type.id,{...n.room_type,hotel_id:n.hotel_id})}),X.value=Array.from(o.values()),F.value=Array.from(r.values())}const e=new Date,u=new Date;u.setDate(e.getDate()+30),k.value=[e.toISOString().split("T")[0],u.toISOString().split("T")[0]],await M(),await _e(),await fe()}catch(t){f.error("获取产品详情失败"),console.error(t)}finally{I.value=!1}},M=async()=>{if(d.value){Y.value=!0;try{const t={};k.value&&k.value.length===2&&(t.start_date=k.value[0],t.end_date=k.value[1]),C.value&&(t.hotel_id=C.value),A.value&&(t.room_type_id=A.value);const e=await x.get(`/pkg-products/${$.params.id}/prices/calendar`,{params:t});z.value=e.data.data||[]}catch(t){f.error("获取价格日历失败"),console.error(t)}finally{Y.value=!1}}},ie=()=>{k.value=[],C.value=null,A.value=null,M()},ce=async()=>{var t,e;try{await B.confirm("确定要预计算未来60天的价格吗？这可能需要一些时间，将在后台异步处理。","提示",{type:"info"}),E.value=!0;try{await x.post(`/pkg-products/${$.params.id}/prices/calculate`),f.success("价格预计算任务已提交，正在后台处理，请稍后刷新查看结果")}catch(u){const o=((e=(t=u.response)==null?void 0:t.data)==null?void 0:e.message)||u.message||"操作失败";f.error(o),console.error(u)}finally{E.value=!1}}catch{}},pe=async()=>{var t,e;try{await B.confirm("确定要重新计算价格吗？这将重新计算所有关联的门票和酒店价格，可能需要一些时间。","提示",{type:"warning"}),U.value=!0;try{await x.post(`/pkg-products/${$.params.id}/prices/recalculate`),f.success("价格重新计算任务已提交，正在后台处理，请稍后刷新查看结果")}catch(u){const o=((e=(t=u.response)==null?void 0:t.data)==null?void 0:e.message)||u.message||"操作失败";f.error(o),console.error(u)}finally{U.value=!1}}catch{}},_e=async()=>{try{const t=await x.get("/ota-platforms",{params:{active_only:!0}});N.value=t.data.data||[]}catch(t){console.error("获取OTA平台列表失败",t)}},fe=async()=>{if(d.value){R.value=!0;try{T.value=d.value.ota_products||[]}catch(t){console.error("获取OTA产品绑定列表失败",t)}finally{R.value=!1}}},j=async()=>{if(d.value)try{const t=await x.get("/pkg-ota-products",{params:{pkg_product_id:$.params.id}});T.value=t.data.data||[],d.value&&(d.value.ota_products=T.value)}catch(t){console.error("获取OTA产品绑定列表失败",t)}},me=()=>{D.value={ota_platform_id:null},S.value=!0},ve=async()=>{var t,e,u;if(!D.value.ota_platform_id){f.warning("请选择OTA平台");return}H.value=!0;try{const o=await x.post(`/pkg-products/${$.params.id}/bind-ota`,{ota_platform_id:D.value.ota_platform_id});o.data.success?(f.success("绑定成功"),S.value=!1,(t=o.data.data)!=null&&t.ota_product?(T.value.push(o.data.data.ota_product),d.value&&(d.value.ota_products||(d.value.ota_products=[]),d.value.ota_products.push(o.data.data.ota_product))):await j()):f.error(o.data.message||"绑定失败")}catch(o){const r=((u=(e=o.response)==null?void 0:e.data)==null?void 0:u.message)||"绑定失败";f.error(r)}finally{H.value=!1}},ge=async t=>{var e,u,o,r;try{await B.confirm(`确定要推送产品价格到 ${(e=t.ota_platform)==null?void 0:e.name} 吗？`,"确认推送",{type:"warning",confirmButtonText:"确定推送",cancelButtonText:"取消"});const n=await x.post(`/pkg-ota-products/${t.id}/push`);n.data.success?(n.data.message&&n.data.message.includes("后台处理")?f.success("推送任务已提交，正在后台处理中"):f.success("推送成功"),n.data.data&&(t.push_status=n.data.data.push_status,t.push_started_at=n.data.data.push_started_at),((u=n.data.data)==null?void 0:u.push_status)==="processing"?be(t.id):n.data.data&&Object.assign(t,n.data.data)):f.error(n.data.message||"推送失败")}catch(n){if(n!=="cancel"){const v=((r=(o=n.response)==null?void 0:o.data)==null?void 0:r.message)||"推送失败";f.error(v)}}},ye=async t=>{var e;try{!t.pushed_at?await B.prompt("请选择OTA平台","编辑OTA产品",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"select",inputOptions:N.value.reduce((o,r)=>(o[r.id]=r.name,o),{}),inputValue:(e=t.ota_platform_id)==null?void 0:e.toString()}).then(async({value:o})=>{var v;const r=parseInt(o),n=await x.put(`/pkg-ota-products/${t.id}`,{ota_platform_id:r,is_active:t.is_active});if(f.success("更新成功"),n.data.success&&n.data.data){if(Object.assign(t,n.data.data),(v=d.value)!=null&&v.ota_products){const w=d.value.ota_products.findIndex(y=>y.id===t.id);w!==-1&&Object.assign(d.value.ota_products[w],n.data.data)}}else await j()}):await B.prompt("请选择状态","编辑OTA产品",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"select",inputOptions:{true:"启用",false:"禁用"},inputValue:t.is_active?"true":"false"}).then(async({value:o})=>{var v;const r=o==="true",n=await x.put(`/pkg-ota-products/${t.id}`,{is_active:r});if(f.success("更新成功"),n.data.success&&n.data.data){if(Object.assign(t,n.data.data),(v=d.value)!=null&&v.ota_products){const w=d.value.ota_products.findIndex(y=>y.id===t.id);w!==-1&&Object.assign(d.value.ota_products[w],n.data.data)}}else await j()})}catch(u){u!=="cancel"&&console.error("编辑OTA产品失败",u)}},he=async t=>{var e,u,o;try{await B.confirm("确定要删除该OTA推送记录吗？","提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await x.delete(`/pkg-ota-products/${t.id}`),f.success("删除成功");const r=T.value.findIndex(n=>n.id===t.id);if(r!==-1&&T.value.splice(r,1),(e=d.value)!=null&&e.ota_products){const n=d.value.ota_products.findIndex(v=>v.id===t.id);n!==-1&&d.value.ota_products.splice(n,1)}}catch(r){if(r!=="cancel"){const n=((o=(u=r.response)==null?void 0:u.data)==null?void 0:o.message)||"删除失败";f.error(n)}}},be=t=>{g.value[t]&&(clearInterval(g.value[t]),delete g.value[t]),g.value[t]=setInterval(async()=>{var e,u;try{await j();const o=T.value.find(r=>r.id===t);o?o.push_status!=="processing"&&(clearInterval(g.value[t]),delete g.value[t],o.push_status==="success"?f.success(`产品价格推送到 ${(e=o.ota_platform)==null?void 0:e.name} 成功`):o.push_status==="failed"&&f.error(`产品价格推送到 ${(u=o.ota_platform)==null?void 0:u.name} 失败：${o.push_message||"未知错误"}`)):(clearInterval(g.value[t]),delete g.value[t])}catch(o){console.error("轮询推送状态失败",o),clearInterval(g.value[t]),delete g.value[t]}},3e3)};return Be(()=>{de()}),Ae(()=>{Object.keys(g.value).forEach(t=>{clearInterval(g.value[t])}),g.value={}}),(t,e)=>{const u=_("el-page-header"),o=_("el-descriptions-item"),r=_("el-tag"),n=_("el-descriptions"),v=_("el-divider"),w=_("el-icon"),y=_("el-button"),xe=_("el-alert"),ke=_("el-date-picker"),L=_("el-option"),q=_("el-select"),h=_("el-table-column"),te=_("el-table"),ae=_("el-empty"),le=_("el-tab-pane"),Te=_("el-form-item"),we=_("el-form"),Oe=_("el-dialog"),Ce=_("el-tabs"),Ve=_("el-card"),G=Se("loading");return p(),V("div",null,[s(u,{onBack:re,title:"返回打包产品列表"},{content:l(()=>{var a;return[O("span",null,"价格管理 - "+m(((a=d.value)==null?void 0:a.product_name)||"加载中..."),1)]}),_:1}),J((p(),b(Ve,{style:{"margin-top":"20px"}},{default:l(()=>[d.value?(p(),V("div",Fe,[s(n,{title:"产品基本信息",column:2,border:"",style:{"margin-bottom":"20px"}},{default:l(()=>[s(o,{label:"产品名称"},{default:l(()=>[i(m(d.value.product_name),1)]),_:1}),s(o,{label:"产品编码"},{default:l(()=>[i(m(d.value.product_code),1)]),_:1}),s(o,{label:"所属景区"},{default:l(()=>{var a;return[i(m(((a=d.value.scenic_spot)==null?void 0:a.name)||"-"),1)]}),_:1}),s(o,{label:"入住天数"},{default:l(()=>[i(m(d.value.stay_days)+" 天",1)]),_:1}),s(o,{label:"状态"},{default:l(()=>[s(r,{type:d.value.status===1?"success":"danger"},{default:l(()=>[i(m(d.value.status===1?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1})]),_:1}),s(Ce,{modelValue:W.value,"onUpdate:modelValue":e[6]||(e[6]=a=>W.value=a),style:{"margin-top":"20px"}},{default:l(()=>[s(le,{label:"价格日历",name:"priceCalendar"},{default:l(()=>[s(v,null,{default:l(()=>[...e[7]||(e[7]=[i("价格管理操作",-1)])]),_:1}),O("div",je,[s(y,{type:"primary",onClick:ce,loading:E.value},{default:l(()=>[s(w,null,{default:l(()=>[s(oe(Ie))]),_:1}),e[8]||(e[8]=i(" 预计算价格（未来60天） ",-1))]),_:1},8,["loading"]),s(y,{type:"success",onClick:pe,loading:U.value},{default:l(()=>[s(w,null,{default:l(()=>[s(oe(Ye))]),_:1}),e[9]||(e[9]=i(" 重新计算价格 ",-1))]),_:1},8,["loading"]),s(xe,{title:"提示",type:"info",closable:!1,style:{"margin-top":"10px"}},{default:l(()=>[...e[10]||(e[10]=[O("div",null,[O("p",null,"• 预计算价格：为产品计算未来60天的价格日历"),O("p",null,"• 重新计算价格：当门票或酒店价格变更后，重新计算产品价格"),O("p",null,"• 价格公式：酒店价格 + Σ(门票价格 × 张数)")],-1)])]),_:1})]),s(v,null,{default:l(()=>[...e[11]||(e[11]=[i("价格日历",-1)])]),_:1}),O("div",Ee,[s(ke,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=a=>k.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{"margin-right":"10px"},onChange:M},null,8,["modelValue"]),s(q,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=a=>C.value=a),placeholder:"筛选酒店",clearable:"",style:{width:"200px","margin-right":"10px"},onChange:M},{default:l(()=>[(p(!0),V(K,null,Q(X.value,a=>(p(),b(L,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(q,{modelValue:A.value,"onUpdate:modelValue":e[2]||(e[2]=a=>A.value=a),placeholder:"筛选房型",clearable:"",style:{width:"200px","margin-right":"10px"},onChange:M},{default:l(()=>[(p(!0),V(K,null,Q(F.value,a=>(p(),b(L,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(y,{onClick:ie},{default:l(()=>[...e[12]||(e[12]=[i("重置筛选",-1)])]),_:1})]),J((p(),b(te,{data:z.value,border:"",style:{width:"100%"},"max-height":"600"},{default:l(()=>[s(h,{prop:"biz_date",label:"日期",width:"120",fixed:"left"},{default:l(({row:a})=>[i(m(ue(a.biz_date)),1)]),_:1}),s(h,{prop:"hotel.name",label:"酒店",width:"150"}),s(h,{prop:"room_type.name",label:"房型",width:"150"}),s(h,{prop:"composite_code",label:"OTA编码",width:"250","show-overflow-tooltip":""},{default:l(({row:a})=>[s(r,{size:"small"},{default:l(()=>[i(m(a.composite_code),1)]),_:2},1024)]),_:1}),s(h,{prop:"sale_price",label:"销售价",width:"120",align:"right"},{default:l(({row:a})=>[i(" ¥"+m(ee(a.sale_price)),1)]),_:1}),s(h,{prop:"cost_price",label:"成本价",width:"120",align:"right"},{default:l(({row:a})=>[i(" ¥"+m(ee(a.cost_price)),1)]),_:1}),s(h,{prop:"last_updated_at",label:"更新时间",width:"180"},{default:l(({row:a})=>[i(m(Z(a.last_updated_at)),1)]),_:1})]),_:1},8,["data"])),[[G,Y.value]]),!Y.value&&z.value.length===0?(p(),b(ae,{key:0,description:"暂无价格数据，请先预计算价格"})):se("",!0)]),_:1}),s(le,{label:"OTA推送管理",name:"otaProducts"},{default:l(()=>[O("div",Ue,[s(y,{type:"primary",onClick:me},{default:l(()=>[...e[13]||(e[13]=[i("绑定OTA平台",-1)])]),_:1})]),J((p(),b(te,{data:T.value,border:""},{default:l(()=>[s(h,{label:"OTA平台",width:"150"},{default:l(({row:a})=>{var P;return[i(m(((P=a.ota_platform)==null?void 0:P.name)||"-"),1)]}),_:1}),s(h,{label:"OTA产品ID",width:"200"},{default:l(({row:a})=>[a.ota_product_id?(p(),V("span",ze,m(a.ota_product_id),1)):(p(),V("span",Re,"-"))]),_:1}),s(h,{prop:"is_active",label:"状态",width:"100"},{default:l(({row:a})=>[s(r,{type:a.is_active?"success":"danger"},{default:l(()=>[i(m(a.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),s(h,{label:"推送状态",width:"150"},{default:l(({row:a})=>[a.push_status==="processing"?(p(),b(r,{key:0,type:"warning"},{default:l(()=>[...e[14]||(e[14]=[i(" 推送中... ",-1)])]),_:1})):a.push_status==="success"?(p(),b(r,{key:1,type:"success"},{default:l(()=>[...e[15]||(e[15]=[i(" 推送成功 ",-1)])]),_:1})):a.push_status==="failed"?(p(),b(r,{key:2,type:"danger"},{default:l(()=>[...e[16]||(e[16]=[i(" 推送失败 ",-1)])]),_:1})):a.pushed_at?(p(),b(r,{key:3,type:"success"},{default:l(()=>[...e[17]||(e[17]=[i(" 已推送 ",-1)])]),_:1})):(p(),b(r,{key:4,type:"info"},{default:l(()=>[...e[18]||(e[18]=[i(" 未推送 ",-1)])]),_:1}))]),_:1}),s(h,{prop:"pushed_at",label:"推送时间",width:"180"},{default:l(({row:a})=>[i(m(a.pushed_at?Z(a.pushed_at):"-"),1)]),_:1}),s(h,{label:"操作",width:"250",fixed:"right"},{default:l(({row:a})=>[s(y,{size:"small",onClick:P=>ye(a)},{default:l(()=>[...e[19]||(e[19]=[i("编辑",-1)])]),_:1},8,["onClick"]),s(y,{size:"small",type:"danger",onClick:P=>he(a)},{default:l(()=>[...e[20]||(e[20]=[i("删除",-1)])]),_:1},8,["onClick"]),s(y,{size:"small",type:"primary",onClick:P=>ge(a),disabled:!a.is_active||a.push_status==="processing",loading:a.push_status==="processing"},{default:l(()=>[i(m(a.push_status==="processing"?"推送中...":a.pushed_at?"重新推送":"推送"),1)]),_:2},1032,["onClick","disabled","loading"])]),_:1})]),_:1},8,["data"])),[[G,R.value]]),s(Oe,{modelValue:S.value,"onUpdate:modelValue":e[5]||(e[5]=a=>S.value=a),title:"绑定OTA平台",width:"500px"},{footer:l(()=>[s(y,{onClick:e[4]||(e[4]=a=>S.value=!1)},{default:l(()=>[...e[21]||(e[21]=[i("取消",-1)])]),_:1}),s(y,{type:"primary",onClick:ve,loading:H.value},{default:l(()=>[...e[22]||(e[22]=[i("确定",-1)])]),_:1},8,["loading"])]),default:l(()=>[s(we,{model:D.value,"label-width":"120px"},{default:l(()=>[s(Te,{label:"选择OTA平台",required:""},{default:l(()=>[s(q,{modelValue:D.value.ota_platform_id,"onUpdate:modelValue":e[3]||(e[3]=a=>D.value.ota_platform_id=a),placeholder:"请选择要绑定的OTA平台",style:{width:"100%"}},{default:l(()=>[(p(!0),V(K,null,Q(N.value,a=>(p(),b(L,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])])):I.value?se("",!0):(p(),b(ae,{key:1,description:"产品信息加载失败或不存在"}))]),_:1})),[[G,I.value]])])}}},qe=$e(Ne,[["__scopeId","data-v-bed626b5"]]);export{qe as default};
