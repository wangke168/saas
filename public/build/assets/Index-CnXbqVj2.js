import{_ as $e,r as p,x as ve,i as Te,c as N,o as b,f as x,b as a,w as o,d as v,k as S,E as U,l as Ee,m as Ie,h as w,y as Re,z as qe,q as z,t as fe,F as J,p as Q,s as Oe,v as Ae}from"./app-CdpQl6cX.js";const Be={style:{"margin-bottom":"20px"}},De={style:{display:"flex",gap:"10px",width:"100%"}},Fe={__name:"Index",setup(he){const W=p([]),M=p([]),Y=p([]),L=p(!1),K=p(!1),$=p(!1),A=p(null),P=p(""),B=p(1),Z=p(15),ee=p(0),D=p(null),E=p(!1),F=p(null),G=p(!1),le=p(null),r=p({api_url:"",username:"",password:"",environment:"production",sync_mode:{inventory:"manual",price:"manual",order:"manual"},order_provider:null,credentials:{ctrip:{username:"",password:""},meituan:{username:"",password:""},fliggy:{username:"",password:""}},is_active:!0}),H=ve(()=>D.value!==null),ge=ve(()=>H.value?"编辑景区":"创建景区"),u=p({name:"",code:"",address:"",contact_phone:"",description:"",software_provider_id:null,is_active:!0}),_e={name:[{required:!0,message:"请输入景区名称",trigger:"blur"},{max:255,message:"景区名称不能超过255个字符",trigger:"blur"}],code:[{pattern:/^[a-zA-Z0-9_-]+$/,message:"景区编码只能包含字母、数字、下划线和连字符",trigger:"blur"}],contact_phone:[{pattern:/^1[3-9]\d{9}$|^0\d{2,3}-?\d{7,8}$/,message:"请输入正确的电话号码",trigger:"blur"}]},ye={api_url:[{required:!0,message:"请输入接口地址",trigger:"blur"},{type:"url",message:"请输入有效的URL",trigger:["blur","change"]}],username:[{required:!0,message:"请输入默认用户名",trigger:"blur"}],password:[{min:0,max:255,message:"密码长度不能超过255个字符",trigger:"blur"}],environment:[{required:!0,message:"请选择环境",trigger:"change"}],"sync_mode.inventory":[{required:!0,message:"请选择库存同步方式",trigger:"change"}],"sync_mode.price":[{required:!0,message:"请选择价格同步方式",trigger:"change"}],"sync_mode.order":[{required:!0,message:"请选择订单处理方式",trigger:"change"}]},k=async()=>{L.value=!0;try{const t={page:B.value,per_page:Z.value};P.value;const e=await S.get("/scenic-spots",{params:t});W.value=e.data.data||[],ee.value=e.data.total||0}catch(t){U.error("获取景区列表失败"),console.error(t)}finally{L.value=!1}},we=async()=>{try{const t=await S.get("/software-providers");M.value=t.data.data||[]}catch(t){console.error("获取软件服务商列表失败",t)}},be=async()=>{try{const t=await S.get("/ota-platforms");Y.value=t.data.data||[]}catch(t){console.error("获取OTA平台列表失败",t)}},Ve=()=>{B.value=1,k()},xe=()=>{D.value=null,ae(),$.value=!0},Ce=t=>{D.value=t.id,u.value={name:t.name,code:t.code,address:t.address||"",contact_phone:t.contact_phone||"",description:t.description||"",software_provider_id:t.software_provider_id,is_active:t.is_active},$.value=!0},Ue=async()=>{A.value&&await A.value.validate(async t=>{var e,m,V,n,s,f;if(t){K.value=!0;try{if(H.value)await S.put(`/scenic-spots/${D.value}`,u.value),U.success("景区更新成功");else{const{code:_,...i}=u.value;await S.post("/scenic-spots",i),U.success("景区创建成功")}$.value=!1,k()}catch(_){const i=((m=(e=_.response)==null?void 0:e.data)==null?void 0:m.message)||((f=(s=(n=(V=_.response)==null?void 0:V.data)==null?void 0:n.errors)==null?void 0:s.code)==null?void 0:f[0])||"操作失败";U.error(i)}finally{K.value=!1}}})},Se=async t=>{try{await Ae.confirm(`确定要删除景区"${t.name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await S.delete(`/scenic-spots/${t.id}`),U.success("删除成功"),k()}catch(e){e!=="cancel"&&(U.error("删除失败"),console.error(e))}},ae=()=>{var t;u.value={name:"",code:"",address:"",contact_phone:"",description:"",software_provider_id:null,is_active:!0},(t=A.value)==null||t.clearValidate()},ke=async t=>{var e,m,V,n,s,f,_,i,h,d,g,C,I,R,q,X,O,j,l,y,te,re,se,ne,de,ue,ie,pe,me,ce;le.value=t.id,oe(),E.value=!0;try{const T=await S.get(`/scenic-spots/${t.id}/resource-config`);if(T.data.success&&T.data.data){const c=T.data.data;r.value={api_url:c.api_url||"",username:c.username||"",password:c.password==="***EXISTS***"?"":c.password||"",environment:c.environment||"production",sync_mode:((e=c.extra_config)==null?void 0:e.sync_mode)||{inventory:"manual",price:"manual",order:"manual"},order_provider:((m=c.extra_config)==null?void 0:m.order_provider)||null,credentials:{ctrip:{username:((s=(n=(V=c.extra_config)==null?void 0:V.credentials)==null?void 0:n.ctrip)==null?void 0:s.username)||"",password:((i=(_=(f=c.extra_config)==null?void 0:f.credentials)==null?void 0:_.ctrip)==null?void 0:i.password)==="***EXISTS***"?"":((g=(d=(h=c.extra_config)==null?void 0:h.credentials)==null?void 0:d.ctrip)==null?void 0:g.password)||""},meituan:{username:((R=(I=(C=c.extra_config)==null?void 0:C.credentials)==null?void 0:I.meituan)==null?void 0:R.username)||"",password:((O=(X=(q=c.extra_config)==null?void 0:q.credentials)==null?void 0:X.meituan)==null?void 0:O.password)==="***EXISTS***"?"":((y=(l=(j=c.extra_config)==null?void 0:j.credentials)==null?void 0:l.meituan)==null?void 0:y.password)||""},fliggy:{username:((se=(re=(te=c.extra_config)==null?void 0:te.credentials)==null?void 0:re.fliggy)==null?void 0:se.username)||"",password:((ue=(de=(ne=c.extra_config)==null?void 0:ne.credentials)==null?void 0:de.fliggy)==null?void 0:ue.password)==="***EXISTS***"?"":((me=(pe=(ie=c.extra_config)==null?void 0:ie.credentials)==null?void 0:pe.fliggy)==null?void 0:me.password)||""}},is_active:c.is_active??!0}}}catch(T){((ce=T.response)==null?void 0:ce.status)!==404&&(U.error("获取资源配置失败"),console.error(T))}},ze=async()=>{F.value&&await F.value.validate(async t=>{var e,m,V,n;if(t){G.value=!0;try{const s={};for(const[_,i]of Object.entries(r.value.credentials||{}))i&&(i.username||i.password)&&(s[_]={username:i.username||"",password:i.password||""});const f={api_url:r.value.api_url,username:r.value.username,...r.value.password&&r.value.password!=="***EXISTS***"?{password:String(r.value.password)}:{},environment:r.value.environment,is_active:r.value.is_active,sync_mode:r.value.sync_mode,order_provider:r.value.order_provider||null,credentials:Object.keys(s).length>0?s:{}};await S.post(`/scenic-spots/${le.value}/resource-config`,f),U.success("资源配置保存成功"),E.value=!1,k()}catch(s){let f="保存失败";if((m=(e=s.response)==null?void 0:e.data)!=null&&m.message)f=s.response.data.message;else if((n=(V=s.response)==null?void 0:V.data)!=null&&n.errors){const _=s.response.data.errors,i=Object.values(_)[0];f=Array.isArray(i)?i[0]:i}U.error(f),console.error("保存资源配置失败:",s)}finally{G.value=!1}}})},oe=()=>{var t;r.value={api_url:"",username:"",password:"",environment:"production",sync_mode:{inventory:"",price:"",order:""},order_provider:null,credentials:{ctrip:{username:"",password:""},meituan:{username:"",password:""},fliggy:{username:"",password:""}},is_active:!0},(t=F.value)==null||t.clearValidate()};return Te(()=>{k(),we(),be()}),(t,e)=>{const m=v("el-button"),V=v("el-icon"),n=v("el-input"),s=v("el-table-column"),f=v("el-tag"),_=v("el-table"),i=v("el-pagination"),h=v("el-card"),d=v("el-form-item"),g=v("el-option"),C=v("el-select"),I=v("el-switch"),R=v("el-form"),q=v("el-dialog"),X=v("el-alert"),O=v("el-divider"),j=Ee("loading");return b(),N("div",null,[e[40]||(e[40]=x("h2",null,"景区管理",-1)),a(h,null,{default:o(()=>[x("div",Be,[a(m,{type:"primary",onClick:xe},{default:o(()=>[...e[23]||(e[23]=[w("创建景区",-1)])]),_:1}),a(n,{modelValue:P.value,"onUpdate:modelValue":e[0]||(e[0]=l=>P.value=l),placeholder:"搜索景区名称或编码",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:Ve},{prefix:o(()=>[a(V,null,{default:o(()=>[a(Re(qe))]),_:1})]),_:1},8,["modelValue"])]),Ie((b(),z(_,{data:W.value,border:""},{default:o(()=>[a(s,{prop:"name",label:"景区名称",width:"200"}),a(s,{prop:"code",label:"景区编码",width:"150"}),a(s,{prop:"address",label:"地址","show-overflow-tooltip":""}),a(s,{prop:"contact_phone",label:"联系电话",width:"150"}),a(s,{label:"软件服务商",width:"150"},{default:o(({row:l})=>{var y;return[w(fe(((y=l.software_provider)==null?void 0:y.name)||"-"),1)]}),_:1}),a(s,{prop:"is_active",label:"状态",width:"100"},{default:o(({row:l})=>[a(f,{type:l.is_active?"success":"danger"},{default:o(()=>[w(fe(l.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(s,{label:"操作",width:"280",fixed:"right"},{default:o(({row:l})=>[a(m,{size:"small",onClick:y=>Ce(l)},{default:o(()=>[...e[24]||(e[24]=[w("编辑",-1)])]),_:1},8,["onClick"]),a(m,{size:"small",type:"info",onClick:y=>ke(l)},{default:o(()=>[...e[25]||(e[25]=[w("配置资源方",-1)])]),_:1},8,["onClick"]),a(m,{size:"small",type:"danger",onClick:y=>Se(l)},{default:o(()=>[...e[26]||(e[26]=[w("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[j,L.value]]),a(i,{"current-page":B.value,"onUpdate:currentPage":e[1]||(e[1]=l=>B.value=l),"page-size":Z.value,"onUpdate:pageSize":e[2]||(e[2]=l=>Z.value=l),"page-sizes":[10,20,50,100],total:ee.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:k,onCurrentChange:k},null,8,["current-page","page-size","total"])]),_:1}),a(q,{modelValue:$.value,"onUpdate:modelValue":e[11]||(e[11]=l=>$.value=l),title:ge.value,width:"600px",onClose:ae},{footer:o(()=>[a(m,{onClick:e[10]||(e[10]=l=>$.value=!1)},{default:o(()=>[...e[30]||(e[30]=[w("取消",-1)])]),_:1}),a(m,{type:"primary",onClick:Ue,loading:K.value},{default:o(()=>[...e[31]||(e[31]=[w("确定",-1)])]),_:1},8,["loading"])]),default:o(()=>[a(R,{ref_key:"formRef",ref:A,model:u.value,rules:_e,"label-width":"120px"},{default:o(()=>[a(d,{label:"景区名称",prop:"name"},{default:o(()=>[a(n,{modelValue:u.value.name,"onUpdate:modelValue":e[3]||(e[3]=l=>u.value.name=l),placeholder:"请输入景区名称"},null,8,["modelValue"])]),_:1}),H.value?(b(),z(d,{key:0,label:"景区编码",prop:"code"},{default:o(()=>[a(n,{modelValue:u.value.code,"onUpdate:modelValue":e[4]||(e[4]=l=>u.value.code=l),placeholder:"系统自动生成",disabled:""},null,8,["modelValue"]),e[27]||(e[27]=x("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 景区编码由系统自动生成，不可修改 ",-1))]),_:1})):(b(),z(d,{key:1},{label:o(()=>[...e[28]||(e[28]=[x("span",null,"景区编码",-1)])]),default:o(()=>[a(n,{value:"系统自动生成",disabled:""}),e[29]||(e[29]=x("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 景区编码将在创建时由系统自动生成 ",-1))]),_:1})),a(d,{label:"地址",prop:"address"},{default:o(()=>[a(n,{modelValue:u.value.address,"onUpdate:modelValue":e[5]||(e[5]=l=>u.value.address=l),placeholder:"请输入景区地址"},null,8,["modelValue"])]),_:1}),a(d,{label:"联系电话",prop:"contact_phone"},{default:o(()=>[a(n,{modelValue:u.value.contact_phone,"onUpdate:modelValue":e[6]||(e[6]=l=>u.value.contact_phone=l),placeholder:"请输入联系电话"},null,8,["modelValue"])]),_:1}),a(d,{label:"软件服务商",prop:"software_provider_id"},{default:o(()=>[a(C,{modelValue:u.value.software_provider_id,"onUpdate:modelValue":e[7]||(e[7]=l=>u.value.software_provider_id=l),placeholder:"请选择软件服务商",clearable:"",style:{width:"100%"}},{default:o(()=>[(b(!0),N(J,null,Q(M.value,l=>(b(),z(g,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"描述",prop:"description"},{default:o(()=>[a(n,{modelValue:u.value.description,"onUpdate:modelValue":e[8]||(e[8]=l=>u.value.description=l),type:"textarea",rows:4,placeholder:"请输入景区描述"},null,8,["modelValue"])]),_:1}),a(d,{label:"状态",prop:"is_active"},{default:o(()=>[a(I,{modelValue:u.value.is_active,"onUpdate:modelValue":e[9]||(e[9]=l=>u.value.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(q,{modelValue:E.value,"onUpdate:modelValue":e[22]||(e[22]=l=>E.value=l),title:"资源配置",width:"800px",onClose:oe},{footer:o(()=>[a(m,{onClick:e[21]||(e[21]=l=>E.value=!1)},{default:o(()=>[...e[38]||(e[38]=[w("取消",-1)])]),_:1}),a(m,{type:"primary",onClick:ze,loading:G.value},{default:o(()=>[...e[39]||(e[39]=[w("保存",-1)])]),_:1},8,["loading"])]),default:o(()=>[a(X,{title:"重要提示",type:"warning",description:"不同OTA平台的订单需要使用不同的用户名和密码。请为每个OTA平台配置对应的认证信息。",closable:!1,style:{"margin-bottom":"20px"}}),a(R,{ref_key:"resourceConfigFormRef",ref:F,model:r.value,rules:ye,"label-width":"140px"},{default:o(()=>[a(d,{label:"接口地址",prop:"api_url"},{default:o(()=>[a(n,{modelValue:r.value.api_url,"onUpdate:modelValue":e[12]||(e[12]=l=>r.value.api_url=l),placeholder:"例如：https://e.hengdianworld.com/Interface/hotel_order.aspx"},null,8,["modelValue"])]),_:1}),a(d,{label:"默认用户名",prop:"username"},{default:o(()=>[a(n,{modelValue:r.value.username,"onUpdate:modelValue":e[13]||(e[13]=l=>r.value.username=l),placeholder:"用于库存推送订阅等非订单场景"},null,8,["modelValue"])]),_:1}),a(d,{label:"默认密码",prop:"password"},{default:o(()=>[a(n,{modelValue:r.value.password,"onUpdate:modelValue":e[14]||(e[14]=l=>r.value.password=l),type:"password","show-password":"",placeholder:"用于库存推送订阅等非订单场景"},null,8,["modelValue"])]),_:1}),a(d,{label:"环境",prop:"environment"},{default:o(()=>[a(C,{modelValue:r.value.environment,"onUpdate:modelValue":e[15]||(e[15]=l=>r.value.environment=l),style:{width:"100%"}},{default:o(()=>[a(g,{label:"生产环境",value:"production"})]),_:1},8,["modelValue"])]),_:1}),a(O,null,{default:o(()=>[...e[32]||(e[32]=[w("同步方式配置",-1)])]),_:1}),a(d,{label:"库存同步方式",prop:"sync_mode.inventory"},{default:o(()=>[a(C,{modelValue:r.value.sync_mode.inventory,"onUpdate:modelValue":e[16]||(e[16]=l=>r.value.sync_mode.inventory=l),style:{width:"100%"}},{default:o(()=>[a(g,{label:"资源方推送",value:"push"}),a(g,{label:"手工维护",value:"manual"})]),_:1},8,["modelValue"]),e[33]||(e[33]=x("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}},' 选择"资源方推送"后，系统将自动接收资源方推送的库存信息 ',-1))]),_:1}),a(d,{label:"价格同步方式",prop:"sync_mode.price"},{default:o(()=>[a(C,{modelValue:r.value.sync_mode.price,"onUpdate:modelValue":e[17]||(e[17]=l=>r.value.sync_mode.price=l),style:{width:"100%"}},{default:o(()=>[a(g,{label:"资源方推送",value:"push"}),a(g,{label:"手工维护",value:"manual"})]),_:1},8,["modelValue"]),e[34]||(e[34]=x("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}},' 选择"资源方推送"后，系统将自动接收资源方推送的价格信息 ',-1))]),_:1}),a(d,{label:"订单处理方式",prop:"sync_mode.order"},{default:o(()=>[a(C,{modelValue:r.value.sync_mode.order,"onUpdate:modelValue":e[18]||(e[18]=l=>r.value.sync_mode.order=l),style:{width:"100%"}},{default:o(()=>[a(g,{label:"系统直连",value:"auto"}),a(g,{label:"手工操作",value:"manual"}),a(g,{label:"其他系统",value:"other"})]),_:1},8,["modelValue"]),e[35]||(e[35]=x("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}},' 选择"系统直连"后，订单将自动调用资源方接口；选择"其他系统"需要指定系统服务商 ',-1))]),_:1}),r.value.sync_mode.order==="other"?(b(),z(d,{key:0,label:"订单系统服务商",prop:"order_provider"},{default:o(()=>[a(C,{modelValue:r.value.order_provider,"onUpdate:modelValue":e[19]||(e[19]=l=>r.value.order_provider=l),placeholder:"请选择系统服务商",style:{width:"100%"}},{default:o(()=>[(b(!0),N(J,null,Q(M.value,l=>(b(),z(g,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):Oe("",!0),a(O,null,{default:o(()=>[...e[36]||(e[36]=[w("OTA平台认证信息",-1)])]),_:1}),(b(!0),N(J,null,Q(Y.value,l=>(b(),z(d,{key:l.id,label:`${l.name}认证信息`},{default:o(()=>[x("div",De,[a(n,{modelValue:r.value.credentials[l.code].username,"onUpdate:modelValue":y=>r.value.credentials[l.code].username=y,placeholder:"用户名",style:{flex:"1"}},null,8,["modelValue","onUpdate:modelValue"]),a(n,{modelValue:r.value.credentials[l.code].password,"onUpdate:modelValue":y=>r.value.credentials[l.code].password=y,type:"password",placeholder:"密码",style:{flex:"1"},"show-password":""},null,8,["modelValue","onUpdate:modelValue"])]),e[37]||(e[37]=x("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}}," 该平台订单将使用此认证信息调用资源方接口 ",-1))]),_:2},1032,["label"]))),128)),a(d,{label:"状态",prop:"is_active"},{default:o(()=>[a(I,{modelValue:r.value.is_active,"onUpdate:modelValue":e[20]||(e[20]=l=>r.value.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},je=$e(Fe,[["__scopeId","data-v-8986073e"]]);export{je as default};
