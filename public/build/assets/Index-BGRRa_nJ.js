import{_ as de,r as i,x as A,i as pe,c as z,o as p,f as R,b as a,w as o,d as u,j as V,E as g,k as me,l as ce,h as m,p as ve,z as _e,n as x,t as U,s as I,F as G,y as H,v as ge}from"./app-ZhZD_hbr.js";const fe={style:{"margin-bottom":"20px"}},be={key:0,style:{color:"#909399"}},ye={key:0,style:{"margin-left":"10px",color:"#909399","font-size":"12px"}},Ve={__name:"Index",setup(xe){const T=i([]),M=i([]),N=i(!1),q=i(!1),b=i(!1),S=i(null),E=i(""),$=i(null),B=i(null),w=i(1),F=i(15),j=i(0),h=i(null),L=i(null),v=A(()=>h.value!==null),J=A(()=>v.value?"编辑用户":"创建用户"),s=i({name:"",email:"",password:"",role:"operator",scenic_spot_ids:[],is_active:!0}),O={name:[{required:!0,message:"请输入姓名",trigger:"blur"},{max:255,message:"姓名不能超过255个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:8,message:"密码至少8位",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}],scenic_spot_ids:[{validator:(t,e,n)=>{s.value.role==="operator"&&(!e||e.length===0)?n(new Error("运营用户必须绑定至少一个景区")):n()},trigger:"change"}]},_=async()=>{N.value=!0;try{const t={page:w.value,per_page:F.value};$.value&&(t.role=$.value),B.value!==null&&(t.is_active=B.value),E.value&&(t.search=E.value);const e=await V.get("/users",{params:t});T.value=e.data.data||[],j.value=e.data.total||0}catch(t){g.error("获取用户列表失败"),console.error(t)}finally{N.value=!1}},Q=async()=>{try{const t=await V.get("/scenic-spots");M.value=t.data.data||[]}catch(t){console.error("获取景区列表失败",t)}},W=()=>{w.value=1,_()},P=()=>{w.value=1,_()},X=()=>{h.value=null,K(),b.value=!0},Y=t=>{var e;h.value=t.id,L.value=t.role,s.value={name:t.name,email:t.email,password:"",role:t.role,scenic_spot_ids:((e=t.scenic_spots)==null?void 0:e.map(n=>n.id))||[],is_active:t.is_active},b.value=!0},Z=async()=>{S.value&&await S.value.validate(async t=>{var e,n,d,c,D,f;if(t){q.value=!0;try{const r={...s.value};v.value&&!r.password&&delete r.password,r.role==="admin"&&(r.scenic_spot_ids=[]),v.value?(await V.put(`/users/${h.value}`,r),g.success("用户更新成功")):(await V.post("/users",r),g.success("用户创建成功")),b.value=!1,_()}catch(r){const k=((n=(e=r.response)==null?void 0:e.data)==null?void 0:n.message)||((f=(D=(c=(d=r.response)==null?void 0:d.data)==null?void 0:c.errors)==null?void 0:D.email)==null?void 0:f[0])||"操作失败";g.error(k)}finally{q.value=!1}}})},ee=async t=>{var e,n;try{await ge.confirm(`确定要禁用用户"${t.name}"吗？禁用后该用户将无法登录系统。`,"提示",{type:"warning",confirmButtonText:"确定禁用",cancelButtonText:"取消"}),await V.post(`/users/${t.id}/disable`),g.success("用户已禁用"),_()}catch(d){if(d!=="cancel"){const c=((n=(e=d.response)==null?void 0:e.data)==null?void 0:n.message)||"操作失败";g.error(c)}}},le=async t=>{try{await V.post(`/users/${t.id}/enable`),g.success("用户已启用"),_()}catch(e){g.error("操作失败"),console.error(e)}},K=()=>{var t;h.value=null,L.value=null,s.value={name:"",email:"",password:"",role:"operator",scenic_spot_ids:[],is_active:!0},(t=S.value)==null||t.clearValidate()},ae=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"";return pe(()=>{_(),Q()}),(t,e)=>{const n=u("el-button"),d=u("el-option"),c=u("el-select"),D=u("el-icon"),f=u("el-input"),r=u("el-table-column"),k=u("el-tag"),te=u("el-table"),oe=u("el-pagination"),se=u("el-card"),y=u("el-form-item"),ne=u("el-switch"),re=u("el-form"),ie=u("el-dialog"),ue=me("loading");return p(),z("div",null,[e[20]||(e[20]=R("h2",null,"用户管理",-1)),a(se,null,{default:o(()=>[R("div",fe,[a(n,{type:"primary",onClick:X},{default:o(()=>[...e[13]||(e[13]=[m("创建用户",-1)])]),_:1}),a(c,{modelValue:$.value,"onUpdate:modelValue":e[0]||(e[0]=l=>$.value=l),placeholder:"筛选角色",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:P},{default:o(()=>[a(d,{label:"超级管理员",value:"admin"}),a(d,{label:"运营",value:"operator"})]),_:1},8,["modelValue"]),a(c,{modelValue:B.value,"onUpdate:modelValue":e[1]||(e[1]=l=>B.value=l),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:P},{default:o(()=>[a(d,{label:"启用",value:!0}),a(d,{label:"禁用",value:!1})]),_:1},8,["modelValue"]),a(f,{modelValue:E.value,"onUpdate:modelValue":e[2]||(e[2]=l=>E.value=l),placeholder:"搜索姓名或邮箱",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:W},{prefix:o(()=>[a(D,null,{default:o(()=>[a(ve(_e))]),_:1})]),_:1},8,["modelValue"])]),ce((p(),x(te,{data:T.value,border:""},{default:o(()=>[a(r,{prop:"name",label:"姓名",width:"150"}),a(r,{prop:"email",label:"邮箱",width:"200"}),a(r,{prop:"role",label:"角色",width:"120"},{default:o(({row:l})=>[a(k,{type:l.role==="admin"?"danger":"primary"},{default:o(()=>[m(U(l.role==="admin"?"超级管理员":"运营"),1)]),_:2},1032,["type"])]),_:1}),a(r,{label:"绑定景区",width:"200"},{default:o(({row:l})=>[(p(!0),z(G,null,H(l.scenic_spots||[],C=>(p(),x(k,{key:C.id,size:"small",style:{"margin-right":"5px","margin-bottom":"5px"}},{default:o(()=>[m(U(C.name),1)]),_:2},1024))),128)),!l.scenic_spots||l.scenic_spots.length===0?(p(),z("span",be,U(l.role==="admin"?"全部景区":"未绑定"),1)):I("",!0)]),_:1}),a(r,{prop:"is_active",label:"状态",width:"100"},{default:o(({row:l})=>[a(k,{type:l.is_active?"success":"danger"},{default:o(()=>[m(U(l.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(r,{prop:"created_at",label:"创建时间",width:"180"},{default:o(({row:l})=>[m(U(ae(l.created_at)),1)]),_:1}),a(r,{label:"操作",width:"250",fixed:"right"},{default:o(({row:l})=>[a(n,{size:"small",onClick:C=>Y(l)},{default:o(()=>[...e[14]||(e[14]=[m("编辑",-1)])]),_:1},8,["onClick"]),l.is_active&&l.role!=="admin"?(p(),x(n,{key:0,size:"small",type:"warning",onClick:C=>ee(l)},{default:o(()=>[...e[15]||(e[15]=[m(" 禁用 ",-1)])]),_:1},8,["onClick"])):l.is_active?I("",!0):(p(),x(n,{key:1,size:"small",type:"success",onClick:C=>le(l)},{default:o(()=>[...e[16]||(e[16]=[m(" 启用 ",-1)])]),_:1},8,["onClick"]))]),_:1})]),_:1},8,["data"])),[[ue,N.value]]),a(oe,{"current-page":w.value,"onUpdate:currentPage":e[3]||(e[3]=l=>w.value=l),"page-size":F.value,"onUpdate:pageSize":e[4]||(e[4]=l=>F.value=l),"page-sizes":[10,20,50,100],total:j.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:_,onCurrentChange:_},null,8,["current-page","page-size","total"])]),_:1}),a(ie,{modelValue:b.value,"onUpdate:modelValue":e[12]||(e[12]=l=>b.value=l),title:J.value,width:"600px",onClose:K},{footer:o(()=>[a(n,{onClick:e[11]||(e[11]=l=>b.value=!1)},{default:o(()=>[...e[18]||(e[18]=[m("取消",-1)])]),_:1}),a(n,{type:"primary",onClick:Z,loading:q.value},{default:o(()=>[...e[19]||(e[19]=[m("确定",-1)])]),_:1},8,["loading"])]),default:o(()=>[a(re,{ref_key:"formRef",ref:S,model:s.value,rules:O,"label-width":"120px"},{default:o(()=>[a(y,{label:"姓名",prop:"name"},{default:o(()=>[a(f,{modelValue:s.value.name,"onUpdate:modelValue":e[5]||(e[5]=l=>s.value.name=l),placeholder:"请输入姓名"},null,8,["modelValue"])]),_:1}),a(y,{label:"邮箱",prop:"email"},{default:o(()=>[a(f,{modelValue:s.value.email,"onUpdate:modelValue":e[6]||(e[6]=l=>s.value.email=l),placeholder:"请输入邮箱",disabled:v.value},null,8,["modelValue","disabled"])]),_:1}),a(y,{label:"密码",prop:v.value?"":"password"},{default:o(()=>[a(f,{modelValue:s.value.password,"onUpdate:modelValue":e[7]||(e[7]=l=>s.value.password=l),type:"password",placeholder:v.value?"留空则不修改密码":"请输入密码（至少8位）","show-password":""},null,8,["modelValue","placeholder"])]),_:1},8,["prop"]),a(y,{label:"角色",prop:"role"},{default:o(()=>[a(c,{modelValue:s.value.role,"onUpdate:modelValue":e[8]||(e[8]=l=>s.value.role=l),placeholder:"请选择角色",style:{width:"100%"},disabled:v.value&&s.value.role==="admin"},{default:o(()=>[a(d,{label:"超级管理员",value:"admin"}),a(d,{label:"运营",value:"operator"})]),_:1},8,["modelValue","disabled"]),v.value&&s.value.role==="admin"?(p(),z("span",ye," 不能修改超级管理员角色 ")):I("",!0)]),_:1}),s.value.role==="operator"?(p(),x(y,{key:0,label:"绑定景区",prop:"scenic_spot_ids"},{default:o(()=>[a(c,{modelValue:s.value.scenic_spot_ids,"onUpdate:modelValue":e[9]||(e[9]=l=>s.value.scenic_spot_ids=l),placeholder:"请选择绑定的景区（可多选）",multiple:"",style:{width:"100%"}},{default:o(()=>[(p(!0),z(G,null,H(M.value,l=>(p(),x(d,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[17]||(e[17]=R("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 运营用户必须绑定至少一个景区 ",-1))]),_:1})):I("",!0),a(y,{label:"状态",prop:"is_active"},{default:o(()=>[a(ne,{modelValue:s.value.is_active,"onUpdate:modelValue":e[10]||(e[10]=l=>s.value.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},he=de(Ve,[["__scopeId","data-v-4f5958b3"]]);export{he as default};
