import{_ as Ee,u as Te,r as p,x as de,i as Re,c as _,o as r,f as $,b as a,w as s,d as c,k as f,E as x,e as He,l as Ie,m as Fe,h as m,F as b,p as h,q as k,y as T,z as Ne,t as C,s as Pe,C as ue,D as re,v as Ke}from"./app-CQIcOIsZ.js";const je={style:{"margin-bottom":"20px"}},Ae={key:0},Le={key:1},Ge={key:0},Je={key:0},Oe={key:1},Qe={style:{width:"100%"}},We={style:{width:"100%"}},Xe={__name:"Index",setup(Ze){const R=Te(),O=He(),Q=p([]),U=p([]),K=p(!1),H=p(""),I=p(null),F=p(null),D=p(1),j=p(15),W=p(0),S=p(!1),A=p(!1),Y=p(null),N=p(null),n=p({scenic_spot_id:null,product_name:"",stay_days:1,description:"",status:1,sale_start_date:null,sale_end_date:null,bundle_items:[],hotel_room_types:[]}),z=p([]),q=p([]),M=p([]),P=de(()=>N.value!==null),ie=de(()=>P.value?"编辑打包产品":"创建打包产品"),pe={scenic_spot_id:[{required:!0,message:"请选择所属景区",trigger:"change"}],product_name:[{required:!0,message:"请输入产品名称",trigger:"blur"},{max:100,message:"产品名称不能超过100个字符",trigger:"blur"}],stay_days:[{required:!0,message:"请输入入住天数",trigger:"blur"},{type:"number",min:1,max:30,message:"入住天数必须在1-30天之间",trigger:"blur"}],bundle_items:[{validator:(l,e,o)=>{if(!e||e.length===0)o(new Error("请至少添加一个关联门票"));else{const d=e.map(V=>V.ticket_id),v=[...new Set(d)];d.length!==v.length?o(new Error("不能添加重复的门票")):o()}},trigger:"change"}],hotel_room_types:[{validator:(l,e,o)=>{if(!e||e.length===0)o(new Error("请至少添加一个关联酒店房型"));else{const d=e.map(V=>`${V.hotel_id}_${V.room_type_id}`),v=[...new Set(d)];d.length!==v.length?o(new Error("不能添加重复的酒店房型组合")):o()}},trigger:"change"}],sale_start_date:[{type:"date",message:"请选择有效的日期",trigger:"change"}],sale_end_date:[{type:"date",message:"请选择有效的日期",trigger:"change"},{validator:(l,e,o)=>{e&&n.value.sale_start_date&&new Date(e)<new Date(n.value.sale_start_date)?o(new Error("销售结束日期不能早于销售开始日期")):o()},trigger:"change"}]},w=async()=>{K.value=!0;try{const l={page:D.value,per_page:j.value};I.value&&(l.scenic_spot_id=I.value),F.value!==null&&(l.status=F.value),H.value&&(l.search=H.value);const e=await f.get("/pkg-products",{params:l});Q.value=e.data.data||[],W.value=e.data.total||0}catch(l){x.error("获取打包产品列表失败"),console.error(l)}finally{K.value=!1}},_e=async()=>{var l,e,o;try{if(((l=R.user)==null?void 0:l.role)!=="admin")U.value=((e=R.user)==null?void 0:e.scenic_spots)||[];else{const d=await f.get("/scenic-spots");U.value=d.data.data||[]}}catch(d){console.error("获取景区列表失败",d),(o=R.user)!=null&&o.scenic_spots&&(U.value=R.user.scenic_spots)}},ce=()=>{D.value=1,w()},X=()=>{D.value=1,w()},me=()=>{N.value=null,le(),S.value=!0},ve=l=>{O.push(`/pkg-products/${l.id}/detail`)},ye=l=>{O.push(`/pkg-products/${l.id}/price-management`)},ge=async l=>{N.value=l.id;try{const o=(await f.get(`/pkg-products/${l.id}`)).data.data;n.value={scenic_spot_id:o.scenic_spot_id,product_name:o.product_name,stay_days:o.stay_days||1,description:o.description||"",status:o.status,sale_start_date:o.sale_start_date||null,sale_end_date:o.sale_end_date||null,bundle_items:(o.bundle_items||[]).map(d=>({ticket_id:d.ticket_id,quantity:d.quantity||1})),hotel_room_types:(o.hotel_room_types||[]).map(d=>({hotel_id:d.hotel_id,room_type_id:d.room_type_id}))},n.value.scenic_spot_id&&(await Z(n.value.scenic_spot_id),await ee(n.value.scenic_spot_id),await te()),S.value=!0}catch(e){x.error("获取产品信息失败"),console.error(e)}},fe=async l=>{var e,o;try{await Ke.confirm(`确定要删除打包产品"${l.product_name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await f.delete(`/pkg-products/${l.id}`),x.success("删除成功"),w()}catch(d){if(d!=="cancel"){const v=((o=(e=d.response)==null?void 0:e.data)==null?void 0:o.message)||"删除失败";x.error(v)}}},be=l=>{if(!l)return"";const e=new Date(l),o=e.getFullYear(),d=String(e.getMonth()+1).padStart(2,"0"),v=String(e.getDate()).padStart(2,"0"),V=String(e.getHours()).padStart(2,"0"),B=String(e.getMinutes()).padStart(2,"0");return`${o}-${d}-${v} ${V}:${B}`},he=()=>{n.value.bundle_items.push({ticket_id:null,quantity:1})},Ve=l=>{n.value.bundle_items.splice(l,1),L()},L=()=>{var l;(l=Y.value)==null||l.validateField("bundle_items")},ke=()=>{n.value.hotel_room_types.push({hotel_id:null,room_type_id:null})},we=l=>{n.value.hotel_room_types.splice(l,1),G()},xe=l=>{n.value.hotel_room_types[l].room_type_id=null,G()},G=()=>{var l;(l=Y.value)==null||l.validateField("hotel_room_types")},Ce=l=>l?M.value.filter(e=>e.hotel_id===l&&e.is_active):[],Se=async l=>{l?(await Z(l),await ee(l),await te()):(z.value=[],q.value=[],M.value=[])},Z=async l=>{try{const e=await f.get("/tickets",{params:{scenic_spot_id:l,is_active:!0,per_page:1e3}});z.value=e.data.data||[]}catch(e){console.error("获取门票列表失败",e),z.value=[]}},ee=async l=>{try{const e=await f.get("/res-hotels",{params:{scenic_spot_id:l,is_active:!0,per_page:1e3}});q.value=e.data.data||[]}catch(e){console.error("获取酒店列表失败",e),q.value=[]}},te=async()=>{try{const l=await f.get("/res-room-types",{params:{is_active:!0,per_page:1e3}});M.value=l.data.data||[]}catch(l){console.error("获取房型列表失败",l),M.value=[]}},$e=async()=>{var l,e;try{await Y.value.validate(),A.value=!0;const o={scenic_spot_id:n.value.scenic_spot_id,product_name:n.value.product_name,stay_days:n.value.stay_days,description:n.value.description||"",status:n.value.status,sale_start_date:n.value.sale_start_date||null,sale_end_date:n.value.sale_end_date||null,bundle_items:n.value.bundle_items.map(d=>({ticket_id:d.ticket_id,quantity:d.quantity||1})),hotel_room_types:n.value.hotel_room_types.map(d=>({hotel_id:d.hotel_id,room_type_id:d.room_type_id}))};P.value?(await f.put(`/pkg-products/${N.value}`,o),x.success("更新成功")):(await f.post("/pkg-products",o),x.success("创建成功")),S.value=!1,w()}catch(o){if(o!==!1){const d=((e=(l=o.response)==null?void 0:l.data)==null?void 0:e.message)||(P.value?"更新失败":"创建失败");x.error(d),console.error(o)}}finally{A.value=!1}},le=()=>{var l;n.value={scenic_spot_id:null,product_name:"",stay_days:1,description:"",status:1,sale_start_date:null,sale_end_date:null,bundle_items:[],hotel_room_types:[]},z.value=[],q.value=[],M.value=[],(l=Y.value)==null||l.clearValidate()};return Re(()=>{w(),_e()}),(l,e)=>{const o=c("el-button"),d=c("el-option"),v=c("el-select"),V=c("el-icon"),B=c("el-input"),y=c("el-table-column"),J=c("el-tag"),Ue=c("el-table"),De=c("el-pagination"),Ye=c("el-card"),g=c("el-form-item"),ae=c("el-input-number"),oe=c("el-radio"),ze=c("el-radio-group"),se=c("el-date-picker"),qe=c("el-form"),Me=c("el-dialog"),Be=Ie("loading");return r(),_("div",null,[e[27]||(e[27]=$("h2",null,"打包产品管理",-1)),a(Ye,null,{default:s(()=>[$("div",je,[a(o,{type:"primary",onClick:me},{default:s(()=>[...e[14]||(e[14]=[m("创建打包产品",-1)])]),_:1}),a(v,{modelValue:I.value,"onUpdate:modelValue":e[0]||(e[0]=t=>I.value=t),placeholder:"筛选景区",clearable:"",style:{width:"200px","margin-left":"10px"},onChange:X},{default:s(()=>[(r(!0),_(b,null,h(U.value,t=>(r(),k(d,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(v,{modelValue:F.value,"onUpdate:modelValue":e[1]||(e[1]=t=>F.value=t),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:X},{default:s(()=>[a(d,{label:"启用",value:1}),a(d,{label:"禁用",value:0})]),_:1},8,["modelValue"]),a(B,{modelValue:H.value,"onUpdate:modelValue":e[2]||(e[2]=t=>H.value=t),placeholder:"搜索产品名称或编码",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:ce},{prefix:s(()=>[a(V,null,{default:s(()=>[a(T(Ne))]),_:1})]),_:1},8,["modelValue"])]),Fe((r(),k(Ue,{data:Q.value,border:""},{default:s(()=>[a(y,{prop:"product_name",label:"产品名称",width:"200"}),a(y,{prop:"product_code",label:"产品编码",width:"150"}),a(y,{label:"所属景区",width:"150"},{default:s(({row:t})=>{var i;return[m(C(((i=t.scenic_spot)==null?void 0:i.name)||"-"),1)]}),_:1}),a(y,{label:"关联门票",width:"200"},{default:s(({row:t})=>[t.bundle_items&&t.bundle_items.length>0?(r(),_("div",Ae,[(r(!0),_(b,null,h(t.bundle_items,(i,u)=>(r(),k(J,{key:u,size:"small",style:{"margin-right":"5px"}},{default:s(()=>{var E;return[m(C(((E=i.ticket)==null?void 0:E.name)||"未知")+" x"+C(i.quantity||1),1)]}),_:2},1024))),128))])):(r(),_("span",Le,"-"))]),_:1}),a(y,{label:"关联酒店房型",width:"200"},{default:s(({row:t})=>[t.hotel_room_types&&t.hotel_room_types.length>0?(r(),_("div",Ge,[(r(!0),_(b,null,h(t.hotel_room_types.slice(0,2),(i,u)=>(r(),k(J,{key:u,size:"small",style:{"margin-right":"5px"}},{default:s(()=>{var E,ne;return[m(C(((E=i.hotel)==null?void 0:E.name)||"未知")+"-"+C(((ne=i.room_type)==null?void 0:ne.name)||"未知"),1)]}),_:2},1024))),128)),t.hotel_room_types.length>2?(r(),_("span",Je,"...")):Pe("",!0)])):(r(),_("span",Oe,"-"))]),_:1}),a(y,{prop:"stay_days",label:"入住天数",width:"100"}),a(y,{prop:"description",label:"描述","show-overflow-tooltip":""}),a(y,{prop:"status",label:"状态",width:"100"},{default:s(({row:t})=>[a(J,{type:t.status===1?"success":"danger"},{default:s(()=>[m(C(t.status===1?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(y,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:t})=>[m(C(be(t.created_at)),1)]),_:1}),a(y,{label:"操作",width:"280",fixed:"right"},{default:s(({row:t})=>[a(o,{size:"small",onClick:i=>ve(t)},{default:s(()=>[...e[15]||(e[15]=[m("详情",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",type:"primary",onClick:i=>ye(t)},{default:s(()=>[...e[16]||(e[16]=[m("价格管理",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",onClick:i=>ge(t)},{default:s(()=>[...e[17]||(e[17]=[m("编辑",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",type:"danger",onClick:i=>fe(t)},{default:s(()=>[...e[18]||(e[18]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Be,K.value]]),a(De,{"current-page":D.value,"onUpdate:currentPage":e[3]||(e[3]=t=>D.value=t),"page-size":j.value,"onUpdate:pageSize":e[4]||(e[4]=t=>j.value=t),"page-sizes":[10,20,50,100],total:W.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:w,onCurrentChange:w},null,8,["current-page","page-size","total"])]),_:1}),a(Me,{modelValue:S.value,"onUpdate:modelValue":e[13]||(e[13]=t=>S.value=t),title:ie.value,width:"900px",onClose:le},{footer:s(()=>[a(o,{onClick:e[12]||(e[12]=t=>S.value=!1)},{default:s(()=>[...e[25]||(e[25]=[m("取消",-1)])]),_:1}),a(o,{type:"primary",onClick:$e,loading:A.value},{default:s(()=>[...e[26]||(e[26]=[m("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[a(qe,{ref_key:"formRef",ref:Y,model:n.value,rules:pe,"label-width":"120px"},{default:s(()=>[a(g,{label:"所属景区",prop:"scenic_spot_id"},{default:s(()=>[a(v,{modelValue:n.value.scenic_spot_id,"onUpdate:modelValue":e[5]||(e[5]=t=>n.value.scenic_spot_id=t),placeholder:"请选择景区",style:{width:"100%"},disabled:P.value,onChange:Se},{default:s(()=>[(r(!0),_(b,null,h(U.value,t=>(r(),k(d,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),a(g,{label:"产品名称",prop:"product_name"},{default:s(()=>[a(B,{modelValue:n.value.product_name,"onUpdate:modelValue":e[6]||(e[6]=t=>n.value.product_name=t),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),a(g,{label:"入住天数",prop:"stay_days"},{default:s(()=>[a(ae,{modelValue:n.value.stay_days,"onUpdate:modelValue":e[7]||(e[7]=t=>n.value.stay_days=t),min:1,max:30,style:{width:"100%"},placeholder:"请输入入住天数"},null,8,["modelValue"])]),_:1}),a(g,{label:"描述",prop:"description"},{default:s(()=>[a(B,{modelValue:n.value.description,"onUpdate:modelValue":e[8]||(e[8]=t=>n.value.description=t),type:"textarea",rows:3,placeholder:"请输入描述"},null,8,["modelValue"])]),_:1}),a(g,{label:"状态",prop:"status"},{default:s(()=>[a(ze,{modelValue:n.value.status,"onUpdate:modelValue":e[9]||(e[9]=t=>n.value.status=t)},{default:s(()=>[a(oe,{label:1},{default:s(()=>[...e[19]||(e[19]=[m("启用",-1)])]),_:1}),a(oe,{label:0},{default:s(()=>[...e[20]||(e[20]=[m("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(g,{label:"销售开始日期",prop:"sale_start_date"},{default:s(()=>[a(se,{modelValue:n.value.sale_start_date,"onUpdate:modelValue":e[10]||(e[10]=t=>n.value.sale_start_date=t),type:"date",placeholder:"选择销售开始日期（可选）",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"]),e[21]||(e[21]=$("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}}," 不设置表示不限制开始日期 ",-1))]),_:1}),a(g,{label:"销售结束日期",prop:"sale_end_date"},{default:s(()=>[a(se,{modelValue:n.value.sale_end_date,"onUpdate:modelValue":e[11]||(e[11]=t=>n.value.sale_end_date=t),type:"date",placeholder:"选择销售结束日期（可选）",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD","disabled-date":t=>n.value.sale_start_date&&t<new Date(n.value.sale_start_date),style:{width:"100%"}},null,8,["modelValue","disabled-date"]),e[22]||(e[22]=$("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}}," 不设置表示不限制结束日期 ",-1))]),_:1}),a(g,{label:"关联门票",prop:"bundle_items"},{default:s(()=>[$("div",Qe,[(r(!0),_(b,null,h(n.value.bundle_items,(t,i)=>(r(),_("div",{key:i,style:{display:"flex",gap:"10px","margin-bottom":"10px","align-items":"center"}},[a(v,{modelValue:t.ticket_id,"onUpdate:modelValue":u=>t.ticket_id=u,placeholder:"选择门票",style:{flex:"1"},filterable:"",onChange:L},{default:s(()=>[(r(!0),_(b,null,h(z.value,u=>(r(),k(d,{key:u.id,label:`${u.name} (${u.code})`,value:u.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),a(ae,{modelValue:t.quantity,"onUpdate:modelValue":u=>t.quantity=u,min:1,max:10,placeholder:"数量",style:{width:"120px"},onChange:L},null,8,["modelValue","onUpdate:modelValue"]),a(o,{type:"danger",icon:T(ue),circle:"",onClick:u=>Ve(i)},null,8,["icon","onClick"])]))),128)),a(o,{type:"primary",icon:T(re),onClick:he,disabled:!n.value.scenic_spot_id},{default:s(()=>[...e[23]||(e[23]=[m(" 添加门票 ",-1)])]),_:1},8,["icon","disabled"])])]),_:1}),a(g,{label:"关联酒店房型",prop:"hotel_room_types"},{default:s(()=>[$("div",We,[(r(!0),_(b,null,h(n.value.hotel_room_types,(t,i)=>(r(),_("div",{key:i,style:{display:"flex",gap:"10px","margin-bottom":"10px","align-items":"center"}},[a(v,{modelValue:t.hotel_id,"onUpdate:modelValue":u=>t.hotel_id=u,placeholder:"选择酒店",style:{flex:"1"},filterable:"",onChange:u=>xe(i)},{default:s(()=>[(r(!0),_(b,null,h(q.value,u=>(r(),k(d,{key:u.id,label:u.name,value:u.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),a(v,{modelValue:t.room_type_id,"onUpdate:modelValue":u=>t.room_type_id=u,placeholder:"选择房型",style:{flex:"1"},filterable:"",disabled:!t.hotel_id,onChange:G},{default:s(()=>[(r(!0),_(b,null,h(Ce(t.hotel_id),u=>(r(),k(d,{key:u.id,label:u.name,value:u.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),a(o,{type:"danger",icon:T(ue),circle:"",onClick:u=>we(i)},null,8,["icon","onClick"])]))),128)),a(o,{type:"primary",icon:T(re),onClick:ke,disabled:!n.value.scenic_spot_id},{default:s(()=>[...e[24]||(e[24]=[m(" 添加酒店房型 ",-1)])]),_:1},8,["icon","disabled"])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},tt=Ee(Xe,[["__scopeId","data-v-92c82173"]]);export{tt as default};
