import{_ as ve,u as fe,r as i,x as K,i as ge,c as A,o as x,f as h,b as a,w as s,d as r,j as C,E as g,e as ye,k as be,l as Ve,h as m,F as Z,y as G,n as F,p as H,z as we,t as B,A as xe,v as he}from"./app-ZhZD_hbr.js";const Ce={style:{"margin-bottom":"20px"}},ke={__name:"Index",setup(De){const _=fe(),J=ye(),D=i([]),v=i([]),I=i(!1),R=i(!1),L=i({}),V=i(!1),U=i(null),S=i(""),z=i(null),Y=i(null),k=i(1),T=i(15),q=i(0),$=i(null),E=K(()=>$.value!==null),Q=K(()=>E.value?"编辑产品":"创建产品"),n=i({scenic_spot_id:null,name:"",code:"",description:"",price_source:"manual",stay_days:null,sale_start_date:null,sale_end_date:null,is_active:!0}),W={scenic_spot_id:[{required:!0,message:"请选择所属景区",trigger:"change"}],name:[{required:!0,message:"请输入产品名称",trigger:"blur"},{max:255,message:"产品名称不能超过255个字符",trigger:"blur"}],code:[{required:!0,message:"请输入产品编码",trigger:"blur"},{pattern:/^[a-zA-Z0-9_-]+$/,message:"产品编码只能包含字母、数字、下划线和连字符",trigger:"blur"}],price_source:[{required:!0,message:"请选择价格来源",trigger:"change"}],sale_start_date:[{required:!0,message:"请选择销售开始日期",trigger:"change"}],sale_end_date:[{validator:(t,e,o)=>{e?n.value.sale_start_date&&e<n.value.sale_start_date?o(new Error("销售结束日期不能早于开始日期")):o():o(new Error("请选择销售结束日期"))},trigger:"change"}]},y=async()=>{I.value=!0;try{const t={page:k.value,per_page:T.value};z.value&&(t.scenic_spot_id=z.value),Y.value!==null&&(t.is_active=Y.value),S.value&&(t.search=S.value);const e=await C.get("/products",{params:t});e.data&&e.data.data?(D.value=e.data.data||[],q.value=e.data.total||0):(D.value=e.data||[],q.value=D.value.length)}catch(t){g.error("获取产品列表失败"),console.error(t)}finally{I.value=!1}},N=async()=>{var t,e,o,u;try{if(((t=_.user)==null?void 0:t.role)!=="admin")(!_.user||!_.user.scenic_spots||_.user.scenic_spots.length===0)&&await _.fetchUser(),v.value=((e=_.user)==null?void 0:e.scenic_spots)||[],v.value.length===0&&console.warn("运营用户未绑定任何景区");else{const d=await C.get("/scenic-spots");v.value=d.data.data||[]}}catch(d){if(console.error("获取景区列表失败",d),(o=_.user)!=null&&o.scenic_spots&&_.user.scenic_spots.length>0)v.value=_.user.scenic_spots;else try{await _.fetchUser(),v.value=((u=_.user)==null?void 0:u.scenic_spots)||[]}catch(c){console.error("获取用户信息失败",c)}}},X=()=>{k.value=1,y()},O=()=>{k.value=1,y()},ee=async()=>{var t;if($.value=null,j(),v.value.length===0&&await N(),((t=_.user)==null?void 0:t.role)!=="admin"&&v.value.length===0){g.warning("您未绑定任何景区，请联系管理员为您分配景区");return}V.value=!0},le=t=>{J.push(`/products/${t.id}/detail`)},ae=t=>{$.value=t.id,n.value={scenic_spot_id:t.scenic_spot_id,name:t.name,code:t.code,description:t.description||"",price_source:t.price_source||"manual",stay_days:t.stay_days||null,sale_start_date:t.sale_start_date||null,sale_end_date:t.sale_end_date||null,is_active:t.is_active},V.value=!0},te=async()=>{U.value&&await U.value.validate(async t=>{var e,o,u,d,c,b;if(t){R.value=!0;try{const p={...n.value,stay_days:n.value.stay_days||null,sale_start_date:n.value.sale_start_date||null,sale_end_date:n.value.sale_end_date||null};E.value?(await C.put(`/products/${$.value}`,p),g.success("产品更新成功")):(await C.post("/products",p),g.success("产品创建成功")),V.value=!1,j(),setTimeout(()=>{y()},100)}catch(p){const M=((o=(e=p.response)==null?void 0:e.data)==null?void 0:o.message)||((b=(c=(d=(u=p.response)==null?void 0:u.data)==null?void 0:d.errors)==null?void 0:c.code)==null?void 0:b[0])||"操作失败";g.error(M)}finally{R.value=!1}}})},se=async t=>{var e,o;try{await he.confirm(`确定要删除产品"${t.name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await C.delete(`/products/${t.id}`),g.success("删除成功"),y()}catch(u){if(u!=="cancel"){const d=((o=(e=u.response)==null?void 0:e.data)==null?void 0:o.message)||"删除失败";g.error(d)}}},j=()=>{var t;n.value={scenic_spot_id:null,name:"",code:"",description:"",price_source:"manual",stay_days:null,sale_start_date:null,sale_end_date:null,is_active:!0},(t=U.value)==null||t.clearValidate()},ne=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",oe=async t=>{var e,o;L.value[t.id]=!0;try{const u=await C.get(`/products/${t.id}/export`,{responseType:"blob"}),d=window.URL.createObjectURL(new Blob([u.data])),c=document.createElement("a");c.href=d,c.setAttribute("download",`product_${t.code}_${new Date().toISOString().slice(0,10)}.csv`),document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(d),g.success("导出成功")}catch(u){const d=((o=(e=u.response)==null?void 0:e.data)==null?void 0:o.message)||"导出失败";g.error(d),console.error("导出失败",u)}finally{L.value[t.id]=!1}};return ge(()=>{y(),N()}),(t,e)=>{const o=r("el-button"),u=r("el-option"),d=r("el-select"),c=r("el-icon"),b=r("el-input"),p=r("el-table-column"),M=r("el-tag"),ue=r("el-table"),de=r("el-pagination"),re=r("el-card"),f=r("el-form-item"),ie=r("el-input-number"),P=r("el-date-picker"),pe=r("el-switch"),ce=r("el-form"),_e=r("el-dialog"),me=be("loading");return x(),A("div",null,[e[27]||(e[27]=h("h2",null,"产品管理",-1)),a(re,null,{default:s(()=>[h("div",Ce,[a(o,{type:"primary",onClick:ee},{default:s(()=>[...e[16]||(e[16]=[m("创建产品",-1)])]),_:1}),a(d,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=l=>z.value=l),placeholder:"筛选景区",clearable:"",style:{width:"200px","margin-left":"10px"},onChange:O},{default:s(()=>[(x(!0),A(Z,null,G(v.value,l=>(x(),F(u,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(d,{modelValue:Y.value,"onUpdate:modelValue":e[1]||(e[1]=l=>Y.value=l),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:O},{default:s(()=>[a(u,{label:"启用",value:!0}),a(u,{label:"禁用",value:!1})]),_:1},8,["modelValue"]),a(b,{modelValue:S.value,"onUpdate:modelValue":e[2]||(e[2]=l=>S.value=l),placeholder:"搜索产品名称或编码",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:X},{prefix:s(()=>[a(c,null,{default:s(()=>[a(H(we))]),_:1})]),_:1},8,["modelValue"])]),Ve((x(),F(ue,{data:D.value,border:""},{default:s(()=>[a(p,{prop:"name",label:"产品名称",width:"200"}),a(p,{prop:"code",label:"产品编码",width:"150"}),a(p,{label:"所属景区",width:"150"},{default:s(({row:l})=>{var w;return[m(B(((w=l.scenic_spot)==null?void 0:w.name)||"-"),1)]}),_:1}),a(p,{prop:"description",label:"描述","show-overflow-tooltip":""}),a(p,{prop:"price_source",label:"价格来源",width:"120"},{default:s(({row:l})=>[a(M,{type:l.price_source==="manual"?"primary":"success"},{default:s(()=>[m(B(l.price_source==="manual"?"人工维护":"接口推送"),1)]),_:2},1032,["type"])]),_:1}),a(p,{prop:"is_active",label:"状态",width:"100"},{default:s(({row:l})=>[a(M,{type:l.is_active?"success":"danger"},{default:s(()=>[m(B(l.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(p,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:l})=>[m(B(ne(l.created_at)),1)]),_:1}),a(p,{label:"操作",width:"350",fixed:"right"},{default:s(({row:l})=>[a(o,{size:"small",onClick:w=>le(l)},{default:s(()=>[...e[17]||(e[17]=[m("详情",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",onClick:w=>ae(l)},{default:s(()=>[...e[18]||(e[18]=[m("编辑",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",type:"success",onClick:w=>oe(l),loading:L.value[l.id]},{default:s(()=>[a(c,null,{default:s(()=>[a(H(xe))]),_:1}),e[19]||(e[19]=m(" 导出 ",-1))]),_:1},8,["onClick","loading"]),a(o,{size:"small",type:"danger",onClick:w=>se(l)},{default:s(()=>[...e[20]||(e[20]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[me,I.value]]),a(de,{"current-page":k.value,"onUpdate:currentPage":e[3]||(e[3]=l=>k.value=l),"page-size":T.value,"onUpdate:pageSize":e[4]||(e[4]=l=>T.value=l),"page-sizes":[10,20,50,100],total:q.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:y,onCurrentChange:y},null,8,["current-page","page-size","total"])]),_:1}),a(_e,{modelValue:V.value,"onUpdate:modelValue":e[15]||(e[15]=l=>V.value=l),title:Q.value,width:"600px",onClose:j},{footer:s(()=>[a(o,{onClick:e[14]||(e[14]=l=>V.value=!1)},{default:s(()=>[...e[25]||(e[25]=[m("取消",-1)])]),_:1}),a(o,{type:"primary",onClick:te,loading:R.value},{default:s(()=>[...e[26]||(e[26]=[m("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[a(ce,{ref_key:"formRef",ref:U,model:n.value,rules:W,"label-width":"120px"},{default:s(()=>[a(f,{label:"所属景区",prop:"scenic_spot_id"},{default:s(()=>[a(d,{modelValue:n.value.scenic_spot_id,"onUpdate:modelValue":e[5]||(e[5]=l=>n.value.scenic_spot_id=l),placeholder:"请选择景区",style:{width:"100%"},disabled:E.value},{default:s(()=>[(x(!0),A(Z,null,G(v.value,l=>(x(),F(u,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),a(f,{label:"产品名称",prop:"name"},{default:s(()=>[a(b,{modelValue:n.value.name,"onUpdate:modelValue":e[6]||(e[6]=l=>n.value.name=l),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),a(f,{label:"产品编码",prop:"code"},{default:s(()=>[a(b,{modelValue:n.value.code,"onUpdate:modelValue":e[7]||(e[7]=l=>n.value.code=l),placeholder:"请输入产品编码（唯一）",disabled:E.value},null,8,["modelValue","disabled"])]),_:1}),a(f,{label:"描述",prop:"description"},{default:s(()=>[a(b,{modelValue:n.value.description,"onUpdate:modelValue":e[8]||(e[8]=l=>n.value.description=l),type:"textarea",rows:4,placeholder:"请输入产品描述"},null,8,["modelValue"])]),_:1}),a(f,{label:"价格来源",prop:"price_source"},{default:s(()=>[a(d,{modelValue:n.value.price_source,"onUpdate:modelValue":e[9]||(e[9]=l=>n.value.price_source=l),placeholder:"请选择价格来源",style:{width:"100%"}},{default:s(()=>[a(u,{label:"人工维护",value:"manual"}),a(u,{label:"接口推送",value:"api"})]),_:1},8,["modelValue"]),e[21]||(e[21]=h("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 选择接口推送后，价格将通过资源方接口自动更新 ",-1))]),_:1}),a(f,{label:"入住天数",prop:"stay_days"},{default:s(()=>[a(ie,{modelValue:n.value.stay_days,"onUpdate:modelValue":e[10]||(e[10]=l=>n.value.stay_days=l),min:1,max:30,placeholder:"请输入入住天数（可为空）",style:{width:"100%"}},null,8,["modelValue"]),e[22]||(e[22]=h("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品需要连续入住的天数，为空或1表示单晚产品 ",-1))]),_:1}),a(f,{label:"销售开始日期",prop:"sale_start_date"},{default:s(()=>[a(P,{modelValue:n.value.sale_start_date,"onUpdate:modelValue":e[11]||(e[11]=l=>n.value.sale_start_date=l),type:"date",placeholder:"选择销售开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":l=>n.value.sale_end_date&&l>new Date(n.value.sale_end_date)},null,8,["modelValue","disabled-date"]),e[23]||(e[23]=h("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品开始销售的日期（必填） ",-1))]),_:1}),a(f,{label:"销售结束日期",prop:"sale_end_date"},{default:s(()=>[a(P,{modelValue:n.value.sale_end_date,"onUpdate:modelValue":e[12]||(e[12]=l=>n.value.sale_end_date=l),type:"date",placeholder:"选择销售结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":l=>n.value.sale_start_date&&l<new Date(n.value.sale_start_date)},null,8,["modelValue","disabled-date"]),e[24]||(e[24]=h("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品结束销售的日期（必填），不能早于开始日期 ",-1))]),_:1}),a(f,{label:"状态",prop:"is_active"},{default:s(()=>[a(pe,{modelValue:n.value.is_active,"onUpdate:modelValue":e[13]||(e[13]=l=>n.value.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},ze=ve(ke,[["__scopeId","data-v-179d5f12"]]);export{ze as default};
