import{r as b,i as G,c as J,o as h,f as U,b as n,w as l,d as m,j as V,E as g,e as Q,k as W,l as X,m as q,h as c,n as k,t as x,p as B,q as $}from"./app-DOrDR003.js";const Z={style:{"margin-bottom":"20px",display:"flex",gap:"10px","flex-wrap":"wrap"}},ae={__name:"Index",setup(ee){Q();const D=b([]),T=b(!1),C=b(1),z=b(15),M=b(0),f=b({}),o=b({status:null,order_no:"",ota_order_no:"",check_in_date:null}),y=async()=>{T.value=!0;try{const e={page:C.value,per_page:z.value};o.value.status&&(e.status=o.value.status),o.value.order_no&&(e.order_no=o.value.order_no),o.value.ota_order_no&&(e.ota_order_no=o.value.ota_order_no),o.value.check_in_date&&(e.check_in_date=o.value.check_in_date);const t=await V.get("/orders",{params:e});D.value=t.data.data,M.value=t.data.total}catch{g.error("获取订单列表失败")}finally{T.value=!1}},v=()=>{C.value=1,y()},w=()=>{o.value={status:null,order_no:"",ota_order_no:"",check_in_date:null},v()},O=e=>e?(parseFloat(e)/100).toFixed(2):"0.00",N=e=>e?new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",S=e=>({paid_pending:"已支付/待确认",confirming:"确认中",confirmed:"预订成功",rejected:"预订失败/拒单",cancel_requested:"申请取消中",cancel_rejected:"取消拒绝",cancel_approved:"取消通过",verified:"核销订单"})[e]||e,A=e=>({paid_pending:"warning",confirming:"info",confirmed:"success",rejected:"danger",cancel_requested:"warning",cancel_rejected:"info",cancel_approved:"info",verified:"success"})[e]||"",E=e=>{$.alert(`
        <div style="text-align: left;">
            <p><strong>订单号：</strong>${e.order_no}</p>
            <p><strong>OTA订单号：</strong>${e.ota_order_no||"-"}</p>
            <p><strong>状态：</strong>${S(e.status)}</p>
            <p><strong>入住日期：</strong>${e.check_in_date}</p>
            <p><strong>离店日期：</strong>${e.check_out_date}</p>
            <p><strong>房间数：</strong>${e.room_count}</p>
            <p><strong>订单金额：</strong>¥${O(e.total_amount)}</p>
            <p><strong>联系人：</strong>${e.contact_name}</p>
            <p><strong>联系电话：</strong>${e.contact_phone}</p>
        </div>
        `,"订单详情",{dangerouslyUseHTMLString:!0})},F=async e=>{var t,s,_,d;try{await $.confirm((s=(t=e.hotel)==null?void 0:t.scenic_spot)!=null&&s.is_system_connected?"确定要接单吗？系统将自动调用资源方接口确认订单。":"确定要接单吗？","接单确认",{type:"info",confirmButtonText:"确定",cancelButtonText:"取消"}),f.value[e.id]="confirm";const r=await V.post(`/orders/${e.id}/confirm`,{remark:""});r.data.success?(g.success(r.data.message||"接单成功"),y()):g.error(r.data.message||"接单失败")}catch(r){if(r!=="cancel"){const u=((d=(_=r.response)==null?void 0:_.data)==null?void 0:d.message)||"接单失败";g.error(u)}}finally{f.value[e.id]=null}},P=async e=>{var t,s;try{const{value:_}=await $.prompt("请输入拒单原因","拒单",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"请输入拒单原因",inputValidator:r=>!r||r.trim().length===0?"拒单原因不能为空":!0});f.value[e.id]="reject";const d=await V.post(`/orders/${e.id}/reject`,{reason:_.trim()});d.data.success?(g.success(d.data.message||"拒单成功"),y()):g.error(d.data.message||"拒单失败")}catch(_){if(_!=="cancel"){const d=((s=(t=_.response)==null?void 0:t.data)==null?void 0:s.message)||"拒单失败";g.error(d)}}finally{f.value[e.id]=null}},K=async e=>{var t,s,_,d;try{const r={use_start_date:e.check_in_date,use_end_date:e.check_out_date,use_quantity:e.room_count,passengers:[],vouchers:[]};await $.confirm((s=(t=e.hotel)==null?void 0:t.scenic_spot)!=null&&s.is_system_connected?"确定要核销订单吗？系统将自动调用资源方接口核销订单。":"确定要核销订单吗？","核销确认",{type:"info",confirmButtonText:"确定",cancelButtonText:"取消"}),f.value[e.id]="verify";const u=await V.post(`/orders/${e.id}/verify`,r);u.data.success?(g.success(u.data.message||"核销成功"),y()):g.error(u.data.message||"核销失败")}catch(r){if(r!=="cancel"){const u=((d=(_=r.response)==null?void 0:_.data)==null?void 0:d.message)||"核销失败";g.error(u)}}finally{f.value[e.id]=null}};return G(()=>{y()}),(e,t)=>{const s=m("el-option"),_=m("el-select"),d=m("el-input"),r=m("el-date-picker"),u=m("el-button"),p=m("el-table-column"),j=m("el-tag"),L=m("el-table"),R=m("el-pagination"),H=m("el-card"),I=W("loading");return h(),J("div",null,[t[14]||(t[14]=U("h2",null,"订单管理",-1)),n(H,null,{default:l(()=>[U("div",Z,[n(_,{modelValue:o.value.status,"onUpdate:modelValue":t[0]||(t[0]=a=>o.value.status=a),placeholder:"订单状态",clearable:"",style:{width:"150px"},onChange:v},{default:l(()=>[n(s,{label:"已支付/待确认",value:"paid_pending"}),n(s,{label:"确认中",value:"confirming"}),n(s,{label:"预订成功",value:"confirmed"}),n(s,{label:"预订失败/拒单",value:"rejected"}),n(s,{label:"申请取消中",value:"cancel_requested"}),n(s,{label:"取消拒绝",value:"cancel_rejected"}),n(s,{label:"取消通过",value:"cancel_approved"}),n(s,{label:"核销订单",value:"verified"})]),_:1},8,["modelValue"]),n(d,{modelValue:o.value.order_no,"onUpdate:modelValue":t[1]||(t[1]=a=>o.value.order_no=a),placeholder:"订单号",clearable:"",style:{width:"200px"},onClear:v,onKeyup:q(v,["enter"])},null,8,["modelValue"]),n(d,{modelValue:o.value.ota_order_no,"onUpdate:modelValue":t[2]||(t[2]=a=>o.value.ota_order_no=a),placeholder:"OTA订单号",clearable:"",style:{width:"200px"},onClear:v,onKeyup:q(v,["enter"])},null,8,["modelValue"]),n(r,{modelValue:o.value.check_in_date,"onUpdate:modelValue":t[3]||(t[3]=a=>o.value.check_in_date=a),type:"date",placeholder:"入住日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"150px"},onChange:v},null,8,["modelValue"]),n(u,{onClick:v},{default:l(()=>[...t[6]||(t[6]=[c("筛选",-1)])]),_:1}),n(u,{onClick:w},{default:l(()=>[...t[7]||(t[7]=[c("重置",-1)])]),_:1})]),X((h(),k(L,{data:D.value,border:""},{default:l(()=>[n(p,{prop:"order_no",label:"订单号",width:"180"}),n(p,{prop:"ota_order_no",label:"OTA订单号",width:"180"}),n(p,{label:"OTA平台",width:"120"},{default:l(({row:a})=>{var i;return[c(x(((i=a.ota_platform)==null?void 0:i.name)||"-"),1)]}),_:1}),n(p,{label:"产品",width:"150"},{default:l(({row:a})=>{var i;return[c(x(((i=a.product)==null?void 0:i.name)||"-"),1)]}),_:1}),n(p,{label:"酒店",width:"150"},{default:l(({row:a})=>{var i;return[c(x(((i=a.hotel)==null?void 0:i.name)||"-"),1)]}),_:1}),n(p,{prop:"status",label:"状态",width:"120"},{default:l(({row:a})=>[n(j,{type:A(a.status)},{default:l(()=>[c(x(S(a.status)),1)]),_:2},1032,["type"])]),_:1}),n(p,{prop:"check_in_date",label:"入住日期",width:"120"}),n(p,{prop:"check_out_date",label:"离店日期",width:"120"}),n(p,{prop:"room_count",label:"房间数",width:"80"}),n(p,{prop:"total_amount",label:"订单金额",width:"120"},{default:l(({row:a})=>[c(" ¥"+x(O(a.total_amount)),1)]),_:1}),n(p,{prop:"created_at",label:"创建时间",width:"180"},{default:l(({row:a})=>[c(x(N(a.created_at)),1)]),_:1}),n(p,{label:"系统直连",width:"100"},{default:l(({row:a})=>{var i,Y;return[(Y=(i=a.hotel)==null?void 0:i.scenic_spot)!=null&&Y.is_system_connected?(h(),k(j,{key:0,type:"success",size:"small"},{default:l(()=>[...t[8]||(t[8]=[c(" 系统直连 ",-1)])]),_:1})):(h(),k(j,{key:1,type:"info",size:"small"},{default:l(()=>[...t[9]||(t[9]=[c("人工操作",-1)])]),_:1}))]}),_:1}),n(p,{label:"操作",width:"300",fixed:"right"},{default:l(({row:a})=>[n(u,{size:"small",onClick:i=>E(a)},{default:l(()=>[...t[10]||(t[10]=[c("详情",-1)])]),_:1},8,["onClick"]),["paid_pending","confirming"].includes(a.status)?(h(),k(u,{key:0,size:"small",type:"success",onClick:i=>F(a),loading:f.value[a.id]==="confirm"},{default:l(()=>[...t[11]||(t[11]=[c(" 接单 ",-1)])]),_:1},8,["onClick","loading"])):B("",!0),["paid_pending","confirming"].includes(a.status)?(h(),k(u,{key:1,size:"small",type:"danger",onClick:i=>P(a),loading:f.value[a.id]==="reject"},{default:l(()=>[...t[12]||(t[12]=[c(" 拒单 ",-1)])]),_:1},8,["onClick","loading"])):B("",!0),a.status==="confirmed"?(h(),k(u,{key:2,size:"small",type:"primary",onClick:i=>K(a),loading:f.value[a.id]==="verify"},{default:l(()=>[...t[13]||(t[13]=[c(" 核销 ",-1)])]),_:1},8,["onClick","loading"])):B("",!0)]),_:1})]),_:1},8,["data"])),[[I,T.value]]),n(R,{"current-page":C.value,"onUpdate:currentPage":t[4]||(t[4]=a=>C.value=a),"page-size":z.value,"onUpdate:pageSize":t[5]||(t[5]=a=>z.value=a),total:M.value,onCurrentChange:y,onSizeChange:y,style:{"margin-top":"20px"}},null,8,["current-page","page-size","total"])]),_:1})])}}};export{ae as default};
