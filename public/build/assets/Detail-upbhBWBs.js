import{_ as fe,r as p,i as be,c as A,o as V,b as a,m as G,w as r,d as i,l as ye,q as x,k as P,x as ke,E as b,e as Ve,f as H,s as q,h as n,t as v,v as we}from"./app-dwQB4-it.js";const he={key:0},De={style:{"margin-bottom":"20px"}},Ye={__name:"Detail",setup(xe){const J=ke(),K=Ve(),C=p(!1),_=p(null),E=p("prices"),M=p([]),F=p(!1),y=p([]),u=p({current_page:1,per_page:50,total:0,last_page:1}),h=p(!1),R=p(null),S=p(!1),d=p({dateRange:null,cost_price:0,sale_price:0,stock_available:0}),Q={dateRange:[{required:!0,message:"请选择日期范围",trigger:"change"}],cost_price:[{required:!0,message:"请输入成本价",trigger:"blur"}],sale_price:[{required:!0,message:"请输入销售价",trigger:"blur"},{validator:(l,e,s)=>{e<d.value.cost_price?s(new Error("销售价不能低于成本价")):s()},trigger:"blur"}],stock_available:[{required:!0,message:"请输入可用库存",trigger:"blur"}]},D=p(!1),U=p(null),$=p(!1),B=p(null),c=p({date:null,cost_price:0,sale_price:0,stock_available:0}),W={cost_price:[{required:!0,message:"请输入成本价",trigger:"blur"}],sale_price:[{required:!0,message:"请输入销售价",trigger:"blur"},{validator:(l,e,s)=>{e<c.value.cost_price?s(new Error("销售价不能低于成本价")):s()},trigger:"blur"}],stock_available:[{required:!0,message:"请输入可用库存",trigger:"blur"}]},X=()=>{K.push("/tickets")},N=l=>l?(parseFloat(l)/100).toFixed(2):"0.00",Z=async()=>{C.value=!0;try{const l=await P.get(`/tickets/${J.params.id}`);_.value=l.data.data,_.value&&await m()}catch(l){b.error("获取门票详情失败"),console.error(l)}finally{C.value=!1}},m=async()=>{if(_.value){F.value=!0;try{const l={ticket_id:_.value.id,page:u.value.current_page,per_page:u.value.per_page};y.value&&y.value.length===2&&(l.start_date=y.value[0],l.end_date=y.value[1]);const e=await P.get("/ticket-prices",{params:l});M.value=(e.data.data||[]).map(s=>({...s,cost_price:(parseFloat(s.cost_price)||0)/100,sale_price:(parseFloat(s.sale_price)||0)/100})),e.data.current_page!==void 0&&(u.value={current_page:e.data.current_page,per_page:e.data.per_page,total:e.data.total,last_page:e.data.last_page})}catch(l){b.error("获取价库列表失败"),console.error(l)}finally{F.value=!1}}},ee=()=>{y.value=[],u.value.current_page=1,m()},ae=l=>{u.value.current_page=l,m()},te=l=>{u.value.per_page=l,u.value.current_page=1,m()},le=()=>{T(),h.value=!0},re=async()=>{R.value&&await R.value.validate(async l=>{var e,s;if(l){S.value=!0;try{const o={ticket_id:_.value.id,start_date:d.value.dateRange[0],end_date:d.value.dateRange[1],cost_price:Math.round(d.value.cost_price*100),sale_price:Math.round(d.value.sale_price*100),stock_available:d.value.stock_available};await P.post("/ticket-prices/batch",o),b.success("批量设置价库成功"),h.value=!1,u.value.current_page=1,await m()}catch(o){const k=((s=(e=o.response)==null?void 0:e.data)==null?void 0:s.message)||o.message||"操作失败";b.error(k),console.error(o)}finally{S.value=!1}}})},oe=l=>{B.value=l.id,c.value={date:l.date,cost_price:parseFloat(l.cost_price)||0,sale_price:parseFloat(l.sale_price)||0,stock_available:l.stock_available},D.value=!0},se=async()=>{U.value&&await U.value.validate(async l=>{var e,s;if(l){$.value=!0;try{const o={cost_price:Math.round(c.value.cost_price*100),sale_price:Math.round(c.value.sale_price*100),stock_available:c.value.stock_available};await P.put(`/ticket-prices/${B.value}`,o),b.success("价库更新成功"),D.value=!1,await m()}catch(o){const k=((s=(e=o.response)==null?void 0:e.data)==null?void 0:s.message)||o.message||"操作失败";b.error(k),console.error(o)}finally{$.value=!1}}})},ne=async l=>{try{await we.confirm(`确定要删除日期为"${l.date}"的价库记录吗？`,"提示",{type:"warning"}),await P.delete(`/ticket-prices/${l.id}`),b.success("删除成功"),M.value.length===1&&u.value.current_page>1&&u.value.current_page--,await m()}catch(e){e!=="cancel"&&(b.error("删除失败"),console.error(e))}},T=()=>{var l;(l=R.value)==null||l.resetFields(),d.value={dateRange:null,cost_price:0,sale_price:0,stock_available:0}},ie=()=>{var l;(l=U.value)==null||l.resetFields(),B.value=null,c.value={date:null,cost_price:0,sale_price:0,stock_available:0}},ue=l=>{if(!l)return"";const e=new Date(l),s=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),k=String(e.getDate()).padStart(2,"0");return`${s}-${o}-${k}`};return be(()=>{Z()}),(l,e)=>{const s=i("el-page-header"),o=i("el-descriptions-item"),k=i("el-tag"),de=i("el-descriptions"),g=i("el-button"),z=i("el-date-picker"),Y=i("el-table-column"),pe=i("el-table"),ce=i("el-pagination"),j=i("el-empty"),f=i("el-form-item"),w=i("el-input-number"),I=i("el-form"),L=i("el-dialog"),_e=i("el-tab-pane"),ve=i("el-tabs"),me=i("el-card"),O=ye("loading");return V(),A("div",null,[a(s,{onBack:X,title:"返回门票列表"},{content:r(()=>[...e[16]||(e[16]=[H("span",null,"门票详情",-1)])]),_:1}),G((V(),x(me,{style:{"margin-top":"20px"}},{default:r(()=>[_.value?(V(),A("div",he,[a(de,{title:"门票基本信息",column:2,border:"",style:{"margin-bottom":"20px"}},{default:r(()=>[a(o,{label:"门票名称"},{default:r(()=>[n(v(_.value.name),1)]),_:1}),a(o,{label:"门票编码"},{default:r(()=>[n(v(_.value.code),1)]),_:1}),a(o,{label:"所属景区"},{default:r(()=>{var t;return[n(v(((t=_.value.scenic_spot)==null?void 0:t.name)||"-"),1)]}),_:1}),a(o,{label:"软件服务商"},{default:r(()=>{var t;return[n(v(((t=_.value.software_provider)==null?void 0:t.name)||"-"),1)]}),_:1}),a(o,{label:"外部门票编号"},{default:r(()=>[n(v(_.value.external_ticket_id||"-"),1)]),_:1}),a(o,{label:"状态"},{default:r(()=>[a(k,{type:_.value.is_active?"success":"danger"},{default:r(()=>[n(v(_.value.is_active?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),a(o,{label:"描述",span:2},{default:r(()=>[n(v(_.value.description||"-"),1)]),_:1})]),_:1}),a(ve,{modelValue:E.value,"onUpdate:modelValue":e[15]||(e[15]=t=>E.value=t),style:{"margin-top":"20px"}},{default:r(()=>[a(_e,{label:"价库管理",name:"prices"},{default:r(()=>[H("div",De,[a(g,{type:"primary",onClick:le},{default:r(()=>[...e[17]||(e[17]=[n("批量设置价库",-1)])]),_:1}),a(z,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=t=>y.value=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{"margin-left":"20px"},onChange:m},null,8,["modelValue"]),a(g,{style:{"margin-left":"10px"},onClick:ee},{default:r(()=>[...e[18]||(e[18]=[n("重置筛选",-1)])]),_:1})]),G((V(),x(pe,{data:M.value,border:""},{default:r(()=>[a(Y,{prop:"date",label:"日期",width:"120",align:"right"},{default:r(({row:t})=>[n(v(ue(t.date)),1)]),_:1}),a(Y,{prop:"cost_price",label:"成本价（元）",width:"120",align:"right"},{default:r(({row:t})=>[n(" ¥"+v(N(t.cost_price)),1)]),_:1}),a(Y,{prop:"sale_price",label:"销售价（元）",width:"120",align:"right"},{default:r(({row:t})=>[n(" ¥"+v(N(t.sale_price)),1)]),_:1}),a(Y,{prop:"stock_available",label:"可用库存",width:"120",align:"right"}),a(Y,{label:"操作",width:"150",fixed:"right"},{default:r(({row:t})=>[a(g,{size:"small",onClick:ge=>oe(t)},{default:r(()=>[...e[19]||(e[19]=[n("编辑",-1)])]),_:1},8,["onClick"]),a(g,{size:"small",type:"danger",onClick:ge=>ne(t)},{default:r(()=>[...e[20]||(e[20]=[n("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[O,F.value]]),u.value.total>0?(V(),x(ce,{key:0,"current-page":u.value.current_page,"onUpdate:currentPage":e[1]||(e[1]=t=>u.value.current_page=t),"page-size":u.value.per_page,"onUpdate:pageSize":e[2]||(e[2]=t=>u.value.per_page=t),"page-sizes":[10,20,50,100],total:u.value.total,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px","justify-content":"flex-end"},onSizeChange:te,onCurrentChange:ae},null,8,["current-page","page-size","total"])):q("",!0),!F.value&&M.value.length===0?(V(),x(j,{key:1,description:"暂无价格数据"})):q("",!0),a(L,{modelValue:h.value,"onUpdate:modelValue":e[8]||(e[8]=t=>h.value=t),title:"批量设置价库",width:"600px","append-to-body":"",onClose:T},{footer:r(()=>[a(g,{onClick:e[7]||(e[7]=t=>h.value=!1)},{default:r(()=>[...e[21]||(e[21]=[n("取消",-1)])]),_:1}),a(g,{type:"primary",onClick:re,loading:S.value},{default:r(()=>[...e[22]||(e[22]=[n("确定",-1)])]),_:1},8,["loading"])]),default:r(()=>[a(I,{ref_key:"batchPriceFormRef",ref:R,model:d.value,rules:Q,"label-width":"120px"},{default:r(()=>[a(f,{label:"日期范围",prop:"dateRange"},{default:r(()=>[a(z,{modelValue:d.value.dateRange,"onUpdate:modelValue":e[3]||(e[3]=t=>d.value.dateRange=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(f,{label:"成本价（元）",prop:"cost_price"},{default:r(()=>[a(w,{modelValue:d.value.cost_price,"onUpdate:modelValue":e[4]||(e[4]=t=>d.value.cost_price=t),min:0,precision:2,step:.01,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(f,{label:"销售价（元）",prop:"sale_price"},{default:r(()=>[a(w,{modelValue:d.value.sale_price,"onUpdate:modelValue":e[5]||(e[5]=t=>d.value.sale_price=t),min:0,precision:2,step:.01,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(f,{label:"可用库存",prop:"stock_available"},{default:r(()=>[a(w,{modelValue:d.value.stock_available,"onUpdate:modelValue":e[6]||(e[6]=t=>d.value.stock_available=t),min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(L,{modelValue:D.value,"onUpdate:modelValue":e[14]||(e[14]=t=>D.value=t),title:"编辑价库",width:"500px","append-to-body":"",onClose:ie},{footer:r(()=>[a(g,{onClick:e[13]||(e[13]=t=>D.value=!1)},{default:r(()=>[...e[23]||(e[23]=[n("取消",-1)])]),_:1}),a(g,{type:"primary",onClick:se,loading:$.value},{default:r(()=>[...e[24]||(e[24]=[n("确定",-1)])]),_:1},8,["loading"])]),default:r(()=>[a(I,{ref_key:"priceFormRef",ref:U,model:c.value,rules:W,"label-width":"120px"},{default:r(()=>[a(f,{label:"日期"},{default:r(()=>[a(z,{modelValue:c.value.date,"onUpdate:modelValue":e[9]||(e[9]=t=>c.value.date=t),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},disabled:""},null,8,["modelValue"])]),_:1}),a(f,{label:"成本价（元）",prop:"cost_price"},{default:r(()=>[a(w,{modelValue:c.value.cost_price,"onUpdate:modelValue":e[10]||(e[10]=t=>c.value.cost_price=t),min:0,precision:2,step:.01,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(f,{label:"销售价（元）",prop:"sale_price"},{default:r(()=>[a(w,{modelValue:c.value.sale_price,"onUpdate:modelValue":e[11]||(e[11]=t=>c.value.sale_price=t),min:0,precision:2,step:.01,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(f,{label:"可用库存",prop:"stock_available"},{default:r(()=>[a(w,{modelValue:c.value.stock_available,"onUpdate:modelValue":e[12]||(e[12]=t=>c.value.stock_available=t),min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])])):C.value?q("",!0):(V(),x(j,{key:1,description:"门票信息加载失败或不存在"}))]),_:1})),[[O,C.value]])])}}},Ce=fe(Ye,[["__scopeId","data-v-d6986fda"]]);export{Ce as default};
