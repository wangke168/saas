import{r as b,i as X,c as Z,o as y,f as U,b as n,w as r,d as f,j as C,E as u,e as w,k as ee,l as te,m as A,h as p,n as h,t as x,p as B,q as T}from"./app-HzGD55g9.js";const ae={style:{"margin-bottom":"20px",display:"flex",gap:"10px","flex-wrap":"wrap"}},se={__name:"Index",setup(ne){w();const $=b([]),q=b(!1),z=b(1),D=b(15),M=b(0),_=b({}),d=b({status:null,order_no:"",ota_order_no:"",check_in_date:null}),v=async()=>{q.value=!0;try{const t={page:z.value,per_page:D.value};d.value.status&&(t.status=d.value.status),d.value.order_no&&(t.order_no=d.value.order_no),d.value.ota_order_no&&(t.ota_order_no=d.value.ota_order_no),d.value.check_in_date&&(t.check_in_date=d.value.check_in_date);const e=await C.get("/orders",{params:t});$.value=e.data.data,M.value=e.data.total,$.value.length>0&&$.value.some(l=>l.status==="cancel_requested")&&console.log("找到申请取消中的订单:",$.value.filter(l=>l.status==="cancel_requested"))}catch{u.error("获取订单列表失败")}finally{q.value=!1}},k=()=>{z.value=1,v()},N=()=>{d.value={status:null,order_no:"",ota_order_no:"",check_in_date:null},k()},S=t=>t?(parseFloat(t)/100).toFixed(2):"0.00",P=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",Y=t=>({paid_pending:"已支付/待确认",confirming:"确认中",confirmed:"预订成功",rejected:"预订失败/拒单",cancel_requested:"申请取消中",cancel_rejected:"取消拒绝",cancel_approved:"取消通过",verified:"核销订单"})[t]||t,E=t=>({paid_pending:"warning",confirming:"info",confirmed:"success",rejected:"danger",cancel_requested:"warning",cancel_rejected:"info",cancel_approved:"info",verified:"success"})[t]||"",F=t=>{T.alert(`
        <div style="text-align: left;">
            <p><strong>订单号：</strong>${t.order_no}</p>
            <p><strong>OTA订单号：</strong>${t.ota_order_no||"-"}</p>
            <p><strong>状态：</strong>${Y(t.status)}</p>
            <p><strong>入住日期：</strong>${t.check_in_date}</p>
            <p><strong>离店日期：</strong>${t.check_out_date}</p>
            <p><strong>房间数：</strong>${t.room_count}</p>
            <p><strong>订单金额：</strong>¥${S(t.total_amount)}</p>
            <p><strong>联系人：</strong>${t.contact_name}</p>
            <p><strong>联系电话：</strong>${t.contact_phone}</p>
        </div>
        `,"订单详情",{dangerouslyUseHTMLString:!0})},K=async t=>{var e,l,s,o;try{await T.confirm((l=(e=t.hotel)==null?void 0:e.scenic_spot)!=null&&l.is_system_connected?"确定要接单吗？系统将自动调用资源方接口确认订单。":"确定要接单吗？","接单确认",{type:"info",confirmButtonText:"确定",cancelButtonText:"取消"}),_.value[t.id]="confirm";const i=await C.post(`/orders/${t.id}/confirm`,{remark:""});i.data.success?(u.success(i.data.message||"接单成功"),v()):u.error(i.data.message||"接单失败")}catch(i){if(i!=="cancel"){const c=((o=(s=i.response)==null?void 0:s.data)==null?void 0:o.message)||"接单失败";u.error(c)}}finally{_.value[t.id]=null}},L=async t=>{var e,l;try{const{value:s}=await T.prompt("请输入拒单原因","拒单",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"请输入拒单原因",inputValidator:i=>!i||i.trim().length===0?"拒单原因不能为空":!0});_.value[t.id]="reject";const o=await C.post(`/orders/${t.id}/reject`,{reason:s.trim()});o.data.success?(u.success(o.data.message||"拒单成功"),v()):u.error(o.data.message||"拒单失败")}catch(s){if(s!=="cancel"){const o=((l=(e=s.response)==null?void 0:e.data)==null?void 0:l.message)||"拒单失败";u.error(o)}}finally{_.value[t.id]=null}},R=async t=>{var e,l,s,o;try{const i={use_start_date:t.check_in_date,use_end_date:t.check_out_date,use_quantity:t.room_count,passengers:[],vouchers:[]};await T.confirm((l=(e=t.hotel)==null?void 0:e.scenic_spot)!=null&&l.is_system_connected?"确定要核销订单吗？系统将自动调用资源方接口核销订单。":"确定要核销订单吗？","核销确认",{type:"info",confirmButtonText:"确定",cancelButtonText:"取消"}),_.value[t.id]="verify";const c=await C.post(`/orders/${t.id}/verify`,i);c.data.success?(u.success(c.data.message||"核销成功"),v()):u.error(c.data.message||"核销失败")}catch(i){if(i!=="cancel"){const c=((o=(s=i.response)==null?void 0:s.data)==null?void 0:o.message)||"核销失败";u.error(c)}}finally{_.value[t.id]=null}},H=async t=>{var e,l;try{await T.confirm("确定要同意取消订单吗？同意后将释放库存并通知OTA平台。","同意取消确认",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"}),_.value[t.id]="approveCancel";const s=await C.post(`/orders/${t.id}/approve-cancel`,{reason:"人工同意取消"});s.data.success?(u.success(s.data.message||"同意取消成功"),v()):u.error(s.data.message||"同意取消失败")}catch(s){if(s!=="cancel"){const o=((l=(e=s.response)==null?void 0:e.data)==null?void 0:l.message)||"同意取消失败";u.error(o)}}finally{_.value[t.id]=null}},I=async t=>{var e,l;try{const{value:s}=await T.prompt("请输入拒绝取消的原因","拒绝取消",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"请输入拒绝取消的原因",inputValidator:i=>!i||i.trim().length===0?"拒绝取消的原因不能为空":!0});_.value[t.id]="rejectCancel";const o=await C.post(`/orders/${t.id}/reject-cancel`,{reason:s.trim()});o.data.success?(u.success(o.data.message||"拒绝取消成功"),v()):u.error(o.data.message||"拒绝取消失败")}catch(s){if(s!=="cancel"){const o=((l=(e=s.response)==null?void 0:e.data)==null?void 0:l.message)||"拒绝取消失败";u.error(o)}}finally{_.value[t.id]=null}};return X(()=>{v()}),(t,e)=>{const l=f("el-option"),s=f("el-select"),o=f("el-input"),i=f("el-date-picker"),c=f("el-button"),g=f("el-table-column"),O=f("el-tag"),G=f("el-table"),J=f("el-pagination"),Q=f("el-card"),W=ee("loading");return y(),Z("div",null,[e[16]||(e[16]=U("h2",null,"订单管理",-1)),n(Q,null,{default:r(()=>[U("div",ae,[n(s,{modelValue:d.value.status,"onUpdate:modelValue":e[0]||(e[0]=a=>d.value.status=a),placeholder:"订单状态",clearable:"",style:{width:"150px"},onChange:k},{default:r(()=>[n(l,{label:"已支付/待确认",value:"paid_pending"}),n(l,{label:"确认中",value:"confirming"}),n(l,{label:"预订成功",value:"confirmed"}),n(l,{label:"预订失败/拒单",value:"rejected"}),n(l,{label:"申请取消中",value:"cancel_requested"}),n(l,{label:"取消拒绝",value:"cancel_rejected"}),n(l,{label:"取消通过",value:"cancel_approved"}),n(l,{label:"核销订单",value:"verified"})]),_:1},8,["modelValue"]),n(o,{modelValue:d.value.order_no,"onUpdate:modelValue":e[1]||(e[1]=a=>d.value.order_no=a),placeholder:"订单号",clearable:"",style:{width:"200px"},onClear:k,onKeyup:A(k,["enter"])},null,8,["modelValue"]),n(o,{modelValue:d.value.ota_order_no,"onUpdate:modelValue":e[2]||(e[2]=a=>d.value.ota_order_no=a),placeholder:"OTA订单号",clearable:"",style:{width:"200px"},onClear:k,onKeyup:A(k,["enter"])},null,8,["modelValue"]),n(i,{modelValue:d.value.check_in_date,"onUpdate:modelValue":e[3]||(e[3]=a=>d.value.check_in_date=a),type:"date",placeholder:"入住日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"150px"},onChange:k},null,8,["modelValue"]),n(c,{onClick:k},{default:r(()=>[...e[6]||(e[6]=[p("筛选",-1)])]),_:1}),n(c,{onClick:N},{default:r(()=>[...e[7]||(e[7]=[p("重置",-1)])]),_:1})]),te((y(),h(G,{data:$.value,border:""},{default:r(()=>[n(g,{prop:"order_no",label:"订单号",width:"180"}),n(g,{prop:"ota_order_no",label:"OTA订单号",width:"180"}),n(g,{label:"OTA平台",width:"120"},{default:r(({row:a})=>{var m;return[p(x(((m=a.ota_platform)==null?void 0:m.name)||"-"),1)]}),_:1}),n(g,{label:"产品",width:"150"},{default:r(({row:a})=>{var m;return[p(x(((m=a.product)==null?void 0:m.name)||"-"),1)]}),_:1}),n(g,{label:"酒店",width:"150"},{default:r(({row:a})=>{var m;return[p(x(((m=a.hotel)==null?void 0:m.name)||"-"),1)]}),_:1}),n(g,{prop:"status",label:"状态",width:"120"},{default:r(({row:a})=>[n(O,{type:E(a.status)},{default:r(()=>[p(x(Y(a.status)),1)]),_:2},1032,["type"])]),_:1}),n(g,{prop:"check_in_date",label:"入住日期",width:"120"}),n(g,{prop:"check_out_date",label:"离店日期",width:"120"}),n(g,{prop:"room_count",label:"房间数",width:"80"}),n(g,{prop:"total_amount",label:"订单金额",width:"120"},{default:r(({row:a})=>[p(" ¥"+x(S(a.total_amount)),1)]),_:1}),n(g,{prop:"created_at",label:"创建时间",width:"180"},{default:r(({row:a})=>[p(x(P(a.created_at)),1)]),_:1}),n(g,{label:"系统直连",width:"100"},{default:r(({row:a})=>{var m,V;return[(V=(m=a.hotel)==null?void 0:m.scenic_spot)!=null&&V.is_system_connected?(y(),h(O,{key:0,type:"success",size:"small"},{default:r(()=>[...e[8]||(e[8]=[p(" 系统直连 ",-1)])]),_:1})):(y(),h(O,{key:1,type:"info",size:"small"},{default:r(()=>[...e[9]||(e[9]=[p("人工操作",-1)])]),_:1}))]}),_:1}),n(g,{label:"操作",width:"400",fixed:"right"},{default:r(({row:a})=>{var m,V;return[n(c,{size:"small",onClick:j=>F(a)},{default:r(()=>[...e[10]||(e[10]=[p("详情",-1)])]),_:1},8,["onClick"]),["paid_pending","confirming"].includes(a.status)?(y(),h(c,{key:0,size:"small",type:"success",onClick:j=>K(a),loading:_.value[a.id]==="confirm"},{default:r(()=>[...e[11]||(e[11]=[p(" 接单 ",-1)])]),_:1},8,["onClick","loading"])):B("",!0),["paid_pending","confirming"].includes(a.status)?(y(),h(c,{key:1,size:"small",type:"danger",onClick:j=>L(a),loading:_.value[a.id]==="reject"},{default:r(()=>[...e[12]||(e[12]=[p(" 拒单 ",-1)])]),_:1},8,["onClick","loading"])):B("",!0),a.status==="confirmed"?(y(),h(c,{key:2,size:"small",type:"primary",onClick:j=>R(a),loading:_.value[a.id]==="verify"},{default:r(()=>[...e[13]||(e[13]=[p(" 核销 ",-1)])]),_:1},8,["onClick","loading"])):B("",!0),a.status==="cancel_requested"||((m=a.status)==null?void 0:m.value)==="cancel_requested"?(y(),h(c,{key:3,size:"small",type:"success",onClick:j=>H(a),loading:_.value[a.id]==="approveCancel"},{default:r(()=>[...e[14]||(e[14]=[p(" 同意取消 ",-1)])]),_:1},8,["onClick","loading"])):B("",!0),a.status==="cancel_requested"||((V=a.status)==null?void 0:V.value)==="cancel_requested"?(y(),h(c,{key:4,size:"small",type:"danger",onClick:j=>I(a),loading:_.value[a.id]==="rejectCancel"},{default:r(()=>[...e[15]||(e[15]=[p(" 拒绝取消 ",-1)])]),_:1},8,["onClick","loading"])):B("",!0)]}),_:1})]),_:1},8,["data"])),[[W,q.value]]),n(J,{"current-page":z.value,"onUpdate:currentPage":e[4]||(e[4]=a=>z.value=a),"page-size":D.value,"onUpdate:pageSize":e[5]||(e[5]=a=>D.value=a),total:M.value,onCurrentChange:v,onSizeChange:v,style:{"margin-top":"20px"}},null,8,["current-page","page-size","total"])]),_:1})])}}};export{se as default};
