import{_ as se,r as d,x as re,i as ue,c as B,o as _,b as t,m as L,w as o,d as r,l as ie,q as b,k as D,B as ce,E as v,e as de,f as h,t as m,s as q,h as u,y as I,G as pe,H as _e,I as me,F as G,p as j,v as P}from"./app-CCEVyAWf.js";const fe={key:0},ve={style:{"margin-bottom":"20px"}},ge={style:{"margin-bottom":"20px"}},ye={__name:"PriceManagement",setup(he){const w=ce(),J=de(),M=d(!1),c=d(null),O=d(!1),$=d(!1),Y=d(!1),C=d(!1),A=d([]),f=d([]),g=d(null),k=d(null),E=d([]),T=d([]);re(()=>g.value?T.value.filter(a=>a.hotel_id===g.value):T.value);const K=()=>{J.push("/pkg-products")},Q=a=>{if(!a)return"";const e=new Date(a),n=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),p=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),S=String(e.getMinutes()).padStart(2,"0");return`${n}-${s}-${p} ${i}:${S}`},R=a=>a?parseFloat(a).toFixed(2):"0.00",W=async()=>{M.value=!0;try{const a=await D.get(`/pkg-products/${w.params.id}`);if(c.value=a.data.data,c.value.hotel_room_types){const s=new Map,p=new Map;c.value.hotel_room_types.forEach(i=>{i.hotel&&!s.has(i.hotel.id)&&s.set(i.hotel.id,i.hotel),i.room_type&&!p.has(i.room_type.id)&&p.set(i.room_type.id,{...i.room_type,hotel_id:i.hotel_id})}),E.value=Array.from(s.values()),T.value=Array.from(p.values())}const e=new Date,n=new Date;n.setDate(e.getDate()+30),f.value=[e.toISOString().split("T")[0],n.toISOString().split("T")[0]],await x()}catch(a){v.error("获取产品详情失败"),console.error(a)}finally{M.value=!1}},x=async()=>{if(c.value){C.value=!0;try{const a={};f.value&&f.value.length===2&&(a.start_date=f.value[0],a.end_date=f.value[1]),g.value&&(a.hotel_id=g.value),k.value&&(a.room_type_id=k.value);const e=await D.get(`/pkg-products/${w.params.id}/prices/calendar`,{params:a});A.value=e.data.data||[]}catch(a){v.error("获取价格日历失败"),console.error(a)}finally{C.value=!1}}},X=()=>{f.value=[],g.value=null,k.value=null,x()},Z=async()=>{var a,e;try{await P.confirm("确定要预计算未来60天的价格吗？这可能需要一些时间，将在后台异步处理。","提示",{type:"info"}),O.value=!0;try{await D.post(`/pkg-products/${w.params.id}/prices/calculate`),v.success("价格预计算任务已提交，正在后台处理，请稍后刷新查看结果")}catch(n){const s=((e=(a=n.response)==null?void 0:a.data)==null?void 0:e.message)||n.message||"操作失败";v.error(s),console.error(n)}finally{O.value=!1}}catch{}},ee=async()=>{var a,e;try{await P.confirm("确定要重新计算价格吗？这将重新计算所有关联的门票和酒店价格，可能需要一些时间。","提示",{type:"warning"}),$.value=!0;try{await D.post(`/pkg-products/${w.params.id}/prices/recalculate`),v.success("价格重新计算任务已提交，正在后台处理，请稍后刷新查看结果")}catch(n){const s=((e=(a=n.response)==null?void 0:a.data)==null?void 0:e.message)||n.message||"操作失败";v.error(s),console.error(n)}finally{$.value=!1}}catch{}},te=async()=>{var a,e;try{const{value:n}=await P.prompt("请选择要推送的OTA平台","推送价格到OTA",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"select",inputOptions:{ctrip:"携程",meituan:"美团"},inputPlaceholder:"请选择OTA平台"});if(!n)return;Y.value=!0;try{await D.post(`/pkg-products/${w.params.id}/prices/sync-to-ota`,{platform_code:n}),v.success("价格推送到OTA任务已提交，正在后台处理，请稍后查看结果")}catch(s){const p=((e=(a=s.response)==null?void 0:a.data)==null?void 0:e.message)||s.message||"操作失败";v.error(p),console.error(s)}finally{Y.value=!1}}catch{}};return ue(()=>{W()}),(a,e)=>{const n=r("el-page-header"),s=r("el-descriptions-item"),p=r("el-tag"),i=r("el-descriptions"),S=r("el-divider"),F=r("el-icon"),V=r("el-button"),ae=r("el-alert"),le=r("el-date-picker"),N=r("el-option"),H=r("el-select"),y=r("el-table-column"),oe=r("el-table"),U=r("el-empty"),ne=r("el-card"),z=ie("loading");return _(),B("div",null,[t(n,{onBack:K,title:"返回打包产品列表"},{content:o(()=>{var l;return[h("span",null,"价格管理 - "+m(((l=c.value)==null?void 0:l.product_name)||"加载中..."),1)]}),_:1}),L((_(),b(ne,{style:{"margin-top":"20px"}},{default:o(()=>[c.value?(_(),B("div",fe,[t(i,{title:"产品基本信息",column:2,border:"",style:{"margin-bottom":"20px"}},{default:o(()=>[t(s,{label:"产品名称"},{default:o(()=>[u(m(c.value.product_name),1)]),_:1}),t(s,{label:"产品编码"},{default:o(()=>[u(m(c.value.product_code),1)]),_:1}),t(s,{label:"所属景区"},{default:o(()=>{var l;return[u(m(((l=c.value.scenic_spot)==null?void 0:l.name)||"-"),1)]}),_:1}),t(s,{label:"入住天数"},{default:o(()=>[u(m(c.value.stay_days)+" 天",1)]),_:1}),t(s,{label:"状态"},{default:o(()=>[t(p,{type:c.value.status===1?"success":"danger"},{default:o(()=>[u(m(c.value.status===1?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1})]),_:1}),t(S,null,{default:o(()=>[...e[3]||(e[3]=[u("价格管理操作",-1)])]),_:1}),h("div",ve,[t(V,{type:"primary",onClick:Z,loading:O.value},{default:o(()=>[t(F,null,{default:o(()=>[t(I(pe))]),_:1}),e[4]||(e[4]=u(" 预计算价格（未来60天） ",-1))]),_:1},8,["loading"]),t(V,{type:"success",onClick:ee,loading:$.value},{default:o(()=>[t(F,null,{default:o(()=>[t(I(_e))]),_:1}),e[5]||(e[5]=u(" 重新计算价格 ",-1))]),_:1},8,["loading"]),t(V,{type:"warning",onClick:te,loading:Y.value},{default:o(()=>[t(F,null,{default:o(()=>[t(I(me))]),_:1}),e[6]||(e[6]=u(" 推送价格到OTA ",-1))]),_:1},8,["loading"]),t(ae,{title:"提示",type:"info",closable:!1,style:{"margin-top":"10px"}},{default:o(()=>[...e[7]||(e[7]=[h("div",null,[h("p",null,"• 预计算价格：为产品计算未来60天的价格日历"),h("p",null,"• 重新计算价格：当门票或酒店价格变更后，重新计算产品价格"),h("p",null,"• 价格公式：酒店价格 + Σ(门票价格 × 张数)")],-1)])]),_:1})]),t(S,null,{default:o(()=>[...e[8]||(e[8]=[u("价格日历",-1)])]),_:1}),h("div",ge,[t(le,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=l=>f.value=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{"margin-right":"10px"},onChange:x},null,8,["modelValue"]),t(H,{modelValue:g.value,"onUpdate:modelValue":e[1]||(e[1]=l=>g.value=l),placeholder:"筛选酒店",clearable:"",style:{width:"200px","margin-right":"10px"},onChange:x},{default:o(()=>[(_(!0),B(G,null,j(E.value,l=>(_(),b(N,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(H,{modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=l=>k.value=l),placeholder:"筛选房型",clearable:"",style:{width:"200px","margin-right":"10px"},onChange:x},{default:o(()=>[(_(!0),B(G,null,j(T.value,l=>(_(),b(N,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(V,{onClick:X},{default:o(()=>[...e[9]||(e[9]=[u("重置筛选",-1)])]),_:1})]),L((_(),b(oe,{data:A.value,border:"",style:{width:"100%"},"max-height":"600"},{default:o(()=>[t(y,{prop:"biz_date",label:"日期",width:"120",fixed:"left"}),t(y,{prop:"hotel.name",label:"酒店",width:"150"}),t(y,{prop:"room_type.name",label:"房型",width:"150"}),t(y,{prop:"composite_code",label:"OTA编码",width:"250","show-overflow-tooltip":""},{default:o(({row:l})=>[t(p,{size:"small"},{default:o(()=>[u(m(l.composite_code),1)]),_:2},1024)]),_:1}),t(y,{prop:"sale_price",label:"销售价",width:"120",align:"right"},{default:o(({row:l})=>[u(" ¥"+m(R(l.sale_price)),1)]),_:1}),t(y,{prop:"cost_price",label:"成本价",width:"120",align:"right"},{default:o(({row:l})=>[u(" ¥"+m(R(l.cost_price)),1)]),_:1}),t(y,{prop:"last_updated_at",label:"更新时间",width:"180"},{default:o(({row:l})=>[u(m(Q(l.last_updated_at)),1)]),_:1})]),_:1},8,["data"])),[[z,C.value]]),!C.value&&A.value.length===0?(_(),b(U,{key:0,description:"暂无价格数据，请先预计算价格"})):q("",!0)])):M.value?q("",!0):(_(),b(U,{key:1,description:"产品信息加载失败或不存在"}))]),_:1})),[[z,M.value]])])}}},we=se(ye,[["__scopeId","data-v-a91fff6d"]]);export{we as default};
