import{_ as ct,r as g,A as X,i as ft,j as vt,c as w,o as u,b as s,m as ne,w as a,d as h,l as yt,q as k,k as $,x as gt,E as y,e as kt,f as V,s as B,h as o,t as m,F as W,p as G,v as E}from"./app-DOnxzBSC.js";const bt={key:0},ht={style:{"margin-bottom":"20px",display:"flex","align-items":"center",gap:"10px","flex-wrap":"wrap"}},wt={style:{display:"flex","align-items":"center",gap:"10px",width:"100%"}},Vt={style:{"font-weight":"bold"}},Rt={style:{"margin-left":"auto",color:"#909399","font-size":"12px"}},xt={key:0},$t={key:1},Dt={style:{"margin-left":"10px",color:"#909399","font-size":"12px"}},jt={key:0},Ct={key:1},Pt={key:0},Tt={key:1},Ft={key:2},Ot={key:3},Ut={style:{"margin-bottom":"20px"}},zt={key:0},Bt={key:1,style:{color:"#909399"}},Et={key:2,style:{"margin-left":"10px"}},At={key:3,style:{"margin-left":"10px",color:"#909399"}},It={style:{"margin-bottom":"20px"}},St={key:0},Yt={key:1,style:{color:"#909399"}},Mt={__name:"Detail",setup(qt){const re=gt(),ge=kt(),ie=g(!1),Ce=g(!1),Pe=g(!1),Te=g(!1),_=g(null),S=g([]),ke=g([]),oe=g([]),be=g("prices"),A=g(!1),Z=g(!1),ee=g(null),R=g({room_type_ids:[],market_price:0,settlement_price:0,sale_price:0}),P=g(null),z=g(null),Y=g(null),te=g([]),M=g(!1),ue=g(!1),ae=g(null),c=g({name:"",weekdays:[],dateRange:null,market_price_adjustment:0,settlement_price_adjustment:0,sale_price_adjustment:0,is_active:!0,items:[{hotel_id:null,room_type_id:null}]}),q=g(null),le=g([]),de=g([]),J=g([]),pe=g([]),K=g(!1),_e=g(!1),N=g({ota_platform_id:null}),T=g({}),Fe={room_type_ids:[{required:!0,message:"请至少选择一个房型",trigger:"change",validator:(l,e,n)=>{!e||e.length===0?n(new Error("请至少选择一个房型")):n()}}],market_price:[{required:!0,message:"请输入门市价",trigger:"blur"}],settlement_price:[{required:!0,message:"请输入结算价",trigger:"blur"}],sale_price:[{required:!0,message:"请输入销售价",trigger:"blur"}]},Oe={name:[{required:!0,message:"请输入规则名称",trigger:"blur"}],weekdays:[{validator:(l,e,n)=>{n()},trigger:"change"}],dateRange:[{validator:(l,e,n)=>{e&&e.length!==2?n(new Error("请选择完整的日期区间")):!e&&(!c.value.weekdays||c.value.weekdays.length===0)?n(new Error("请至少设置日期范围或周几")):n()},trigger:"change"}],market_price_adjustment:[{required:!0,message:"请输入门市价调整",trigger:"blur"}],settlement_price_adjustment:[{required:!0,message:"请输入结算价调整",trigger:"blur"}],sale_price_adjustment:[{required:!0,message:"请输入销售价调整",trigger:"blur"}],items:[{validator:(l,e,n)=>{!e||e.length===0?n(new Error("请至少添加一个适用房型")):e.some(i=>!i.hotel_id||!i.room_type_id)?n(new Error("请完善所有房型信息")):n()},trigger:"change"}]},Ue=X(()=>P.value?"编辑价格":"添加价格"),ze=X(()=>q.value?"编辑加价规则":"添加加价规则"),Be=X(()=>{if(!S.value||S.value.length===0)return[];const l=[...new Set(S.value.map(n=>n.room_type_id))],e=new Set;return l.forEach(n=>{const r=J.value.find(i=>i.id===n);r&&r.hotel_id&&e.add(r.hotel_id)}),le.value.filter(n=>e.has(n.id))}),Ee=l=>{if(!l)return[];const e=new Set(S.value.map(n=>n.room_type_id));return J.value.filter(n=>n.hotel_id===l&&e.has(n.id))},Ae=X(()=>{let l=S.value||[];if(z.value&&(l=l.filter(e=>e.room_type_id===z.value)),Y.value&&Y.value.length===2){const[e,n]=Y.value;l=l.filter(r=>{const i=r.date;return i>=e&&i<=n})}return l}),he=X(()=>{const l={};return Ae.value.forEach(e=>{const n=e.room_type_id;if(!l[n]){const r=J.value.find(f=>f.id===n),i=le.value.find(f=>f.id===(r==null?void 0:r.hotel_id));l[n]={roomTypeId:n,hotelId:r==null?void 0:r.hotel_id,hotelName:(i==null?void 0:i.name)||"未知酒店",roomTypeName:(r==null?void 0:r.name)||"未知房型",prices:[],dateRanges:[]}}l[n].prices.push(e)}),Object.values(l).forEach(e=>{e.prices.sort((r,i)=>new Date(r.date)-new Date(i.date));const n={};e.prices.forEach(r=>{const i=`${r.market_price}_${r.settlement_price}_${r.sale_price}_${r.source}`;n[i]||(n[i]={market_price:r.market_price,settlement_price:r.settlement_price,sale_price:r.sale_price,source:r.source,dates:[]}),n[i].dates.push(r.date)}),e.dateRanges=Object.values(n).map(r=>{const i=r.dates.sort();let f=[],d=i[0],v=i[0];for(let x=1;x<i.length;x++){const O=new Date(i[x]),L=new Date(i[x-1]);(O-L)/(1e3*60*60*24)===1||(f.push({start:d,end:v,...r}),d=i[x]),v=i[x]}return f.push({start:d,end:v,...r}),f}).flat()}),Object.values(l).forEach(e=>{if(e.prices.length>0){const n=e.prices.map(r=>r.date).sort();e.dateRange=`${C(n[0])} 至 ${C(n[n.length-1])}`}else e.dateRange="-"}),Object.values(l)}),Ie=()=>{ge.push("/products")},F=async()=>{var l,e,n,r,i,f,d;ie.value=!0;try{const v=await $.get(`/products/${re.params.id}`);if(!v.data||!v.data.data)throw new Error("返回数据格式错误");_.value=v.data.data,S.value=_.value.prices||[],ke.value=_.value.price_rules||[],oe.value=_.value.ota_products||[],_.value&&_.value.scenic_spot_id&&(await Re(),await xe())}catch(v){const x=((e=(l=v.response)==null?void 0:l.data)==null?void 0:e.message)||((r=(n=v.response)==null?void 0:n.data)==null?void 0:r.error)||v.message||"获取产品详情失败";y.error(x),console.error("获取产品详情失败:",{error:v,response:v.response,status:(i=v.response)==null?void 0:i.status,data:(f=v.response)==null?void 0:f.data}),((d=v.response)==null?void 0:d.status)===403&&setTimeout(()=>{ge.push("/products")},2e3)}finally{ie.value=!1}},we=l=>l?new Date(l).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",C=l=>{if(!l)return"";const e=new Date(l),n=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${n}-${r}-${i}`},U=l=>l?parseFloat(l).toFixed(2):"0.00",Se=l=>{if(!l)return"";const e={1:"一",2:"二",3:"三",4:"四",5:"五",6:"六",7:"日"};return l.split(",").map(n=>e[n]||n).join("、")},Ye=()=>{if(!_.value.sale_start_date||!_.value.sale_end_date){y.warning("请先在产品编辑页面设置销售开始日期和结束日期");return}P.value=null,me(),A.value=!0},Ve=l=>{P.value=l.id,R.value={room_type_ids:[l.room_type_id],market_price:parseFloat(l.market_price),settlement_price:parseFloat(l.settlement_price),sale_price:parseFloat(l.sale_price)},A.value=!0},Me=async l=>{try{await E.confirm("确定要删除该价格记录吗？","提示",{type:"warning"}),await $.delete(`/prices/${l.id}`),y.success("删除成功"),F()}catch(e){e!=="cancel"&&y.error("删除失败")}},qe=(l,e)=>{const n=l.prices.filter(r=>{const i=r.date;return i>=e.start&&i<=e.end});if(n.length!==0){if(n.length===1){Ve(n[0]);return}E.confirm(`该日期范围包含 ${n.length} 天的价格记录。是否批量编辑为相同价格？`,"批量编辑",{confirmButtonText:"批量编辑",cancelButtonText:"取消",type:"info"}).then(()=>{const r=n[0];P.value=null,R.value={room_type_ids:[l.roomTypeId],market_price:parseFloat(r.market_price),settlement_price:parseFloat(r.settlement_price),sale_price:parseFloat(r.sale_price)},A.value=!0}).catch(()=>{})}},Ne=async(l,e)=>{try{const n=l.prices.filter(r=>{const i=r.date;return i>=e.start&&i<=e.end});if(n.length===0)return;await E.confirm(`确定要删除该日期范围（${C(e.start)} 至 ${C(e.end)}）的 ${n.length} 条价格记录吗？`,"提示",{type:"warning"}),await Promise.all(n.map(r=>$.delete(`/prices/${r.id}`))),y.success("删除成功"),F()}catch(n){n!=="cancel"&&y.error("删除失败")}},Re=async()=>{try{const l=await $.get("/hotels",{params:{scenic_spot_id:_.value.scenic_spot_id,per_page:1e3}});le.value=l.data.data||[]}catch(l){console.error("获取酒店列表失败",l)}},xe=async()=>{try{const l=await $.get("/room-types",{params:{per_page:1e3}});J.value=l.data.data||[],de.value=J.value.filter(e=>le.value.some(n=>n.id===e.hotel_id))}catch(l){console.error("获取房型列表失败",l)}},$e=()=>{z.value&&!te.value.includes(z.value)&&te.value.push(z.value)},Le=()=>{z.value=null,Y.value=null},He=async()=>{ee.value&&await ee.value.validate(async l=>{var e,n;if(l){Z.value=!0;try{if(P.value)await $.put(`/prices/${P.value}`,{market_price:R.value.market_price,settlement_price:R.value.settlement_price,sale_price:R.value.sale_price}),y.success("价格更新成功");else{if(!_.value.sale_start_date||!_.value.sale_end_date){y.warning("请先在产品编辑页面设置销售开始日期和结束日期"),Z.value=!1;return}const r=_.value.sale_start_date,i=_.value.sale_end_date,f=[],d=new Date(r),v=new Date(i);for(let O=new Date(d);O<=v;O.setDate(O.getDate()+1))f.push({date:O.toISOString().split("T")[0],market_price:R.value.market_price,settlement_price:R.value.settlement_price,sale_price:R.value.sale_price});const x=R.value.room_type_ids.map(O=>$.post("/prices",{product_id:_.value.id,room_type_id:O,prices:f}));await Promise.all(x),y.success(`成功为 ${R.value.room_type_ids.length} 个房型创建价格`)}A.value=!1,me(),F()}catch(r){const i=((n=(e=r.response)==null?void 0:e.data)==null?void 0:n.message)||"操作失败";y.error(i)}finally{Z.value=!1}}})},me=()=>{var l;R.value={room_type_ids:[],market_price:0,settlement_price:0,sale_price:0},P.value=null,(l=ee.value)==null||l.clearValidate()},We=()=>{q.value=null,ce(),M.value=!0},Ge=async l=>{q.value=l.id;try{const e=l.items?l:(await $.get(`/price-rules/${l.id}`)).data.data||l;let n=null,r=[];e.type==="weekday"?(r=e.weekdays?e.weekdays.split(","):[],n=null):e.type==="date_range"?(n=e.start_date&&e.end_date?[e.start_date,e.end_date]:null,r=[]):(n=e.start_date&&e.end_date?[e.start_date,e.end_date]:null,r=e.weekdays?e.weekdays.split(","):[]),c.value={name:e.name||"",weekdays:r,dateRange:n,market_price_adjustment:parseFloat(e.market_price_adjustment)||0,settlement_price_adjustment:parseFloat(e.settlement_price_adjustment)||0,sale_price_adjustment:parseFloat(e.sale_price_adjustment)||0,is_active:e.is_active??!0,items:e.items&&e.items.length>0?e.items.map(i=>({hotel_id:i.hotel_id,room_type_id:i.room_type_id})):[{hotel_id:null,room_type_id:null}]},M.value=!0}catch{y.error("获取加价规则详情失败")}},Je=async l=>{try{await E.confirm("确定要删除该加价规则吗？","提示",{type:"warning"}),await $.delete(`/price-rules/${l.id}`),y.success("删除成功"),F()}catch(e){e!=="cancel"&&y.error("删除失败")}},Ke=()=>{c.value.items.push({hotel_id:null,room_type_id:null})},Qe=l=>{c.value.items.splice(l,1)},Xe=l=>{c.value.items[l].room_type_id=null},Ze=async()=>{ae.value&&await ae.value.validate(async l=>{var e,n;if(l){if(!c.value.dateRange&&(!c.value.weekdays||c.value.weekdays.length===0)){y.error("请至少设置日期范围或周几");return}ue.value=!0;try{const r={product_id:_.value.id,name:c.value.name,type:"combined",market_price_adjustment:c.value.market_price_adjustment,settlement_price_adjustment:c.value.settlement_price_adjustment,sale_price_adjustment:c.value.sale_price_adjustment,is_active:c.value.is_active,items:c.value.items};c.value.dateRange&&c.value.dateRange.length===2&&(r.start_date=c.value.dateRange[0],r.end_date=c.value.dateRange[1]),c.value.weekdays&&c.value.weekdays.length>0&&(r.weekdays=c.value.weekdays.join(",")),q.value?(await $.put(`/price-rules/${q.value}`,r),y.success("加价规则更新成功")):(await $.post("/price-rules",r),y.success("加价规则创建成功")),M.value=!1,ce(),F()}catch(r){const i=((n=(e=r.response)==null?void 0:e.data)==null?void 0:n.message)||"操作失败";y.error(i)}finally{ue.value=!1}}})},ce=()=>{var l;c.value={name:"",weekdays:[],dateRange:null,market_price_adjustment:0,settlement_price_adjustment:0,sale_price_adjustment:0,is_active:!0,items:[{hotel_id:null,room_type_id:null}]},q.value=null,(l=ae.value)==null||l.clearValidate()},et=async()=>{try{const l=await $.get("/ota-platforms",{params:{active_only:!0}});pe.value=l.data.data||[]}catch(l){console.error("获取OTA平台列表失败",l)}},tt=()=>{N.value={ota_platform_id:null},K.value=!0},at=async()=>{var l,e;if(!N.value.ota_platform_id){y.warning("请选择OTA平台");return}_e.value=!0;try{const n=await $.post(`/products/${re.params.id}/bind-ota`,{ota_platform_id:N.value.ota_platform_id});n.data.success?(y.success("绑定成功"),K.value=!1,F()):y.error(n.data.message||"绑定失败")}catch(n){const r=((e=(l=n.response)==null?void 0:l.data)==null?void 0:e.message)||"绑定失败";y.error(r)}finally{_e.value=!1}},lt=async l=>{var e,n,r,i;try{await E.confirm(`确定要推送产品到 ${(e=l.ota_platform)==null?void 0:e.name} 吗？`,"确认推送",{type:"warning",confirmButtonText:"确定推送",cancelButtonText:"取消"});const f=await $.post(`/ota-products/${l.id}/push`);f.data.success?(f.data.message&&f.data.message.includes("后台处理")?y.success("推送任务已提交，正在后台处理中"):y.success("推送成功"),f.data.data&&(l.push_status=f.data.data.push_status,l.push_started_at=f.data.data.push_started_at),((n=f.data.data)==null?void 0:n.push_status)==="processing"?rt(l.id):F()):y.error(f.data.message||"推送失败")}catch(f){if(f!=="cancel"){const d=((i=(r=f.response)==null?void 0:r.data)==null?void 0:i.message)||"推送失败";y.error(d)}}},st=async l=>{var e,n,r;try{!l.pushed_at?await E.prompt("请选择OTA平台","编辑OTA产品",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"select",inputOptions:pe.value.reduce((f,d)=>(f[d.id]=d.name,f),{}),inputValue:(e=l.ota_platform_id)==null?void 0:e.toString()}).then(async({value:f})=>{const d=parseInt(f);await $.put(`/ota-products/${l.id}`,{ota_platform_id:d,is_active:l.is_active}),y.success("更新成功"),F()}):await E.prompt("请选择状态","编辑OTA产品",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"select",inputOptions:{true:"启用",false:"禁用"},inputValue:l.is_active?"true":"false"}).then(async({value:f})=>{const d=f==="true";await $.put(`/ota-products/${l.id}`,{is_active:d}),y.success("更新成功"),F()})}catch(i){if(i!=="cancel"){const f=((r=(n=i.response)==null?void 0:n.data)==null?void 0:r.message)||"更新失败";y.error(f)}}},nt=async l=>{var e,n;try{await E.confirm("确定要删除该OTA推送记录吗？","提示",{type:"warning"}),await $.delete(`/ota-products/${l.id}`),y.success("删除成功"),F()}catch(r){if(r!=="cancel"){const i=((n=(e=r.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败";y.error(i)}}},rt=l=>{T.value[l]&&clearInterval(T.value[l]),T.value[l]=setInterval(async()=>{var e,n,r,i;try{const d=(n=(e=(await $.get(`/products/${re.params.id}`)).data.data)==null?void 0:e.ota_products)==null?void 0:n.find(v=>v.id===l);if(d){const v=oe.value.find(x=>x.id===l);v&&(v.push_status=d.push_status,v.push_message=d.push_message,v.push_completed_at=d.push_completed_at),d.push_status!=="processing"&&(clearInterval(T.value[l]),delete T.value[l],d.push_status==="success"?y.success(`产品 ${(r=d.ota_platform)==null?void 0:r.name} 推送成功`):d.push_status==="failed"&&y.error(`产品 ${(i=d.ota_platform)==null?void 0:i.name} 推送失败：${d.push_message||"未知错误"}`))}else clearInterval(T.value[l]),delete T.value[l]}catch(f){console.error("轮询推送状态失败",f),clearInterval(T.value[l]),delete T.value[l]}},3e3)},it=()=>{Object.values(T.value).forEach(l=>{clearInterval(l)}),T.value={}};return ft(async()=>{await F(),await et(),_.value&&(await Re(),await xe())}),vt(()=>{it()}),(l,e)=>{const n=h("el-page-header"),r=h("el-descriptions-item"),i=h("el-tag"),f=h("el-descriptions"),d=h("el-button"),v=h("el-option"),x=h("el-select"),O=h("el-date-picker"),L=h("el-alert"),b=h("el-table-column"),Q=h("el-table"),De=h("el-collapse-item"),je=h("el-collapse"),ot=h("el-empty"),j=h("el-form-item"),H=h("el-input-number"),fe=h("el-form"),ve=h("el-dialog"),ye=h("el-tab-pane"),ut=h("el-input"),I=h("el-checkbox"),dt=h("el-checkbox-group"),pt=h("el-switch"),_t=h("el-tabs"),mt=h("el-card"),se=yt("loading");return u(),w("div",null,[s(n,{onBack:Ie,title:"返回产品列表"},{content:a(()=>[...e[22]||(e[22]=[V("span",null,"产品详情",-1)])]),_:1}),ne((u(),k(mt,{style:{"margin-top":"20px"}},{default:a(()=>[_.value?(u(),w("div",bt,[s(f,{title:"产品基本信息",column:2,border:""},{default:a(()=>[s(r,{label:"产品名称"},{default:a(()=>[o(m(_.value.name),1)]),_:1}),s(r,{label:"产品编码"},{default:a(()=>[o(m(_.value.code),1)]),_:1}),s(r,{label:"所属景区"},{default:a(()=>{var t;return[o(m(((t=_.value.scenic_spot)==null?void 0:t.name)||"-"),1)]}),_:1}),s(r,{label:"价格来源"},{default:a(()=>[s(i,{type:_.value.price_source==="manual"?"primary":"success"},{default:a(()=>[o(m(_.value.price_source==="manual"?"人工维护":"接口推送"),1)]),_:1},8,["type"])]),_:1}),s(r,{label:"状态"},{default:a(()=>[s(i,{type:_.value.is_active?"success":"danger"},{default:a(()=>[o(m(_.value.is_active?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),s(r,{label:"入住天数"},{default:a(()=>[o(m(_.value.stay_days?`${_.value.stay_days} 晚`:"单晚"),1)]),_:1}),s(r,{label:"创建时间"},{default:a(()=>[o(m(we(_.value.created_at)),1)]),_:1}),s(r,{label:"销售开始日期"},{default:a(()=>[o(m(_.value.sale_start_date?C(_.value.sale_start_date):"不限制"),1)]),_:1}),s(r,{label:"销售结束日期"},{default:a(()=>[o(m(_.value.sale_end_date?C(_.value.sale_end_date):"不限制"),1)]),_:1}),s(r,{label:"产品描述",span:2},{default:a(()=>[o(m(_.value.description||"-"),1)]),_:1})]),_:1}),s(_t,{modelValue:be.value,"onUpdate:modelValue":e[21]||(e[21]=t=>be.value=t),style:{"margin-top":"20px"}},{default:a(()=>[s(ye,{label:"价格管理",name:"prices"},{default:a(()=>[V("div",ht,[_.value.price_source==="manual"?(u(),k(d,{key:0,type:"primary",onClick:Ye},{default:a(()=>[...e[23]||(e[23]=[o(" 添加价格 ",-1)])]),_:1})):B("",!0),s(x,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=t=>z.value=t),placeholder:"筛选房型",clearable:"",style:{width:"200px"},onChange:$e},{default:a(()=>[(u(!0),w(W,null,G(de.value,t=>{var p;return u(),k(v,{key:t.id,label:`${((p=t.hotel)==null?void 0:p.name)||""} - ${t.name}`,value:t.id},null,8,["label","value"])}),128))]),_:1},8,["modelValue"]),s(O,{modelValue:Y.value,"onUpdate:modelValue":e[1]||(e[1]=t=>Y.value=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"},onChange:$e},null,8,["modelValue"]),s(d,{onClick:Le,size:"small"},{default:a(()=>[...e[24]||(e[24]=[o("重置筛选",-1)])]),_:1}),_.value.price_source!=="manual"?(u(),k(L,{key:1,title:"提示",type:"info",description:"该产品的价格由接口推送，无法手动管理",closable:!1,style:{flex:"1"}})):B("",!0)]),ne((u(),w("div",null,[he.value.length>0?(u(),k(je,{key:0,modelValue:te.value,"onUpdate:modelValue":e[2]||(e[2]=t=>te.value=t)},{default:a(()=>[(u(!0),w(W,null,G(he.value,t=>(u(),k(De,{key:t.roomTypeId,name:t.roomTypeId},{title:a(()=>[V("div",wt,[V("span",Vt,m(t.hotelName)+" - "+m(t.roomTypeName),1),s(i,{size:"small",type:"info"},{default:a(()=>[o(m(t.prices.length)+" 条价格记录 ",1)]),_:2},1024),V("span",Rt," 日期范围: "+m(t.dateRange),1)])]),default:a(()=>[s(Q,{data:t.dateRanges,border:"",size:"small",style:{"margin-top":"10px"}},{default:a(()=>[s(b,{label:"日期范围",width:"200"},{default:a(({row:p})=>[p.start===p.end?(u(),w("span",xt,m(C(p.start)),1)):(u(),w("span",$t,m(C(p.start))+" 至 "+m(C(p.end)),1))]),_:1}),s(b,{prop:"market_price",label:"门市价（元）",width:"120"},{default:a(({row:p})=>[o(m(U(p.market_price)),1)]),_:1}),s(b,{prop:"settlement_price",label:"结算价（元）",width:"120"},{default:a(({row:p})=>[o(m(U(p.settlement_price)),1)]),_:1}),s(b,{prop:"sale_price",label:"销售价（元）",width:"120"},{default:a(({row:p})=>[o(m(U(p.sale_price)),1)]),_:1}),s(b,{prop:"source",label:"来源",width:"100"},{default:a(({row:p})=>[s(i,{type:p.source==="manual"?"primary":"success",size:"small"},{default:a(()=>[o(m(p.source==="manual"?"人工":"接口"),1)]),_:2},1032,["type"])]),_:1}),_.value.price_source==="manual"?(u(),k(b,{key:0,label:"操作",width:"200"},{default:a(({row:p})=>[s(d,{size:"small",onClick:D=>qe(t,p)},{default:a(()=>[...e[25]||(e[25]=[o("编辑",-1)])]),_:1},8,["onClick"]),s(d,{size:"small",type:"danger",onClick:D=>Ne(t,p)},{default:a(()=>[...e[26]||(e[26]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:2},1024)):B("",!0)]),_:2},1032,["data"]),t.dateRanges.length>0?(u(),k(je,{key:0,style:{"margin-top":"10px"}},{default:a(()=>[s(De,{title:"查看详细日期列表",name:`detail-${t.roomTypeId}`},{default:a(()=>[s(Q,{data:t.prices,border:"",size:"small"},{default:a(()=>[s(b,{prop:"date",label:"日期",width:"120"}),s(b,{prop:"market_price",label:"门市价（元）",width:"120"},{default:a(({row:p})=>[o(m(U(p.market_price)),1)]),_:1}),s(b,{prop:"settlement_price",label:"结算价（元）",width:"120"},{default:a(({row:p})=>[o(m(U(p.settlement_price)),1)]),_:1}),s(b,{prop:"sale_price",label:"销售价（元）",width:"120"},{default:a(({row:p})=>[o(m(U(p.sale_price)),1)]),_:1}),s(b,{prop:"source",label:"来源",width:"100"},{default:a(({row:p})=>[s(i,{type:p.source==="manual"?"primary":"success",size:"small"},{default:a(()=>[o(m(p.source==="manual"?"人工":"接口"),1)]),_:2},1032,["type"])]),_:1}),_.value.price_source==="manual"?(u(),k(b,{key:0,label:"操作",width:"150"},{default:a(({row:p})=>[s(d,{size:"small",onClick:D=>Ve(p)},{default:a(()=>[...e[27]||(e[27]=[o("编辑",-1)])]),_:1},8,["onClick"]),s(d,{size:"small",type:"danger",onClick:D=>Me(p)},{default:a(()=>[...e[28]||(e[28]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:1})):B("",!0)]),_:1},8,["data"])]),_:2},1032,["name"])]),_:2},1024)):B("",!0)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"])):(u(),k(ot,{key:1,description:"暂无价格数据"}))])),[[se,Ce.value]]),s(ve,{modelValue:A.value,"onUpdate:modelValue":e[8]||(e[8]=t=>A.value=t),title:Ue.value,width:"600px",onClose:me},{footer:a(()=>[s(d,{onClick:e[7]||(e[7]=t=>A.value=!1)},{default:a(()=>[...e[32]||(e[32]=[o("取消",-1)])]),_:1}),s(d,{type:"primary",onClick:He,loading:Z.value},{default:a(()=>[...e[33]||(e[33]=[o("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[s(fe,{ref_key:"priceFormRef",ref:ee,model:R.value,rules:Fe,"label-width":"120px"},{default:a(()=>[s(j,{label:"选择房型",prop:"room_type_ids"},{default:a(()=>[s(x,{modelValue:R.value.room_type_ids,"onUpdate:modelValue":e[3]||(e[3]=t=>R.value.room_type_ids=t),multiple:!P.value,disabled:!!P.value,placeholder:P.value?"编辑模式下不可修改房型":"请选择房型（可多选）",style:{width:"100%"}},{default:a(()=>[(u(!0),w(W,null,G(de.value,t=>{var p;return u(),k(v,{key:t.id,label:`${(p=t.hotel)==null?void 0:p.name} - ${t.name}`,value:t.id},null,8,["label","value"])}),128))]),_:1},8,["modelValue","multiple","disabled","placeholder"]),V("span",Dt,[P.value?(u(),w("span",jt,"编辑模式下只能修改价格，不能修改房型")):(u(),w("span",Ct,"可同时为多个房型设置价格"))])]),_:1}),s(j,{label:"日期范围"},{default:a(()=>[_.value.sale_start_date||_.value.sale_end_date?(u(),k(L,{key:0,type:"info",closable:!1},{title:a(()=>[e[29]||(e[29]=V("span",null,"将使用产品的销售日期范围：",-1)),_.value.sale_start_date?(u(),w("span",Pt,m(C(_.value.sale_start_date)),1)):(u(),w("span",Tt,"不限制")),e[30]||(e[30]=V("span",null," 至 ",-1)),_.value.sale_end_date?(u(),w("span",Ft,m(C(_.value.sale_end_date)),1)):(u(),w("span",Ot,"不限制"))]),_:1})):(u(),k(L,{key:1,type:"warning",closable:!1},{title:a(()=>[...e[31]||(e[31]=[V("span",null,"产品未设置销售日期范围，请先在产品编辑页面设置销售开始日期和结束日期",-1)])]),_:1}))]),_:1}),s(j,{label:"门市价（元）",prop:"market_price"},{default:a(()=>[s(H,{modelValue:R.value.market_price,"onUpdate:modelValue":e[4]||(e[4]=t=>R.value.market_price=t),min:0,precision:2,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),s(j,{label:"结算价（元）",prop:"settlement_price"},{default:a(()=>[s(H,{modelValue:R.value.settlement_price,"onUpdate:modelValue":e[5]||(e[5]=t=>R.value.settlement_price=t),min:0,precision:2,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),s(j,{label:"销售价（元）",prop:"sale_price"},{default:a(()=>[s(H,{modelValue:R.value.sale_price,"onUpdate:modelValue":e[6]||(e[6]=t=>R.value.sale_price=t),min:0,precision:2,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1}),s(ye,{label:"加价规则",name:"priceRules"},{default:a(()=>[V("div",Ut,[_.value.price_source==="manual"?(u(),k(d,{key:0,type:"primary",onClick:We},{default:a(()=>[...e[34]||(e[34]=[o(" 添加加价规则 ",-1)])]),_:1})):(u(),k(L,{key:1,title:"提示",type:"info",description:"该产品的价格由接口推送，无法设置加价规则",closable:!1,style:{"margin-bottom":"20px"}}))]),ne((u(),k(Q,{data:ke.value,border:""},{default:a(()=>[s(b,{prop:"name",label:"规则名称",width:"150"}),s(b,{prop:"type",label:"规则类型",width:"120"},{default:a(({row:t})=>[t.type==="weekday"?(u(),k(i,{key:0},{default:a(()=>[...e[35]||(e[35]=[o("周几规则",-1)])]),_:1})):t.type==="date_range"?(u(),k(i,{key:1},{default:a(()=>[...e[36]||(e[36]=[o("日期区间规则",-1)])]),_:1})):(u(),k(i,{key:2,type:"success"},{default:a(()=>[...e[37]||(e[37]=[o("统一规则",-1)])]),_:1}))]),_:1}),s(b,{label:"规则内容",width:"300"},{default:a(({row:t})=>[V("div",null,[t.start_date&&t.end_date?(u(),w("span",zt,m(C(t.start_date))+" 至 "+m(C(t.end_date)),1)):(u(),w("span",Bt,"全时段")),t.weekdays?(u(),w("span",Et," 周"+m(Se(t.weekdays)),1)):t.start_date||t.end_date?(u(),w("span",At," （所有日期） ")):B("",!0)])]),_:1}),s(b,{label:"价格调整",width:"300"},{default:a(({row:t})=>[V("div",null,[V("span",null,"门市价: "+m(t.market_price_adjustment>=0?"+":"")+m(U(t.market_price_adjustment)),1),e[38]||(e[38]=V("br",null,null,-1)),V("span",null,"结算价: "+m(t.settlement_price_adjustment>=0?"+":"")+m(U(t.settlement_price_adjustment)),1),e[39]||(e[39]=V("br",null,null,-1)),V("span",null,"销售价: "+m(t.sale_price_adjustment>=0?"+":"")+m(U(t.sale_price_adjustment)),1)])]),_:1}),s(b,{prop:"is_active",label:"状态",width:"100"},{default:a(({row:t})=>[s(i,{type:t.is_active?"success":"danger"},{default:a(()=>[o(m(t.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),_.value.price_source==="manual"?(u(),k(b,{key:0,label:"操作",width:"200"},{default:a(({row:t})=>[s(d,{size:"small",onClick:p=>Ge(t)},{default:a(()=>[...e[40]||(e[40]=[o("编辑",-1)])]),_:1},8,["onClick"]),s(d,{size:"small",type:"danger",onClick:p=>Je(t)},{default:a(()=>[...e[41]||(e[41]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:1})):B("",!0)]),_:1},8,["data"])),[[se,Pe.value]]),s(ve,{modelValue:M.value,"onUpdate:modelValue":e[17]||(e[17]=t=>M.value=t),title:ze.value,width:"700px",onClose:ce},{footer:a(()=>[s(d,{onClick:e[16]||(e[16]=t=>M.value=!1)},{default:a(()=>[...e[54]||(e[54]=[o("取消",-1)])]),_:1}),s(d,{type:"primary",onClick:Ze,loading:ue.value},{default:a(()=>[...e[55]||(e[55]=[o("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[s(fe,{ref_key:"priceRuleFormRef",ref:ae,model:c.value,rules:Oe,"label-width":"140px"},{default:a(()=>[s(j,{label:"规则名称",prop:"name"},{default:a(()=>[s(ut,{modelValue:c.value.name,"onUpdate:modelValue":e[9]||(e[9]=t=>c.value.name=t),placeholder:"请输入规则名称"},null,8,["modelValue"])]),_:1}),s(j,{label:"日期范围（可选）",prop:"dateRange"},{default:a(()=>[s(O,{modelValue:c.value.dateRange,"onUpdate:modelValue":e[10]||(e[10]=t=>c.value.dateRange=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",style:{width:"100%"},format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"]),e[42]||(e[42]=V("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 不选择表示全时段生效 ",-1))]),_:1}),s(j,{label:"选择周几（可选）",prop:"weekdays"},{default:a(()=>[s(dt,{modelValue:c.value.weekdays,"onUpdate:modelValue":e[11]||(e[11]=t=>c.value.weekdays=t)},{default:a(()=>[s(I,{label:"1"},{default:a(()=>[...e[43]||(e[43]=[o("周一",-1)])]),_:1}),s(I,{label:"2"},{default:a(()=>[...e[44]||(e[44]=[o("周二",-1)])]),_:1}),s(I,{label:"3"},{default:a(()=>[...e[45]||(e[45]=[o("周三",-1)])]),_:1}),s(I,{label:"4"},{default:a(()=>[...e[46]||(e[46]=[o("周四",-1)])]),_:1}),s(I,{label:"5"},{default:a(()=>[...e[47]||(e[47]=[o("周五",-1)])]),_:1}),s(I,{label:"6"},{default:a(()=>[...e[48]||(e[48]=[o("周六",-1)])]),_:1}),s(I,{label:"7"},{default:a(()=>[...e[49]||(e[49]=[o("周日",-1)])]),_:1})]),_:1},8,["modelValue"]),e[50]||(e[50]=V("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 不选择表示日期范围内的所有日期都生效 ",-1))]),_:1}),s(j,{label:"门市价调整（元）",prop:"market_price_adjustment"},{default:a(()=>[s(H,{modelValue:c.value.market_price_adjustment,"onUpdate:modelValue":e[12]||(e[12]=t=>c.value.market_price_adjustment=t),precision:2,style:{width:"100%"}},null,8,["modelValue"]),e[51]||(e[51]=V("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 正数表示加价，负数表示减价 ",-1))]),_:1}),s(j,{label:"结算价调整（元）",prop:"settlement_price_adjustment"},{default:a(()=>[s(H,{modelValue:c.value.settlement_price_adjustment,"onUpdate:modelValue":e[13]||(e[13]=t=>c.value.settlement_price_adjustment=t),precision:2,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),s(j,{label:"销售价调整（元）",prop:"sale_price_adjustment"},{default:a(()=>[s(H,{modelValue:c.value.sale_price_adjustment,"onUpdate:modelValue":e[14]||(e[14]=t=>c.value.sale_price_adjustment=t),precision:2,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),s(j,{label:"适用房型",prop:"items"},{default:a(()=>[s(Q,{data:c.value.items,border:"",style:{width:"100%"}},{default:a(()=>[s(b,{label:"酒店",width:"200"},{default:a(({row:t,$index:p})=>[s(x,{modelValue:t.hotel_id,"onUpdate:modelValue":D=>t.hotel_id=D,placeholder:"请选择酒店",style:{width:"100%"},onChange:D=>Xe(p)},{default:a(()=>[(u(!0),w(W,null,G(Be.value,D=>(u(),k(v,{key:D.id,label:D.name,value:D.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),s(b,{label:"房型",width:"200"},{default:a(({row:t,$index:p})=>[s(x,{modelValue:t.room_type_id,"onUpdate:modelValue":D=>t.room_type_id=D,placeholder:"请选择房型",style:{width:"100%"}},{default:a(()=>[(u(!0),w(W,null,G(Ee(t.hotel_id),D=>(u(),k(v,{key:D.id,label:D.name,value:D.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:1}),s(b,{label:"操作",width:"100"},{default:a(({$index:t})=>[s(d,{size:"small",type:"danger",onClick:p=>Qe(t)},{default:a(()=>[...e[52]||(e[52]=[o(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),s(d,{type:"primary",size:"small",style:{"margin-top":"10px"},onClick:Ke},{default:a(()=>[...e[53]||(e[53]=[o(" 添加房型 ",-1)])]),_:1})]),_:1}),s(j,{label:"状态",prop:"is_active"},{default:a(()=>[s(pt,{modelValue:c.value.is_active,"onUpdate:modelValue":e[15]||(e[15]=t=>c.value.is_active=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1}),s(ye,{label:"OTA推送",name:"otaProducts"},{default:a(()=>[V("div",It,[s(d,{type:"primary",onClick:tt},{default:a(()=>[...e[56]||(e[56]=[o("绑定OTA平台",-1)])]),_:1})]),ne((u(),k(Q,{data:oe.value,border:""},{default:a(()=>[s(b,{label:"OTA平台",width:"150"},{default:a(({row:t})=>{var p;return[o(m(((p=t.ota_platform)==null?void 0:p.name)||"-"),1)]}),_:1}),s(b,{label:"OTA产品ID",width:"200"},{default:a(({row:t})=>[t.ota_product_id?(u(),w("span",St,m(t.ota_product_id),1)):(u(),w("span",Yt,"-"))]),_:1}),s(b,{prop:"is_active",label:"状态",width:"100"},{default:a(({row:t})=>[s(i,{type:t.is_active?"success":"danger"},{default:a(()=>[o(m(t.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),s(b,{label:"推送状态",width:"150"},{default:a(({row:t})=>[t.push_status==="processing"?(u(),k(i,{key:0,type:"warning"},{default:a(()=>[...e[57]||(e[57]=[o(" 推送中... ",-1)])]),_:1})):t.push_status==="success"?(u(),k(i,{key:1,type:"success"},{default:a(()=>[...e[58]||(e[58]=[o(" 推送成功 ",-1)])]),_:1})):t.push_status==="failed"?(u(),k(i,{key:2,type:"danger"},{default:a(()=>[...e[59]||(e[59]=[o(" 推送失败 ",-1)])]),_:1})):t.pushed_at?(u(),k(i,{key:3,type:"success"},{default:a(()=>[...e[60]||(e[60]=[o(" 已推送 ",-1)])]),_:1})):(u(),k(i,{key:4,type:"info"},{default:a(()=>[...e[61]||(e[61]=[o(" 未推送 ",-1)])]),_:1}))]),_:1}),s(b,{prop:"pushed_at",label:"推送时间",width:"180"},{default:a(({row:t})=>[o(m(t.pushed_at?we(t.pushed_at):"-"),1)]),_:1}),s(b,{label:"操作",width:"250",fixed:"right"},{default:a(({row:t})=>[s(d,{size:"small",onClick:p=>st(t)},{default:a(()=>[...e[62]||(e[62]=[o("编辑",-1)])]),_:1},8,["onClick"]),s(d,{size:"small",type:"danger",onClick:p=>nt(t)},{default:a(()=>[...e[63]||(e[63]=[o("删除",-1)])]),_:1},8,["onClick"]),s(d,{size:"small",type:"primary",onClick:p=>lt(t),disabled:!t.is_active||t.push_status==="processing",loading:t.push_status==="processing"},{default:a(()=>[o(m(t.push_status==="processing"?"推送中...":t.pushed_at?"重新推送":"推送"),1)]),_:2},1032,["onClick","disabled","loading"])]),_:1})]),_:1},8,["data"])),[[se,Te.value]]),s(ve,{modelValue:K.value,"onUpdate:modelValue":e[20]||(e[20]=t=>K.value=t),title:"绑定OTA平台",width:"500px"},{footer:a(()=>[s(d,{onClick:e[19]||(e[19]=t=>K.value=!1)},{default:a(()=>[...e[64]||(e[64]=[o("取消",-1)])]),_:1}),s(d,{type:"primary",onClick:at,loading:_e.value},{default:a(()=>[...e[65]||(e[65]=[o("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[s(fe,{model:N.value,"label-width":"120px"},{default:a(()=>[s(j,{label:"选择OTA平台",required:""},{default:a(()=>[s(x,{modelValue:N.value.ota_platform_id,"onUpdate:modelValue":e[18]||(e[18]=t=>N.value.ota_platform_id=t),placeholder:"请选择要绑定的OTA平台",style:{width:"100%"}},{default:a(()=>[(u(!0),w(W,null,G(pe.value,t=>(u(),k(v,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])])):B("",!0)]),_:1})),[[se,ie.value]])])}}},Lt=ct(Mt,[["__scopeId","data-v-0f9e9a5d"]]);export{Lt as default};
