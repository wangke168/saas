import{r as B,i as I,c as f,o as p,f as G,b as o,w as r,d as _,k as y,E as l,l as H,h as c,m as J,q as b,t as v,s as x,F as z,v as h}from"./app-DBYwVjCJ.js";const K={key:1,style:{color:"#999"}},Q={key:0},U={key:0,style:{"margin-top":"5px","font-size":"12px",color:"#666"}},W={key:1,style:{color:"#999"}},Z={__name:"Index",setup(X){const $=B([]),C=B(!1),d=B({}),g=async()=>{C.value=!0;try{const t=await y.get("/exception-orders");$.value=t.data.data}catch{l.error("获取异常订单列表失败")}finally{C.value=!1}},j=t=>({api_error:"接口报错",timeout:"超时",inventory_mismatch:"库存不匹配",price_mismatch:"价格不匹配"})[t]||t,O=t=>({pending:"待处理",processing:"处理中",resolved:"已解决"})[t]||t,E=t=>({pending:"danger",processing:"warning",resolved:"success"})[t]||"",V=async t=>{try{await y.post(`/exception-orders/${t.id}/start-processing`),l.success("已开始处理"),g()}catch{l.error("操作失败")}},A=async t=>{try{await y.post(`/exception-orders/${t.id}/resolve`),l.success("已标记为已解决"),g()}catch{l.error("操作失败")}},T=t=>{var e;return((e=t.exception_data)==null?void 0:e.operation)||null},D=t=>{var e;return((e=t.exception_data)==null?void 0:e.timeout)===!0},k=t=>{var e;return((e=t.exception_data)==null?void 0:e.resource_response)||null},N=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",R=async t=>{var e,i;try{await h.confirm("确定要接单吗？系统将直接通知OTA平台确认订单（不再调用景区方接口）。","接单确认",{type:"info",confirmButtonText:"确定",cancelButtonText:"取消"}),d.value[t.id]="confirm";const a=await y.post(`/orders/${t.order_id}/confirm`,{remark:"异常订单人工处理：接单"});a.data.success?(l.success(a.data.message||"接单成功"),g()):l.error(a.data.message||"接单失败")}catch(a){if(a!=="cancel"){const n=((i=(e=a.response)==null?void 0:e.data)==null?void 0:i.message)||"接单失败";l.error(n)}}finally{d.value[t.id]=null}},S=async t=>{var e,i;try{const{value:a}=await h.prompt("请输入拒单原因","拒单",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"请输入拒单原因",inputValidator:u=>!u||u.trim().length===0?"拒单原因不能为空":!0});d.value[t.id]="reject";const n=await y.post(`/orders/${t.order_id}/reject`,{reason:a.trim()});n.data.success?(l.success(n.data.message||"拒单成功"),g()):l.error(n.data.message||"拒单失败")}catch(a){if(a!=="cancel"){const n=((i=(e=a.response)==null?void 0:e.data)==null?void 0:i.message)||"拒单失败";l.error(n)}}finally{d.value[t.id]=null}},L=async t=>{var e,i;try{await h.confirm("确定要同意取消订单吗？系统将直接通知OTA平台取消订单（不再调用景区方接口）。","同意取消确认",{type:"info",confirmButtonText:"确定",cancelButtonText:"取消"}),d.value[t.id]="approve";const a=await y.post(`/orders/${t.order_id}/approve-cancel`,{reason:"异常订单人工处理：同意取消"});a.data.success?(l.success(a.data.message||"同意取消成功"),g()):l.error(a.data.message||"同意取消失败")}catch(a){if(a!=="cancel"){const n=((i=(e=a.response)==null?void 0:e.data)==null?void 0:i.message)||"同意取消失败";l.error(n)}}finally{d.value[t.id]=null}},M=async t=>{var e,i;try{const{value:a}=await h.prompt("请输入拒绝取消的原因","拒绝取消",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"请输入拒绝取消的原因",inputValidator:u=>!u||u.trim().length===0?"拒绝原因不能为空":!0});d.value[t.id]="reject";const n=await y.post(`/orders/${t.order_id}/reject-cancel`,{reason:a.trim()});n.data.success?(l.success(n.data.message||"拒绝取消成功"),g()):l.error(n.data.message||"拒绝取消失败")}catch(a){if(a!=="cancel"){const n=((i=(e=a.response)==null?void 0:e.data)==null?void 0:i.message)||"拒绝取消失败";l.error(n)}}finally{d.value[t.id]=null}};return I(()=>{g()}),(t,e)=>{const i=_("el-alert"),a=_("el-table-column"),n=_("el-tag"),u=_("el-button"),P=_("el-table"),F=_("el-card"),q=H("loading");return p(),f("div",null,[e[8]||(e[8]=G("h2",null,"异常订单处理",-1)),o(i,{type:"warning",closable:!1,style:{"margin-bottom":"20px"}},{default:r(()=>[...e[0]||(e[0]=[c(" 所有接口报错、超时、库存不匹配的订单都会显示在这里，请及时处理 ",-1)])]),_:1}),o(F,null,{default:r(()=>[J((p(),b(P,{data:$.value,border:""},{default:r(()=>[o(a,{prop:"order.order_no",label:"订单号",width:"180"}),o(a,{prop:"order.ota_order_no",label:"OTA订单号",width:"180"}),o(a,{label:"OTA平台",width:"120"},{default:r(({row:s})=>{var m;return[(m=s.order)!=null&&m.ota_platform?(p(),b(n,{key:0,type:"info",size:"small"},{default:r(()=>[c(v(s.order.ota_platform.name||s.order.ota_platform.code),1)]),_:2},1024)):(p(),f("span",K,"-"))]}),_:1}),o(a,{prop:"exception_type",label:"异常类型",width:"150"},{default:r(({row:s})=>[o(n,{type:"danger"},{default:r(()=>[c(v(j(s.exception_type)),1)]),_:2},1024),D(s)?(p(),b(n,{key:0,type:"warning",style:{"margin-left":"5px"}},{default:r(()=>[...e[1]||(e[1]=[c("超时",-1)])]),_:1})):x("",!0)]),_:1}),o(a,{prop:"exception_message",label:"异常信息","min-width":"200"}),o(a,{label:"景区方反馈",width:"200"},{default:r(({row:s})=>[k(s)?(p(),f("div",Q,[o(n,{type:k(s).success?"success":"danger",size:"small"},{default:r(()=>[c(v(k(s).success?"成功":"失败"),1)]),_:2},1032,["type"]),k(s).message?(p(),f("div",U,v(k(s).message),1)):x("",!0)])):(p(),f("span",W,"-"))]),_:1}),o(a,{prop:"status",label:"处理状态",width:"120"},{default:r(({row:s})=>[o(n,{type:E(s.status)},{default:r(()=>[c(v(O(s.status)),1)]),_:2},1032,["type"])]),_:1}),o(a,{prop:"created_at",label:"创建时间",width:"180"},{default:r(({row:s})=>[c(v(N(s.created_at)),1)]),_:1}),o(a,{label:"操作",width:"300",fixed:"right"},{default:r(({row:s})=>[s.status==="pending"&&T(s)==="confirm"?(p(),f(z,{key:0},[o(u,{size:"small",type:"success",onClick:m=>R(s),loading:d.value[s.id]==="confirm"},{default:r(()=>[...e[2]||(e[2]=[c(" 接单 ",-1)])]),_:1},8,["onClick","loading"]),o(u,{size:"small",type:"danger",onClick:m=>S(s),loading:d.value[s.id]==="reject"},{default:r(()=>[...e[3]||(e[3]=[c(" 拒单 ",-1)])]),_:1},8,["onClick","loading"])],64)):x("",!0),s.status==="pending"&&T(s)==="cancel"?(p(),f(z,{key:1},[o(u,{size:"small",type:"success",onClick:m=>L(s),loading:d.value[s.id]==="approve"},{default:r(()=>[...e[4]||(e[4]=[c(" 同意取消 ",-1)])]),_:1},8,["onClick","loading"]),o(u,{size:"small",type:"danger",onClick:m=>M(s),loading:d.value[s.id]==="reject"},{default:r(()=>[...e[5]||(e[5]=[c(" 拒绝取消 ",-1)])]),_:1},8,["onClick","loading"])],64)):x("",!0),s.status==="pending"&&!T(s)?(p(),b(u,{key:2,size:"small",type:"primary",onClick:m=>V(s)},{default:r(()=>[...e[6]||(e[6]=[c(" 开始处理 ",-1)])]),_:1},8,["onClick"])):x("",!0),s.status==="processing"?(p(),b(u,{key:3,size:"small",type:"success",onClick:m=>A(s)},{default:r(()=>[...e[7]||(e[7]=[c(" 已解决 ",-1)])]),_:1},8,["onClick"])):x("",!0)]),_:1})]),_:1},8,["data"])),[[q,C.value]])]),_:1})])}}};export{Z as default};
