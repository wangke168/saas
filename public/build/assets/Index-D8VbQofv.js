import{_ as De,u as Re,r as p,x as se,i as He,c,o as i,f as K,b as a,w as n,d as _,k as g,E as x,e as Ie,l as Fe,m as Me,h as m,F as f,p as b,q as k,y as R,z as Ne,t as C,s as Pe,C as ue,D as de,v as Ke}from"./app-CCEVyAWf.js";const je={style:{"margin-bottom":"20px"}},Ae={key:0},Le={key:1},Ye={key:0},Ge={key:0},Je={key:1},Oe={style:{width:"100%"}},Qe={style:{width:"100%"}},We={__name:"Index",setup(Xe){const H=Re(),O=Ie(),Q=p([]),$=p([]),j=p(!1),I=p(""),F=p(null),M=p(null),U=p(1),A=p(15),W=p(0),S=p(!1),L=p(!1),q=p(null),N=p(null),u=p({scenic_spot_id:null,product_name:"",stay_days:1,description:"",status:1,bundle_items:[],hotel_room_types:[]}),z=p([]),B=p([]),T=p([]),P=se(()=>N.value!==null),ie=se(()=>P.value?"编辑打包产品":"创建打包产品"),re={scenic_spot_id:[{required:!0,message:"请选择所属景区",trigger:"change"}],product_name:[{required:!0,message:"请输入产品名称",trigger:"blur"},{max:100,message:"产品名称不能超过100个字符",trigger:"blur"}],stay_days:[{required:!0,message:"请输入入住天数",trigger:"blur"},{type:"number",min:1,max:30,message:"入住天数必须在1-30天之间",trigger:"blur"}],bundle_items:[{validator:(l,e,o)=>{if(!e||e.length===0)o(new Error("请至少添加一个关联门票"));else{const s=e.map(h=>h.ticket_id),v=[...new Set(s)];s.length!==v.length?o(new Error("不能添加重复的门票")):o()}},trigger:"change"}],hotel_room_types:[{validator:(l,e,o)=>{if(!e||e.length===0)o(new Error("请至少添加一个关联酒店房型"));else{const s=e.map(h=>`${h.hotel_id}_${h.room_type_id}`),v=[...new Set(s)];s.length!==v.length?o(new Error("不能添加重复的酒店房型组合")):o()}},trigger:"change"}]},V=async()=>{j.value=!0;try{const l={page:U.value,per_page:A.value};F.value&&(l.scenic_spot_id=F.value),M.value!==null&&(l.status=M.value),I.value&&(l.search=I.value);const e=await g.get("/pkg-products",{params:l});Q.value=e.data.data||[],W.value=e.data.total||0}catch(l){x.error("获取打包产品列表失败"),console.error(l)}finally{j.value=!1}},pe=async()=>{var l,e,o;try{if(((l=H.user)==null?void 0:l.role)!=="admin")$.value=((e=H.user)==null?void 0:e.scenic_spots)||[];else{const s=await g.get("/scenic-spots");$.value=s.data.data||[]}}catch(s){console.error("获取景区列表失败",s),(o=H.user)!=null&&o.scenic_spots&&($.value=H.user.scenic_spots)}},ce=()=>{U.value=1,V()},X=()=>{U.value=1,V()},_e=()=>{N.value=null,le(),S.value=!0},me=l=>{O.push(`/pkg-products/${l.id}/detail`)},ve=l=>{O.push(`/pkg-products/${l.id}/price-management`)},ye=async l=>{N.value=l.id;try{const o=(await g.get(`/pkg-products/${l.id}`)).data.data;u.value={scenic_spot_id:o.scenic_spot_id,product_name:o.product_name,stay_days:o.stay_days||1,description:o.description||"",status:o.status,bundle_items:(o.bundle_items||[]).map(s=>({ticket_id:s.ticket_id,quantity:s.quantity||1})),hotel_room_types:(o.hotel_room_types||[]).map(s=>({hotel_id:s.hotel_id,room_type_id:s.room_type_id}))},u.value.scenic_spot_id&&(await Z(u.value.scenic_spot_id),await ee(u.value.scenic_spot_id),await te()),S.value=!0}catch(e){x.error("获取产品信息失败"),console.error(e)}},ge=async l=>{var e,o;try{await Ke.confirm(`确定要删除打包产品"${l.product_name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await g.delete(`/pkg-products/${l.id}`),x.success("删除成功"),V()}catch(s){if(s!=="cancel"){const v=((o=(e=s.response)==null?void 0:e.data)==null?void 0:o.message)||"删除失败";x.error(v)}}},fe=l=>{if(!l)return"";const e=new Date(l),o=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),v=String(e.getDate()).padStart(2,"0"),h=String(e.getHours()).padStart(2,"0"),E=String(e.getMinutes()).padStart(2,"0");return`${o}-${s}-${v} ${h}:${E}`},be=()=>{u.value.bundle_items.push({ticket_id:null,quantity:1})},he=l=>{u.value.bundle_items.splice(l,1),Y()},Y=()=>{var l;(l=q.value)==null||l.validateField("bundle_items")},ke=()=>{u.value.hotel_room_types.push({hotel_id:null,room_type_id:null})},Ve=l=>{u.value.hotel_room_types.splice(l,1),G()},we=l=>{u.value.hotel_room_types[l].room_type_id=null,G()},G=()=>{var l;(l=q.value)==null||l.validateField("hotel_room_types")},xe=l=>l?T.value.filter(e=>e.hotel_id===l&&e.is_active):[],Ce=async l=>{l?(await Z(l),await ee(l),await te()):(z.value=[],B.value=[],T.value=[])},Z=async l=>{try{const e=await g.get("/tickets",{params:{scenic_spot_id:l,is_active:!0,per_page:1e3}});z.value=e.data.data||[]}catch(e){console.error("获取门票列表失败",e),z.value=[]}},ee=async l=>{try{const e=await g.get("/res-hotels",{params:{scenic_spot_id:l,is_active:!0,per_page:1e3}});B.value=e.data.data||[]}catch(e){console.error("获取酒店列表失败",e),B.value=[]}},te=async()=>{try{const l=await g.get("/res-room-types",{params:{is_active:!0,per_page:1e3}});T.value=l.data.data||[]}catch(l){console.error("获取房型列表失败",l),T.value=[]}},Se=async()=>{var l,e;try{await q.value.validate(),L.value=!0;const o={scenic_spot_id:u.value.scenic_spot_id,product_name:u.value.product_name,stay_days:u.value.stay_days,description:u.value.description||"",status:u.value.status,bundle_items:u.value.bundle_items.map(s=>({ticket_id:s.ticket_id,quantity:s.quantity||1})),hotel_room_types:u.value.hotel_room_types.map(s=>({hotel_id:s.hotel_id,room_type_id:s.room_type_id}))};P.value?(await g.put(`/pkg-products/${N.value}`,o),x.success("更新成功")):(await g.post("/pkg-products",o),x.success("创建成功")),S.value=!1,V()}catch(o){if(o!==!1){const s=((e=(l=o.response)==null?void 0:l.data)==null?void 0:e.message)||(P.value?"更新失败":"创建失败");x.error(s),console.error(o)}}finally{L.value=!1}},le=()=>{var l;u.value={scenic_spot_id:null,product_name:"",stay_days:1,description:"",status:1,bundle_items:[],hotel_room_types:[]},z.value=[],B.value=[],T.value=[],(l=q.value)==null||l.clearValidate()};return He(()=>{V(),pe()}),(l,e)=>{const o=_("el-button"),s=_("el-option"),v=_("el-select"),h=_("el-icon"),E=_("el-input"),y=_("el-table-column"),J=_("el-tag"),$e=_("el-table"),Ue=_("el-pagination"),qe=_("el-card"),w=_("el-form-item"),ae=_("el-input-number"),oe=_("el-radio"),ze=_("el-radio-group"),Be=_("el-form"),Te=_("el-dialog"),Ee=Fe("loading");return i(),c("div",null,[e[23]||(e[23]=K("h2",null,"打包产品管理",-1)),a(qe,null,{default:n(()=>[K("div",je,[a(o,{type:"primary",onClick:_e},{default:n(()=>[...e[12]||(e[12]=[m("创建打包产品",-1)])]),_:1}),a(v,{modelValue:F.value,"onUpdate:modelValue":e[0]||(e[0]=t=>F.value=t),placeholder:"筛选景区",clearable:"",style:{width:"200px","margin-left":"10px"},onChange:X},{default:n(()=>[(i(!0),c(f,null,b($.value,t=>(i(),k(s,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(v,{modelValue:M.value,"onUpdate:modelValue":e[1]||(e[1]=t=>M.value=t),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:X},{default:n(()=>[a(s,{label:"启用",value:1}),a(s,{label:"禁用",value:0})]),_:1},8,["modelValue"]),a(E,{modelValue:I.value,"onUpdate:modelValue":e[2]||(e[2]=t=>I.value=t),placeholder:"搜索产品名称或编码",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:ce},{prefix:n(()=>[a(h,null,{default:n(()=>[a(R(Ne))]),_:1})]),_:1},8,["modelValue"])]),Me((i(),k($e,{data:Q.value,border:""},{default:n(()=>[a(y,{prop:"product_name",label:"产品名称",width:"200"}),a(y,{prop:"product_code",label:"产品编码",width:"150"}),a(y,{label:"所属景区",width:"150"},{default:n(({row:t})=>{var r;return[m(C(((r=t.scenic_spot)==null?void 0:r.name)||"-"),1)]}),_:1}),a(y,{label:"关联门票",width:"200"},{default:n(({row:t})=>[t.bundle_items&&t.bundle_items.length>0?(i(),c("div",Ae,[(i(!0),c(f,null,b(t.bundle_items,(r,d)=>(i(),k(J,{key:d,size:"small",style:{"margin-right":"5px"}},{default:n(()=>{var D;return[m(C(((D=r.ticket)==null?void 0:D.name)||"未知")+" x"+C(r.quantity||1),1)]}),_:2},1024))),128))])):(i(),c("span",Le,"-"))]),_:1}),a(y,{label:"关联酒店房型",width:"200"},{default:n(({row:t})=>[t.hotel_room_types&&t.hotel_room_types.length>0?(i(),c("div",Ye,[(i(!0),c(f,null,b(t.hotel_room_types.slice(0,2),(r,d)=>(i(),k(J,{key:d,size:"small",style:{"margin-right":"5px"}},{default:n(()=>{var D,ne;return[m(C(((D=r.hotel)==null?void 0:D.name)||"未知")+"-"+C(((ne=r.room_type)==null?void 0:ne.name)||"未知"),1)]}),_:2},1024))),128)),t.hotel_room_types.length>2?(i(),c("span",Ge,"...")):Pe("",!0)])):(i(),c("span",Je,"-"))]),_:1}),a(y,{prop:"stay_days",label:"入住天数",width:"100"}),a(y,{prop:"description",label:"描述","show-overflow-tooltip":""}),a(y,{prop:"status",label:"状态",width:"100"},{default:n(({row:t})=>[a(J,{type:t.status===1?"success":"danger"},{default:n(()=>[m(C(t.status===1?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(y,{prop:"created_at",label:"创建时间",width:"180"},{default:n(({row:t})=>[m(C(fe(t.created_at)),1)]),_:1}),a(y,{label:"操作",width:"280",fixed:"right"},{default:n(({row:t})=>[a(o,{size:"small",onClick:r=>me(t)},{default:n(()=>[...e[13]||(e[13]=[m("详情",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",type:"primary",onClick:r=>ve(t)},{default:n(()=>[...e[14]||(e[14]=[m("价格管理",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",onClick:r=>ye(t)},{default:n(()=>[...e[15]||(e[15]=[m("编辑",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",type:"danger",onClick:r=>ge(t)},{default:n(()=>[...e[16]||(e[16]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ee,j.value]]),a(Ue,{"current-page":U.value,"onUpdate:currentPage":e[3]||(e[3]=t=>U.value=t),"page-size":A.value,"onUpdate:pageSize":e[4]||(e[4]=t=>A.value=t),"page-sizes":[10,20,50,100],total:W.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:V,onCurrentChange:V},null,8,["current-page","page-size","total"])]),_:1}),a(Te,{modelValue:S.value,"onUpdate:modelValue":e[11]||(e[11]=t=>S.value=t),title:ie.value,width:"900px",onClose:le},{footer:n(()=>[a(o,{onClick:e[10]||(e[10]=t=>S.value=!1)},{default:n(()=>[...e[21]||(e[21]=[m("取消",-1)])]),_:1}),a(o,{type:"primary",onClick:Se,loading:L.value},{default:n(()=>[...e[22]||(e[22]=[m("确定",-1)])]),_:1},8,["loading"])]),default:n(()=>[a(Be,{ref_key:"formRef",ref:q,model:u.value,rules:re,"label-width":"120px"},{default:n(()=>[a(w,{label:"所属景区",prop:"scenic_spot_id"},{default:n(()=>[a(v,{modelValue:u.value.scenic_spot_id,"onUpdate:modelValue":e[5]||(e[5]=t=>u.value.scenic_spot_id=t),placeholder:"请选择景区",style:{width:"100%"},disabled:P.value,onChange:Ce},{default:n(()=>[(i(!0),c(f,null,b($.value,t=>(i(),k(s,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),a(w,{label:"产品名称",prop:"product_name"},{default:n(()=>[a(E,{modelValue:u.value.product_name,"onUpdate:modelValue":e[6]||(e[6]=t=>u.value.product_name=t),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),a(w,{label:"入住天数",prop:"stay_days"},{default:n(()=>[a(ae,{modelValue:u.value.stay_days,"onUpdate:modelValue":e[7]||(e[7]=t=>u.value.stay_days=t),min:1,max:30,style:{width:"100%"},placeholder:"请输入入住天数"},null,8,["modelValue"])]),_:1}),a(w,{label:"描述",prop:"description"},{default:n(()=>[a(E,{modelValue:u.value.description,"onUpdate:modelValue":e[8]||(e[8]=t=>u.value.description=t),type:"textarea",rows:3,placeholder:"请输入描述"},null,8,["modelValue"])]),_:1}),a(w,{label:"状态",prop:"status"},{default:n(()=>[a(ze,{modelValue:u.value.status,"onUpdate:modelValue":e[9]||(e[9]=t=>u.value.status=t)},{default:n(()=>[a(oe,{label:1},{default:n(()=>[...e[17]||(e[17]=[m("启用",-1)])]),_:1}),a(oe,{label:0},{default:n(()=>[...e[18]||(e[18]=[m("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(w,{label:"关联门票",prop:"bundle_items"},{default:n(()=>[K("div",Oe,[(i(!0),c(f,null,b(u.value.bundle_items,(t,r)=>(i(),c("div",{key:r,style:{display:"flex",gap:"10px","margin-bottom":"10px","align-items":"center"}},[a(v,{modelValue:t.ticket_id,"onUpdate:modelValue":d=>t.ticket_id=d,placeholder:"选择门票",style:{flex:"1"},filterable:"",onChange:Y},{default:n(()=>[(i(!0),c(f,null,b(z.value,d=>(i(),k(s,{key:d.id,label:`${d.name} (${d.code})`,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),a(ae,{modelValue:t.quantity,"onUpdate:modelValue":d=>t.quantity=d,min:1,max:10,placeholder:"数量",style:{width:"120px"},onChange:Y},null,8,["modelValue","onUpdate:modelValue"]),a(o,{type:"danger",icon:R(ue),circle:"",onClick:d=>he(r)},null,8,["icon","onClick"])]))),128)),a(o,{type:"primary",icon:R(de),onClick:be,disabled:!u.value.scenic_spot_id},{default:n(()=>[...e[19]||(e[19]=[m(" 添加门票 ",-1)])]),_:1},8,["icon","disabled"])])]),_:1}),a(w,{label:"关联酒店房型",prop:"hotel_room_types"},{default:n(()=>[K("div",Qe,[(i(!0),c(f,null,b(u.value.hotel_room_types,(t,r)=>(i(),c("div",{key:r,style:{display:"flex",gap:"10px","margin-bottom":"10px","align-items":"center"}},[a(v,{modelValue:t.hotel_id,"onUpdate:modelValue":d=>t.hotel_id=d,placeholder:"选择酒店",style:{flex:"1"},filterable:"",onChange:d=>we(r)},{default:n(()=>[(i(!0),c(f,null,b(B.value,d=>(i(),k(s,{key:d.id,label:d.name,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),a(v,{modelValue:t.room_type_id,"onUpdate:modelValue":d=>t.room_type_id=d,placeholder:"选择房型",style:{flex:"1"},filterable:"",disabled:!t.hotel_id,onChange:G},{default:n(()=>[(i(!0),c(f,null,b(xe(t.hotel_id),d=>(i(),k(s,{key:d.id,label:d.name,value:d.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),a(o,{type:"danger",icon:R(ue),circle:"",onClick:d=>Ve(r)},null,8,["icon","onClick"])]))),128)),a(o,{type:"primary",icon:R(de),onClick:ke,disabled:!u.value.scenic_spot_id},{default:n(()=>[...e[20]||(e[20]=[m(" 添加酒店房型 ",-1)])]),_:1},8,["icon","disabled"])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},et=De(We,[["__scopeId","data-v-8dc7b630"]]);export{et as default};
