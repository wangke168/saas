import{_ as _e,u as ve,r as i,A as G,i as me,c as T,o as m,f as N,b as t,w as o,d as u,k as V,E as x,e as fe,l as ge,m as be,h as c,F as R,p as A,q as E,y as ye,B as Ve,t as h,v as xe}from"./app-CLC_VnxY.js";const we={style:{"margin-bottom":"20px"}},ke={__name:"Index",setup(Se){const C=ve(),J=fe(),j=i([]),w=i([]),k=i([]),F=i(!1),I=i(!1),b=i(!1),$=i(null),U=i(""),z=i(null),B=i(null),S=i(1),M=i(15),H=i(0),D=i(null),P=G(()=>D.value!==null),O=G(()=>P.value?"编辑门票":"创建门票"),n=i({scenic_spot_id:null,software_provider_id:null,name:"",code:"",external_ticket_id:"",description:"",is_active:!0}),Q={scenic_spot_id:[{required:!0,message:"请选择所属景区",trigger:"change"}],name:[{required:!0,message:"请输入门票名称",trigger:"blur"},{max:255,message:"门票名称不能超过255个字符",trigger:"blur"}]},f=async()=>{F.value=!0;try{const a={page:S.value,per_page:M.value};z.value&&(a.scenic_spot_id=z.value),B.value!==null&&(a.is_active=B.value),U.value&&(a.search=U.value);const e=await V.get("/tickets",{params:a});j.value=e.data.data||[],H.value=e.data.total||0}catch(a){x.error("获取门票列表失败"),console.error(a)}finally{F.value=!1}},W=async()=>{var a,e,s;try{if(((a=C.user)==null?void 0:a.role)!=="admin")w.value=((e=C.user)==null?void 0:e.scenic_spots)||[];else{const r=await V.get("/scenic-spots");w.value=r.data.data||[]}}catch(r){console.error("获取景区列表失败",r),(s=C.user)!=null&&s.scenic_spots&&(w.value=C.user.scenic_spots)}},X=async()=>{k.value=[]},K=async a=>{if(n.value.software_provider_id=null,!a){k.value=[];return}try{const s=(await V.get(`/scenic-spots/${a}`)).data.data;k.value=s.software_providers||[]}catch(e){console.error("获取景区服务商列表失败",e),k.value=[]}},Z=()=>{S.value=1,f()},L=()=>{S.value=1,f()},ee=()=>{D.value=null,Y(),b.value=!0},le=a=>{J.push(`/tickets/${a.id}`)},te=async a=>{D.value=a.id,a.scenic_spot_id&&await K(a.scenic_spot_id),n.value={scenic_spot_id:a.scenic_spot_id,software_provider_id:a.software_provider_id||null,name:a.name,code:a.code,external_ticket_id:a.external_ticket_id||"",description:a.description||"",is_active:a.is_active},b.value=!0},ae=async()=>{$.value&&await $.value.validate(async a=>{var e,s,r,_,y,p;if(a){I.value=!0;try{P.value?(await V.put(`/tickets/${D.value}`,n.value),x.success("门票更新成功")):(await V.post("/tickets",n.value),x.success("门票创建成功")),b.value=!1,f()}catch(d){const q=((s=(e=d.response)==null?void 0:e.data)==null?void 0:s.message)||((p=(y=(_=(r=d.response)==null?void 0:r.data)==null?void 0:_.errors)==null?void 0:y.code)==null?void 0:p[0])||"操作失败";x.error(q)}finally{I.value=!1}}})},oe=async a=>{try{await xe.confirm(`确定要删除门票"${a.name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await V.delete(`/tickets/${a.id}`),x.success("删除成功"),f()}catch(e){e!=="cancel"&&(x.error("删除失败"),console.error(e))}},Y=()=>{var a;n.value={scenic_spot_id:null,software_provider_id:null,name:"",code:"",external_ticket_id:"",description:"",is_active:!0},(a=$.value)==null||a.clearValidate()},ne=a=>{if(!a)return"";const e=new Date(a),s=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),_=String(e.getDate()).padStart(2,"0"),y=String(e.getHours()).padStart(2,"0"),p=String(e.getMinutes()).padStart(2,"0");return`${s}-${r}-${_} ${y}:${p}`};return me(()=>{f(),W(),X()}),(a,e)=>{const s=u("el-button"),r=u("el-option"),_=u("el-select"),y=u("el-icon"),p=u("el-input"),d=u("el-table-column"),q=u("el-tag"),se=u("el-table"),ie=u("el-pagination"),re=u("el-card"),g=u("el-form-item"),ue=u("el-switch"),de=u("el-form"),ce=u("el-dialog"),pe=ge("loading");return m(),T("div",null,[e[21]||(e[21]=N("h2",null,"门票管理",-1)),t(re,null,{default:o(()=>[N("div",we,[t(s,{type:"primary",onClick:ee},{default:o(()=>[...e[14]||(e[14]=[c("创建门票",-1)])]),_:1}),t(_,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=l=>z.value=l),placeholder:"筛选景区",clearable:"",style:{width:"200px","margin-left":"10px"},onChange:L},{default:o(()=>[(m(!0),T(R,null,A(w.value,l=>(m(),E(r,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(_,{modelValue:B.value,"onUpdate:modelValue":e[1]||(e[1]=l=>B.value=l),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:L},{default:o(()=>[t(r,{label:"启用",value:!0}),t(r,{label:"禁用",value:!1})]),_:1},8,["modelValue"]),t(p,{modelValue:U.value,"onUpdate:modelValue":e[2]||(e[2]=l=>U.value=l),placeholder:"搜索门票名称、编码或外部编号",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:Z},{prefix:o(()=>[t(y,null,{default:o(()=>[t(ye(Ve))]),_:1})]),_:1},8,["modelValue"])]),be((m(),E(se,{data:j.value,border:""},{default:o(()=>[t(d,{prop:"name",label:"门票名称",width:"200"}),t(d,{prop:"code",label:"门票编码",width:"150"}),t(d,{prop:"external_ticket_id",label:"外部门票编号",width:"150"},{default:o(({row:l})=>[c(h(l.external_ticket_id||"-"),1)]),_:1}),t(d,{label:"所属景区",width:"150"},{default:o(({row:l})=>{var v;return[c(h(((v=l.scenic_spot)==null?void 0:v.name)||"-"),1)]}),_:1}),t(d,{label:"软件服务商",width:"150"},{default:o(({row:l})=>{var v;return[c(h(((v=l.software_provider)==null?void 0:v.name)||"-"),1)]}),_:1}),t(d,{prop:"description",label:"描述","show-overflow-tooltip":""}),t(d,{prop:"is_active",label:"状态",width:"100"},{default:o(({row:l})=>[t(q,{type:l.is_active?"success":"danger"},{default:o(()=>[c(h(l.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),t(d,{prop:"created_at",label:"创建时间",width:"180"},{default:o(({row:l})=>[c(h(ne(l.created_at)),1)]),_:1}),t(d,{label:"操作",width:"280",fixed:"right"},{default:o(({row:l})=>[t(s,{size:"small",type:"primary",onClick:v=>le(l)},{default:o(()=>[...e[15]||(e[15]=[c("查看详情",-1)])]),_:1},8,["onClick"]),t(s,{size:"small",onClick:v=>te(l)},{default:o(()=>[...e[16]||(e[16]=[c("编辑",-1)])]),_:1},8,["onClick"]),t(s,{size:"small",type:"danger",onClick:v=>oe(l)},{default:o(()=>[...e[17]||(e[17]=[c("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[pe,F.value]]),t(ie,{"current-page":S.value,"onUpdate:currentPage":e[3]||(e[3]=l=>S.value=l),"page-size":M.value,"onUpdate:pageSize":e[4]||(e[4]=l=>M.value=l),"page-sizes":[10,20,50,100],total:H.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:f,onCurrentChange:f},null,8,["current-page","page-size","total"])]),_:1}),t(ce,{modelValue:b.value,"onUpdate:modelValue":e[13]||(e[13]=l=>b.value=l),title:O.value,width:"600px",onClose:Y},{footer:o(()=>[t(s,{onClick:e[12]||(e[12]=l=>b.value=!1)},{default:o(()=>[...e[19]||(e[19]=[c("取消",-1)])]),_:1}),t(s,{type:"primary",onClick:ae,loading:I.value},{default:o(()=>[...e[20]||(e[20]=[c("确定",-1)])]),_:1},8,["loading"])]),default:o(()=>[t(de,{ref_key:"formRef",ref:$,model:n.value,rules:Q,"label-width":"120px"},{default:o(()=>[t(g,{label:"所属景区",prop:"scenic_spot_id"},{default:o(()=>[t(_,{modelValue:n.value.scenic_spot_id,"onUpdate:modelValue":e[5]||(e[5]=l=>n.value.scenic_spot_id=l),placeholder:"请选择景区",style:{width:"100%"},disabled:P.value,onChange:K},{default:o(()=>[(m(!0),T(R,null,A(w.value,l=>(m(),E(r,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),t(g,{label:"门票名称",prop:"name"},{default:o(()=>[t(p,{modelValue:n.value.name,"onUpdate:modelValue":e[6]||(e[6]=l=>n.value.name=l),placeholder:"请输入门票名称"},null,8,["modelValue"])]),_:1}),t(g,{label:"门票编码",prop:"code"},{default:o(()=>[t(p,{modelValue:n.value.code,"onUpdate:modelValue":e[7]||(e[7]=l=>n.value.code=l),placeholder:"系统自动生成",disabled:!0},null,8,["modelValue"]),e[18]||(e[18]=N("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}}," 门票编码由系统自动生成，格式：T + 5位数字（如 T00001） ",-1))]),_:1}),t(g,{label:"外部门票编号",prop:"external_ticket_id"},{default:o(()=>[t(p,{modelValue:n.value.external_ticket_id,"onUpdate:modelValue":e[8]||(e[8]=l=>n.value.external_ticket_id=l),placeholder:"用于资源方系统对接的门票编号（可选）"},null,8,["modelValue"])]),_:1}),t(g,{label:"软件服务商",prop:"software_provider_id"},{default:o(()=>[t(_,{modelValue:n.value.software_provider_id,"onUpdate:modelValue":e[9]||(e[9]=l=>n.value.software_provider_id=l),placeholder:"请选择软件服务商（可选）",clearable:"",style:{width:"100%"}},{default:o(()=>[(m(!0),T(R,null,A(k.value,l=>(m(),E(r,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"描述",prop:"description"},{default:o(()=>[t(p,{modelValue:n.value.description,"onUpdate:modelValue":e[10]||(e[10]=l=>n.value.description=l),type:"textarea",rows:3,placeholder:"请输入描述"},null,8,["modelValue"])]),_:1}),t(g,{label:"状态",prop:"is_active"},{default:o(()=>[t(ue,{modelValue:n.value.is_active,"onUpdate:modelValue":e[11]||(e[11]=l=>n.value.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Ce=_e(ke,[["__scopeId","data-v-6ec39132"]]);export{Ce as default};
