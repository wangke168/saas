import{_ as ve,u as fe,r as c,s as J,i as ge,c as O,o as V,f as b,b as l,w as s,d as i,j as D,E as g,e as ye,k as be,l as xe,h as v,F as K,v as G,n as B,x as H,y as Ve,t as T,z as we,p as he,q as De}from"./app-DOrDR003.js";const Ce={style:{"margin-bottom":"20px"}},ke={__name:"Index",setup(Se){const m=fe(),Q=ye(),U=c([]),y=c([]),q=c(!1),I=c(!1),N=c({}),w=c(!1),C=c(null),z=c(""),Y=c(null),E=c(null),k=c(1),R=c(15),L=c(0),S=c(null),M=J(()=>S.value!==null),W=J(()=>M.value?"编辑产品":"创建产品"),o=c({scenic_spot_id:null,name:"",code:"",description:"",price_source:"manual",stay_days:1,sale_start_date:null,sale_end_date:null,is_active:!0}),X={scenic_spot_id:[{required:!0,message:"请选择所属景区",trigger:"change"}],name:[{required:!0,message:"请输入产品名称",trigger:"blur"},{max:255,message:"产品名称不能超过255个字符",trigger:"blur"}],external_code:[{max:255,message:"外部产品编码不能超过255个字符",trigger:"blur"}],price_source:[{required:!0,message:"请选择价格来源",trigger:"change"}],stay_days:[{required:!0,message:"请输入入住天数",trigger:"blur"},{type:"number",min:1,max:30,message:"入住天数必须在1-30之间",trigger:"blur"}],sale_start_date:[{required:!0,message:"请选择销售开始日期",trigger:"change"}],sale_end_date:[{validator:(t,e,n)=>{e?o.value.sale_start_date&&e<o.value.sale_start_date?n(new Error("销售结束日期不能早于开始日期")):n():n(new Error("请选择销售结束日期"))},trigger:"change"}]},x=async()=>{q.value=!0;try{const t={page:k.value,per_page:R.value};Y.value&&(t.scenic_spot_id=Y.value),E.value!==null&&(t.is_active=E.value),z.value&&(t.search=z.value);const e=await D.get("/products",{params:t});e.data&&e.data.data?(U.value=e.data.data||[],L.value=e.data.total||0):(U.value=e.data||[],L.value=U.value.length)}catch(t){g.error("获取产品列表失败"),console.error(t)}finally{q.value=!1}},F=async()=>{var t,e,n,r;try{if(((t=m.user)==null?void 0:t.role)!=="admin")(!m.user||!m.user.scenic_spots||m.user.scenic_spots.length===0)&&await m.fetchUser(),y.value=((e=m.user)==null?void 0:e.scenic_spots)||[],y.value.length===0&&console.warn("运营用户未绑定任何景区");else{const u=await D.get("/scenic-spots");y.value=u.data.data||[]}}catch(u){if(console.error("获取景区列表失败",u),(n=m.user)!=null&&n.scenic_spots&&m.user.scenic_spots.length>0)y.value=m.user.scenic_spots;else try{await m.fetchUser(),y.value=((r=m.user)==null?void 0:r.scenic_spots)||[]}catch(_){console.error("获取用户信息失败",_)}}},Z=()=>{k.value=1,x()},P=()=>{k.value=1,x()},ee=async()=>{var t;if(S.value=null,j(),y.value.length===0&&await F(),((t=m.user)==null?void 0:t.role)!=="admin"&&y.value.length===0){g.warning("您未绑定任何景区，请联系管理员为您分配景区");return}w.value=!0},ae=t=>{Q.push(`/products/${t.id}/detail`)},le=t=>{S.value=t.id,o.value={scenic_spot_id:t.scenic_spot_id,name:t.name,code:t.code,external_code:t.external_code||"",description:t.description||"",price_source:t.price_source||"manual",stay_days:t.stay_days||1,sale_start_date:t.sale_start_date||null,sale_end_date:t.sale_end_date||null,is_active:t.is_active},w.value=!0},te=async()=>{C.value&&await C.value.validate(async t=>{var e,n,r,u,_,p;if(t){I.value=!0;try{const d={...o.value,stay_days:o.value.stay_days||1,sale_start_date:o.value.sale_start_date||null,sale_end_date:o.value.sale_end_date||null};delete d.code,d.external_code===""&&(d.external_code=null),M.value?(await D.put(`/products/${S.value}`,d),g.success("产品更新成功")):(await D.post("/products",d),g.success("产品创建成功")),w.value=!1,j(),setTimeout(()=>{x()},100)}catch(d){const $=((n=(e=d.response)==null?void 0:e.data)==null?void 0:n.message)||((p=(_=(u=(r=d.response)==null?void 0:r.data)==null?void 0:u.errors)==null?void 0:_.code)==null?void 0:p[0])||"操作失败";g.error($)}finally{I.value=!1}}})},se=async t=>{var e,n;try{await De.confirm(`确定要删除产品"${t.name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await D.delete(`/products/${t.id}`),g.success("删除成功"),x()}catch(r){if(r!=="cancel"){const u=((n=(e=r.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败";g.error(u)}}},j=()=>{S.value=null,o.value={scenic_spot_id:null,name:"",code:"",external_code:"",description:"",price_source:"manual",stay_days:1,sale_start_date:null,sale_end_date:null,is_active:!0},C.value&&C.value.clearValidate()},oe=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",ne=async t=>{N.value[t.id]=!0;try{const e=await D.get(`/products/${t.id}/export`,{responseType:"blob",validateStatus:_=>_<500});if((e.headers["content-type"]||"").includes("application/json")||e.status>=400){const _=await e.data.text();let p="导出失败";try{p=JSON.parse(_).message||p}catch{p=_||p}g.error(p),console.error("导出失败",p);return}const r=window.URL.createObjectURL(new Blob([e.data])),u=document.createElement("a");u.href=r,u.setAttribute("download",`product_${t.code}_${new Date().toISOString().slice(0,10)}.csv`),document.body.appendChild(u),u.click(),u.remove(),window.URL.revokeObjectURL(r),g.success("导出成功")}catch(e){let n="导出失败";if(e.response){if(e.response.data)if(typeof e.response.data=="string")try{n=JSON.parse(e.response.data).message||n}catch{n=e.response.data||n}else e.response.data.message&&(n=e.response.data.message)}else e.message&&(n=e.message);g.error(n),console.error("导出失败",e)}finally{N.value[t.id]=!1}};return ge(()=>{x(),F()}),(t,e)=>{const n=i("el-button"),r=i("el-option"),u=i("el-select"),_=i("el-icon"),p=i("el-input"),d=i("el-table-column"),$=i("el-tag"),re=i("el-table"),de=i("el-pagination"),ue=i("el-card"),f=i("el-form-item"),ie=i("el-input-number"),A=i("el-date-picker"),pe=i("el-switch"),ce=i("el-form"),me=i("el-dialog"),_e=be("loading");return V(),O("div",null,[e[30]||(e[30]=b("h2",null,"产品管理",-1)),l(ue,null,{default:s(()=>[b("div",Ce,[l(n,{type:"primary",onClick:ee},{default:s(()=>[...e[17]||(e[17]=[v("创建产品",-1)])]),_:1}),l(u,{modelValue:Y.value,"onUpdate:modelValue":e[0]||(e[0]=a=>Y.value=a),placeholder:"筛选景区",clearable:"",style:{width:"200px","margin-left":"10px"},onChange:P},{default:s(()=>[(V(!0),O(K,null,G(y.value,a=>(V(),B(r,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(u,{modelValue:E.value,"onUpdate:modelValue":e[1]||(e[1]=a=>E.value=a),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:P},{default:s(()=>[l(r,{label:"启用",value:!0}),l(r,{label:"禁用",value:!1})]),_:1},8,["modelValue"]),l(p,{modelValue:z.value,"onUpdate:modelValue":e[2]||(e[2]=a=>z.value=a),placeholder:"搜索产品名称或编码",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:Z},{prefix:s(()=>[l(_,null,{default:s(()=>[l(H(Ve))]),_:1})]),_:1},8,["modelValue"])]),xe((V(),B(re,{data:U.value,border:""},{default:s(()=>[l(d,{prop:"name",label:"产品名称",width:"200"}),l(d,{prop:"code",label:"产品编码",width:"150"}),l(d,{prop:"external_code",label:"外部产品编码",width:"150"}),l(d,{label:"所属景区",width:"150"},{default:s(({row:a})=>{var h;return[v(T(((h=a.scenic_spot)==null?void 0:h.name)||"-"),1)]}),_:1}),l(d,{prop:"description",label:"描述","show-overflow-tooltip":""}),l(d,{prop:"price_source",label:"价格来源",width:"120"},{default:s(({row:a})=>[l($,{type:a.price_source==="manual"?"primary":"success"},{default:s(()=>[v(T(a.price_source==="manual"?"人工维护":"接口推送"),1)]),_:2},1032,["type"])]),_:1}),l(d,{prop:"is_active",label:"状态",width:"100"},{default:s(({row:a})=>[l($,{type:a.is_active?"success":"danger"},{default:s(()=>[v(T(a.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(d,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:a})=>[v(T(oe(a.created_at)),1)]),_:1}),l(d,{label:"操作",width:"350",fixed:"right"},{default:s(({row:a})=>[l(n,{size:"small",onClick:h=>ae(a)},{default:s(()=>[...e[18]||(e[18]=[v("详情",-1)])]),_:1},8,["onClick"]),l(n,{size:"small",onClick:h=>le(a)},{default:s(()=>[...e[19]||(e[19]=[v("编辑",-1)])]),_:1},8,["onClick"]),l(n,{size:"small",type:"success",onClick:h=>ne(a),loading:N.value[a.id]},{default:s(()=>[l(_,null,{default:s(()=>[l(H(we))]),_:1}),e[20]||(e[20]=v(" 导出 ",-1))]),_:1},8,["onClick","loading"]),l(n,{size:"small",type:"danger",onClick:h=>se(a)},{default:s(()=>[...e[21]||(e[21]=[v("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[_e,q.value]]),l(de,{"current-page":k.value,"onUpdate:currentPage":e[3]||(e[3]=a=>k.value=a),"page-size":R.value,"onUpdate:pageSize":e[4]||(e[4]=a=>R.value=a),"page-sizes":[10,20,50,100],total:L.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:x,onCurrentChange:x},null,8,["current-page","page-size","total"])]),_:1}),l(me,{modelValue:w.value,"onUpdate:modelValue":e[16]||(e[16]=a=>w.value=a),title:W.value,width:"600px",onClose:j},{footer:s(()=>[l(n,{onClick:e[15]||(e[15]=a=>w.value=!1)},{default:s(()=>[...e[28]||(e[28]=[v("取消",-1)])]),_:1}),l(n,{type:"primary",onClick:te,loading:I.value},{default:s(()=>[...e[29]||(e[29]=[v("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(ce,{ref_key:"formRef",ref:C,model:o.value,rules:X,"label-width":"120px"},{default:s(()=>[l(f,{label:"所属景区",prop:"scenic_spot_id"},{default:s(()=>[l(u,{modelValue:o.value.scenic_spot_id,"onUpdate:modelValue":e[5]||(e[5]=a=>o.value.scenic_spot_id=a),placeholder:"请选择景区",style:{width:"100%"},disabled:M.value},{default:s(()=>[(V(!0),O(K,null,G(y.value,a=>(V(),B(r,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),l(f,{label:"产品名称",prop:"name"},{default:s(()=>[l(p,{modelValue:o.value.name,"onUpdate:modelValue":e[6]||(e[6]=a=>o.value.name=a),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),M.value?(V(),B(f,{key:0,label:"产品编码",prop:"code"},{default:s(()=>[l(p,{modelValue:o.value.code,"onUpdate:modelValue":e[7]||(e[7]=a=>o.value.code=a),placeholder:"系统自动生成",disabled:""},null,8,["modelValue"]),e[22]||(e[22]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品编码由系统自动生成，不可修改 ",-1))]),_:1})):he("",!0),l(f,{label:"外部产品编码",prop:"external_code"},{default:s(()=>[l(p,{modelValue:o.value.external_code,"onUpdate:modelValue":e[8]||(e[8]=a=>o.value.external_code=a),placeholder:"请输入外部产品编码（可选，用于和景区系统对接，如横店）"},null,8,["modelValue"]),e[23]||(e[23]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 用于和景区系统（如横店）对接的产品编码，如果产品不需要对接外部系统，可留空 ",-1))]),_:1}),l(f,{label:"描述",prop:"description"},{default:s(()=>[l(p,{modelValue:o.value.description,"onUpdate:modelValue":e[9]||(e[9]=a=>o.value.description=a),type:"textarea",rows:4,placeholder:"请输入产品描述"},null,8,["modelValue"])]),_:1}),l(f,{label:"价格来源",prop:"price_source"},{default:s(()=>[l(u,{modelValue:o.value.price_source,"onUpdate:modelValue":e[10]||(e[10]=a=>o.value.price_source=a),placeholder:"请选择价格来源",style:{width:"100%"}},{default:s(()=>[l(r,{label:"人工维护",value:"manual"}),l(r,{label:"接口推送",value:"api"})]),_:1},8,["modelValue"]),e[24]||(e[24]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 选择接口推送后，价格将通过资源方接口自动更新 ",-1))]),_:1}),l(f,{label:"入住天数",prop:"stay_days",required:""},{default:s(()=>[l(ie,{modelValue:o.value.stay_days,"onUpdate:modelValue":e[11]||(e[11]=a=>o.value.stay_days=a),min:1,max:30,placeholder:"请输入入住天数（必填）",style:{width:"100%"}},null,8,["modelValue"]),e[25]||(e[25]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品需要连续入住的天数，至少为1 ",-1))]),_:1}),l(f,{label:"销售开始日期",prop:"sale_start_date"},{default:s(()=>[l(A,{modelValue:o.value.sale_start_date,"onUpdate:modelValue":e[12]||(e[12]=a=>o.value.sale_start_date=a),type:"date",placeholder:"选择销售开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":a=>o.value.sale_end_date&&a>new Date(o.value.sale_end_date)},null,8,["modelValue","disabled-date"]),e[26]||(e[26]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品开始销售的日期（必填） ",-1))]),_:1}),l(f,{label:"销售结束日期",prop:"sale_end_date"},{default:s(()=>[l(A,{modelValue:o.value.sale_end_date,"onUpdate:modelValue":e[13]||(e[13]=a=>o.value.sale_end_date=a),type:"date",placeholder:"选择销售结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":a=>o.value.sale_start_date&&a<new Date(o.value.sale_start_date)},null,8,["modelValue","disabled-date"]),e[27]||(e[27]=b("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品结束销售的日期（必填），不能早于开始日期 ",-1))]),_:1}),l(f,{label:"状态",prop:"is_active"},{default:s(()=>[l(pe,{modelValue:o.value.is_active,"onUpdate:modelValue":e[14]||(e[14]=a=>o.value.is_active=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Ye=ve(ke,[["__scopeId","data-v-b6424ec9"]]);export{Ye as default};
