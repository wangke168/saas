import{_ as de,r as h,i as ue,j as pe,c as C,o as m,f as s,b as r,w as g,d as k,k as T,E as u,e as _e,l as me,m as ge,n as Q,h as v,F as R,p as ve,t as _,q as D,s as S,v as j}from"./app-DhXkCbrE.js";const fe={class:"order-management-container"},ye={class:"filter-bar"},he={class:"order-list"},ke={class:"order-header"},be={class:"header-item"},$e={class:"value"},xe={class:"header-item"},Ce={class:"value"},Se={class:"header-item"},Te={class:"value"},De={class:"header-item"},je={class:"value"},ze={class:"order-body"},Be={class:"body-col col-checkbox"},Me={class:"body-col col-product"},Ve={class:"product-name"},we={class:"body-col col-hotel"},Fe={class:"hotel-name"},Ye={class:"hotel-details"},Oe={key:0,class:"room-type"},Ue={class:"date-range"},qe={class:"body-col col-guest"},Ne={class:"guest-name"},Ee={class:"guest-phone"},Le={class:"body-col col-amount"},Pe={class:"amount-item"},Re={class:"amount-value"},Ae={class:"amount-item"},Ke={class:"amount-value"},He={class:"amount-item"},We={class:"amount-value estimated"},Ie={class:"body-col col-status"},Ge={class:"body-col col-actions"},Je={__name:"Index",setup(Qe){_e();const M=h([]),N=h(!1),V=h(1),E=h(15),A=h(0),p=h({}),z=h([]),w=h("total, sizes, prev, pager, next, jumper"),L=()=>{window.innerWidth<=768?w.value="prev, pager, next":window.innerWidth<=1200?w.value="total, prev, pager, next":w.value="total, sizes, prev, pager, next, jumper"},d=h({status:null,order_no:"",ota_order_no:"",check_in_date:null}),y=async()=>{N.value=!0;try{const t={page:V.value,per_page:E.value};d.value.status&&(t.status=d.value.status),d.value.order_no&&(t.order_no=d.value.order_no),d.value.ota_order_no&&(t.ota_order_no=d.value.ota_order_no),d.value.check_in_date&&(t.check_in_date=d.value.check_in_date);const e=await T.get("/orders",{params:t});if(M.value=e.data.data,A.value=e.data.total,M.value.length>0){const n=M.value[0];console.log("订单日期数据示例:",{check_in_date:n.check_in_date,check_out_date:n.check_out_date,check_in_date_type:typeof n.check_in_date,check_out_date_type:typeof n.check_out_date})}}catch{u.error("获取订单列表失败")}finally{N.value=!1}},b=()=>{V.value=1,y()},X=()=>{d.value={status:null,order_no:"",ota_order_no:"",check_in_date:null},b()},F=t=>t?(parseFloat(t)/100).toFixed(2):"0.00",Z=t=>{if(!t)return"";const e=new Date(t),n=e.getFullYear(),l=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");return`${n}-${l}-${c} ${i}:${o}`},ee=(t,e,n)=>{try{if(!t&&!e)return"";const l=o=>{if(!o)return null;if(typeof o=="string"){const f=o.match(/^(\d{4}-\d{2}-\d{2})/);return f?f[1]:o.split(" ")[0].split("T")[0]}if(o instanceof Date){const f=o.getFullYear(),$=String(o.getMonth()+1).padStart(2,"0"),B=String(o.getDate()).padStart(2,"0");return`${f}-${$}-${B}`}return String(o)},c=l(t),i=l(e);if(!c&&i)return`离店：${i.replace(/-/g,"/")}`;if(c&&!i)return`入住：${c.replace(/-/g,"/")}`;if(c&&i){const o=new Date(c+"T00:00:00"),f=new Date(i+"T00:00:00");if(isNaN(o.getTime())||isNaN(f.getTime()))return`${c.replace(/-/g,"/")}~${i.replace(/-/g,"/")}`;const $=Math.ceil((f-o)/(1e3*60*60*24)),B=$>0?`${$}晚`:"1晚",Y=P=>{const a=new Date(P),O=a.getFullYear(),U=String(a.getMonth()+1).padStart(2,"0"),q=String(a.getDate()).padStart(2,"0");return`${O}/${U}/${q}`};return`${Y(o)}~${Y(f)} ${B} ${n||1}间`}return""}catch(l){return console.error("格式化日期范围错误:",l,{checkIn:t,checkOut:e,roomCount:n}),""}},te=(t,e)=>{e?z.value.includes(t)||z.value.push(t):z.value=z.value.filter(n=>n!==t)},ae=t=>!t.total_amount||!t.settlement_amount?0:parseFloat(t.total_amount)-parseFloat(t.settlement_amount),K=t=>({paid_pending:"已支付/待确认",confirming:"确认中",confirmed:"预订成功",rejected:"预订失败/拒单",cancel_requested:"申请取消中",cancel_rejected:"取消拒绝",cancel_approved:"取消通过",verified:"核销订单"})[t]||t,se=t=>({paid_pending:"warning",confirming:"info",confirmed:"success",rejected:"danger",cancel_requested:"warning",cancel_rejected:"info",cancel_approved:"info",verified:"success"})[t]||"",ne=t=>{j.alert(`
        <div style="text-align: left;">
            <p><strong>订单号：</strong>${t.order_no}</p>
            <p><strong>OTA订单号：</strong>${t.ota_order_no||"-"}</p>
            <p><strong>状态：</strong>${K(t.status)}</p>
            <p><strong>入住日期：</strong>${t.check_in_date}</p>
            <p><strong>离店日期：</strong>${t.check_out_date}</p>
            <p><strong>房间数：</strong>${t.room_count}</p>
            <p><strong>订单金额：</strong>¥${F(t.total_amount)}</p>
            <p><strong>联系人：</strong>${t.contact_name}</p>
            <p><strong>联系电话：</strong>${t.contact_phone}</p>
        </div>
        `,"订单详情",{dangerouslyUseHTMLString:!0})},oe=async t=>{var e,n,l,c;try{await j.confirm((n=(e=t.hotel)==null?void 0:e.scenic_spot)!=null&&n.is_system_connected?"确定要接单吗？系统将自动调用资源方接口确认订单。":"确定要接单吗？","接单确认",{type:"info",confirmButtonText:"确定",cancelButtonText:"取消"}),p.value[t.id]="confirm";const i=await T.post(`/orders/${t.id}/confirm`,{remark:""});i.data.success?(u.success(i.data.message||"接单成功"),y()):u.error(i.data.message||"接单失败")}catch(i){if(i!=="cancel"){const o=((c=(l=i.response)==null?void 0:l.data)==null?void 0:c.message)||"接单失败";u.error(o)}}finally{p.value[t.id]=null}},le=async t=>{var e,n;try{const{value:l}=await j.prompt("请输入拒单原因","拒单",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"请输入拒单原因",inputValidator:i=>!i||i.trim().length===0?"拒单原因不能为空":!0});p.value[t.id]="reject";const c=await T.post(`/orders/${t.id}/reject`,{reason:l.trim()});c.data.success?(u.success(c.data.message||"拒单成功"),y()):u.error(c.data.message||"拒单失败")}catch(l){if(l!=="cancel"){const c=((n=(e=l.response)==null?void 0:e.data)==null?void 0:n.message)||"拒单失败";u.error(c)}}finally{p.value[t.id]=null}},ce=async t=>{var e,n,l,c;try{const i={use_start_date:t.check_in_date,use_end_date:t.check_out_date,use_quantity:t.room_count,passengers:[],vouchers:[]};await j.confirm((n=(e=t.hotel)==null?void 0:e.scenic_spot)!=null&&n.is_system_connected?"确定要核销订单吗？系统将自动调用资源方接口核销订单。":"确定要核销订单吗？","核销确认",{type:"info",confirmButtonText:"确定",cancelButtonText:"取消"}),p.value[t.id]="verify";const o=await T.post(`/orders/${t.id}/verify`,i);o.data.success?(u.success(o.data.message||"核销成功"),y()):u.error(o.data.message||"核销失败")}catch(i){if(i!=="cancel"){const o=((c=(l=i.response)==null?void 0:l.data)==null?void 0:c.message)||"核销失败";u.error(o)}}finally{p.value[t.id]=null}},ie=async t=>{var e,n;try{await j.confirm("确定要同意取消订单吗？同意后将释放库存并通知OTA平台。","同意取消确认",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"}),p.value[t.id]="approveCancel";const l=await T.post(`/orders/${t.id}/approve-cancel`,{reason:"人工同意取消"});l.data.success?(u.success(l.data.message||"同意取消成功"),y()):u.error(l.data.message||"同意取消失败")}catch(l){if(l!=="cancel"){const c=((n=(e=l.response)==null?void 0:e.data)==null?void 0:n.message)||"同意取消失败";u.error(c)}}finally{p.value[t.id]=null}},re=async t=>{var e,n;try{const{value:l}=await j.prompt("请输入拒绝取消的原因","拒绝取消",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"请输入拒绝取消的原因",inputValidator:i=>!i||i.trim().length===0?"拒绝取消的原因不能为空":!0});p.value[t.id]="rejectCancel";const c=await T.post(`/orders/${t.id}/reject-cancel`,{reason:l.trim()});c.data.success?(u.success(c.data.message||"拒绝取消成功"),y()):u.error(c.data.message||"拒绝取消失败")}catch(l){if(l!=="cancel"){const c=((n=(e=l.response)==null?void 0:e.data)==null?void 0:n.message)||"拒绝取消失败";u.error(c)}}finally{p.value[t.id]=null}};return ue(()=>{y(),L(),window.addEventListener("resize",L)}),pe(()=>{window.removeEventListener("resize",L)}),(t,e)=>{const n=k("el-option"),l=k("el-select"),c=k("el-input"),i=k("el-date-picker"),o=k("el-button"),f=k("el-checkbox"),$=k("el-tag"),B=k("el-pagination"),Y=k("el-card"),P=me("loading");return m(),C("div",fe,[e[21]||(e[21]=s("h2",null,"订单管理",-1)),r(Y,null,{default:g(()=>[s("div",ye,[r(l,{modelValue:d.value.status,"onUpdate:modelValue":e[0]||(e[0]=a=>d.value.status=a),placeholder:"订单状态",clearable:"",style:{width:"150px"},onChange:b},{default:g(()=>[r(n,{label:"已支付/待确认",value:"paid_pending"}),r(n,{label:"确认中",value:"confirming"}),r(n,{label:"预订成功",value:"confirmed"}),r(n,{label:"预订失败/拒单",value:"rejected"}),r(n,{label:"申请取消中",value:"cancel_requested"}),r(n,{label:"取消拒绝",value:"cancel_rejected"}),r(n,{label:"取消通过",value:"cancel_approved"}),r(n,{label:"核销订单",value:"verified"})]),_:1},8,["modelValue"]),r(c,{modelValue:d.value.order_no,"onUpdate:modelValue":e[1]||(e[1]=a=>d.value.order_no=a),placeholder:"订单号",clearable:"",style:{width:"200px"},onClear:b,onKeyup:Q(b,["enter"])},null,8,["modelValue"]),r(c,{modelValue:d.value.ota_order_no,"onUpdate:modelValue":e[2]||(e[2]=a=>d.value.ota_order_no=a),placeholder:"OTA订单号",clearable:"",style:{width:"200px"},onClear:b,onKeyup:Q(b,["enter"])},null,8,["modelValue"]),r(i,{modelValue:d.value.check_in_date,"onUpdate:modelValue":e[3]||(e[3]=a=>d.value.check_in_date=a),type:"date",placeholder:"入住日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"150px"},onChange:b},null,8,["modelValue"]),r(o,{onClick:b},{default:g(()=>[...e[6]||(e[6]=[v("筛选",-1)])]),_:1}),r(o,{onClick:X},{default:g(()=>[...e[7]||(e[7]=[v("重置",-1)])]),_:1})]),ge((m(),C("div",he,[(m(!0),C(R,null,ve(M.value,a=>{var O,U,q,H,W,I,G,J;return m(),C("div",{key:a.id,class:"order-item"},[s("div",ke,[s("span",be,[e[8]||(e[8]=s("span",{class:"label"},"系统订单号：",-1)),s("span",$e,_(a.order_no),1)]),s("span",xe,[e[9]||(e[9]=s("span",{class:"label"},"渠道订单号：",-1)),s("span",Ce,_(a.ota_order_no||"-"),1)]),s("span",Se,[e[10]||(e[10]=s("span",{class:"label"},"下单时间：",-1)),s("span",Te,_(Z(a.created_at)),1)]),s("span",De,[e[11]||(e[11]=s("span",{class:"label"},"来源：",-1)),s("span",je,_(((O=a.ota_platform)==null?void 0:O.name)||"-"),1)])]),s("div",ze,[s("div",Be,[r(f,{"model-value":z.value.includes(a.id),"onUpdate:modelValue":x=>te(a.id,x)},null,8,["model-value","onUpdate:modelValue"])]),s("div",Me,[s("div",Ve,_(((U=a.product)==null?void 0:U.name)||"-"),1),(H=(q=a.product)==null?void 0:q.scenic_spot)!=null&&H.name?(m(),D($,{key:0,size:"small",type:"info",class:"scenic-tag"},{default:g(()=>[v(_(a.product.scenic_spot.name),1)]),_:2},1024)):S("",!0)]),s("div",we,[s("div",Fe,_(((W=a.hotel)==null?void 0:W.name)||"-"),1),s("div",Ye,[(I=a.room_type)!=null&&I.name?(m(),C("div",Oe,_(a.room_type.name),1)):S("",!0),s("div",Ue,[a.check_in_date||a.check_out_date?(m(),C(R,{key:0},[v(_(ee(a.check_in_date,a.check_out_date,a.room_count)),1)],64)):(m(),C(R,{key:1},[v("-")],64))])])]),s("div",qe,[s("div",Ne,_(a.contact_name||"-"),1),s("div",Ee,_(a.contact_phone||"-"),1)]),s("div",Le,[s("div",Pe,[e[12]||(e[12]=s("span",{class:"amount-label"},"销售金额：",-1)),s("span",Re,"¥"+_(F(a.total_amount)),1)]),s("div",Ae,[e[13]||(e[13]=s("span",{class:"amount-label"},"结算金额：",-1)),s("span",Ke,"¥"+_(F(a.settlement_amount)),1)]),s("div",He,[e[14]||(e[14]=s("span",{class:"amount-label"},"预估收入：",-1)),s("span",We,"¥"+_(F(ae(a))),1)])]),s("div",Ie,[r($,{type:se(a.status),size:"small",class:"status-tag"},{default:g(()=>[v(_(K(a.status)),1)]),_:2},1032,["type"])]),s("div",Ge,[r(o,{size:"small",text:"",type:"primary",onClick:x=>ne(a),class:"action-btn-text"},{default:g(()=>[...e[15]||(e[15]=[v(" 详情 ",-1)])]),_:1},8,["onClick"]),["paid_pending","confirming"].includes(a.status)?(m(),D(o,{key:0,size:"small",type:"success",onClick:x=>oe(a),loading:p.value[a.id]==="confirm",class:"action-btn-primary"},{default:g(()=>[...e[16]||(e[16]=[v(" 接单 ",-1)])]),_:1},8,["onClick","loading"])):S("",!0),["paid_pending","confirming"].includes(a.status)?(m(),D(o,{key:1,size:"small",type:"danger",onClick:x=>le(a),loading:p.value[a.id]==="reject",class:"action-btn-primary"},{default:g(()=>[...e[17]||(e[17]=[v(" 拒单 ",-1)])]),_:1},8,["onClick","loading"])):S("",!0),a.status==="confirmed"?(m(),D(o,{key:2,size:"small",type:"primary",onClick:x=>ce(a),loading:p.value[a.id]==="verify",class:"action-btn-primary"},{default:g(()=>[...e[18]||(e[18]=[v(" 核销 ",-1)])]),_:1},8,["onClick","loading"])):S("",!0),a.status==="cancel_requested"||((G=a.status)==null?void 0:G.value)==="cancel_requested"?(m(),D(o,{key:3,size:"small",type:"success",onClick:x=>ie(a),loading:p.value[a.id]==="approveCancel",class:"action-btn-primary"},{default:g(()=>[...e[19]||(e[19]=[v(" 同意取消 ",-1)])]),_:1},8,["onClick","loading"])):S("",!0),a.status==="cancel_requested"||((J=a.status)==null?void 0:J.value)==="cancel_requested"?(m(),D(o,{key:4,size:"small",type:"danger",onClick:x=>re(a),loading:p.value[a.id]==="rejectCancel",class:"action-btn-primary"},{default:g(()=>[...e[20]||(e[20]=[v(" 拒绝取消 ",-1)])]),_:1},8,["onClick","loading"])):S("",!0)])])])}),128))])),[[P,N.value]]),r(B,{"current-page":V.value,"onUpdate:currentPage":e[4]||(e[4]=a=>V.value=a),"page-size":E.value,"onUpdate:pageSize":e[5]||(e[5]=a=>E.value=a),total:A.value,onCurrentChange:y,onSizeChange:y,class:"pagination-container",layout:w.value},null,8,["current-page","page-size","total","layout"])]),_:1})])}}},Ze=de(Je,[["__scopeId","data-v-07d8dd0e"]]);export{Ze as default};
