import{_ as ye,u as be,r as p,y as W,i as xe,c as h,o as f,f as x,b as t,w as o,d as c,k,E as m,e as we,l as Ve,m as he,h as y,F as j,p as A,q as Y,z as X,A as ke,t as N,B as De,s as Ce,v as Ue}from"./app-DPb7JCSN.js";const ze={style:{"margin-bottom":"20px"}},Se={key:0,style:{"font-size":"12px",color:"#909399","margin-top":"5px"}},Ye={key:1,style:{"font-size":"12px",color:"#f56c6c","margin-top":"5px"}},$e={key:2,style:{"font-size":"12px",color:"#909399","margin-top":"5px"}},Ee={__name:"Index",setup(Me){const v=be(),Z=we(),$=p([]),b=p([]),w=p([]),R=p(!1),I=p(!1),L=p({}),D=p(!1),U=p(null),E=p(""),M=p(null),T=p(null),z=p(1),F=p(15),O=p(0),S=p(null),q=W(()=>S.value!==null),ee=W(()=>q.value?"编辑产品":"创建产品"),s=p({scenic_spot_id:null,software_provider_id:null,name:"",code:"",description:"",price_source:"manual",stay_days:1,sale_start_date:null,sale_end_date:null,is_active:!0}),ae={scenic_spot_id:[{required:!0,message:"请选择所属景区",trigger:"change"}],software_provider_id:[{required:!0,message:"请选择软件服务商",trigger:"change"}],name:[{required:!0,message:"请输入产品名称",trigger:"blur"},{max:255,message:"产品名称不能超过255个字符",trigger:"blur"}],external_code:[{max:255,message:"外部产品编码不能超过255个字符",trigger:"blur"}],price_source:[{required:!0,message:"请选择价格来源",trigger:"change"}],stay_days:[{required:!0,message:"请输入入住天数",trigger:"blur"},{type:"number",min:1,max:30,message:"入住天数必须在1-30之间",trigger:"blur"}],sale_start_date:[{required:!0,message:"请选择销售开始日期",trigger:"change"}],sale_end_date:[{validator:(l,e,n)=>{e?s.value.sale_start_date&&e<s.value.sale_start_date?n(new Error("销售结束日期不能早于开始日期")):n():n(new Error("请选择销售结束日期"))},trigger:"change"}]},V=async()=>{R.value=!0;try{const l={page:z.value,per_page:F.value};M.value&&(l.scenic_spot_id=M.value),T.value!==null&&(l.is_active=T.value),E.value&&(l.search=E.value);const e=await k.get("/products",{params:l});e.data&&e.data.data?($.value=e.data.data||[],O.value=e.data.total||0):($.value=e.data||[],O.value=$.value.length)}catch(l){m.error("获取产品列表失败"),console.error(l)}finally{R.value=!1}},J=async()=>{var l,e,n,r;try{if(((l=v.user)==null?void 0:l.role)!=="admin")(!v.user||!v.user.scenic_spots||v.user.scenic_spots.length===0)&&await v.fetchUser(),b.value=((e=v.user)==null?void 0:e.scenic_spots)||[],b.value.length===0&&console.warn("运营用户未绑定任何景区");else{const d=await k.get("/scenic-spots");b.value=d.data.data||[]}}catch(d){if(console.error("获取景区列表失败",d),(n=v.user)!=null&&n.scenic_spots&&v.user.scenic_spots.length>0)b.value=v.user.scenic_spots;else try{await v.fetchUser(),b.value=((r=v.user)==null?void 0:r.scenic_spots)||[]}catch(_){console.error("获取用户信息失败",_)}}},le=()=>{z.value=1,V()},K=()=>{z.value=1,V()},te=async()=>{var l;if(S.value=null,P(),b.value.length===0&&await J(),((l=v.user)==null?void 0:l.role)!=="admin"&&b.value.length===0){m.warning("您未绑定任何景区，请联系管理员为您分配景区");return}D.value=!0},se=l=>{Z.push(`/products/${l.id}/detail`)},G=async(l,e=!1)=>{const n=e?s.value.software_provider_id:null;if(s.value.software_provider_id=null,w.value=[],l)try{const d=(await k.get(`/scenic-spots/${l}`)).data.data;w.value=d.software_providers||[],e&&n&&(w.value.some(u=>u.id===n)?s.value.software_provider_id=n:(s.value.software_provider_id=null,m.warning("该产品配置的服务商不属于当前景区的服务商列表，请重新选择"))),w.value.length===0&&m.warning("该景区尚未配置服务商，请先在景区管理页面添加服务商")}catch(r){m.error("获取景区服务商列表失败"),console.error(r)}},H=l=>l?typeof l=="string"&&l.includes("T")?l.split("T")[0]:(typeof l=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(l),l):null,oe=async l=>{S.value=l.id,s.value={scenic_spot_id:l.scenic_spot_id,software_provider_id:l.software_provider_id||null,name:l.name,code:l.code,external_code:l.external_code||"",description:l.description||"",price_source:l.price_source||"manual",stay_days:l.stay_days||1,sale_start_date:H(l.sale_start_date),sale_end_date:H(l.sale_end_date),is_active:l.is_active},l.scenic_spot_id&&await G(l.scenic_spot_id,!0),D.value=!0},ne=async()=>{U.value&&U.value.validate(async l=>{var e,n,r,d,_,u;if(l){I.value=!0;try{const i={...s.value,stay_days:s.value.stay_days||1,sale_start_date:s.value.sale_start_date||null,sale_end_date:s.value.sale_end_date||null};delete i.code,i.external_code===""&&(i.external_code=null),q.value?(await k.put(`/products/${S.value}`,i),m.success("产品更新成功")):(await k.post("/products",i),m.success("产品创建成功")),D.value=!1,P(),setTimeout(()=>{V()},100)}catch(i){const B=((n=(e=i.response)==null?void 0:e.data)==null?void 0:n.message)||((u=(_=(d=(r=i.response)==null?void 0:r.data)==null?void 0:d.errors)==null?void 0:_.code)==null?void 0:u[0])||"操作失败";m.error(B)}finally{I.value=!1}}})},re=async l=>{var e,n;try{await Ue.confirm(`确定要删除产品"${l.name}"吗？删除后无法恢复！`,"提示",{type:"warning",confirmButtonText:"确定删除",cancelButtonText:"取消"}),await k.delete(`/products/${l.id}`),m.success("删除成功"),V()}catch(r){if(r!=="cancel"){const d=((n=(e=r.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败";m.error(d)}}},P=()=>{S.value=null,s.value={scenic_spot_id:null,software_provider_id:null,name:"",code:"",external_code:"",description:"",price_source:"manual",stay_days:1,sale_start_date:null,sale_end_date:null,is_active:!0},w.value=[],U.value&&U.value.clearValidate()},de=l=>l?new Date(l).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",ie=async l=>{L.value[l.id]=!0;try{const e=await k.get(`/products/${l.id}/export`,{responseType:"blob",validateStatus:_=>_<500});if((e.headers["content-type"]||"").includes("application/json")||e.status>=400){const _=await e.data.text();let u="导出失败";try{u=JSON.parse(_).message||u}catch{u=_||u}m.error(u),console.error("导出失败",u);return}const r=window.URL.createObjectURL(new Blob([e.data])),d=document.createElement("a");d.href=r,d.setAttribute("download",`product_${l.code}_${new Date().toISOString().slice(0,10)}.csv`),document.body.appendChild(d),d.click(),d.remove(),window.URL.revokeObjectURL(r),m.success("导出成功")}catch(e){let n="导出失败";if(e.response){if(e.response.data)if(typeof e.response.data=="string")try{n=JSON.parse(e.response.data).message||n}catch{n=e.response.data||n}else e.response.data.message&&(n=e.response.data.message)}else e.message&&(n=e.message);m.error(n),console.error("导出失败",e)}finally{L.value[l.id]=!1}};return xe(()=>{V(),J()}),(l,e)=>{const n=c("el-button"),r=c("el-option"),d=c("el-select"),_=c("el-icon"),u=c("el-input"),i=c("el-table-column"),B=c("el-tag"),ue=c("el-table"),pe=c("el-pagination"),ce=c("el-card"),g=c("el-form-item"),_e=c("el-input-number"),Q=c("el-date-picker"),me=c("el-switch"),ve=c("el-form"),fe=c("el-dialog"),ge=Ve("loading");return f(),h("div",null,[e[31]||(e[31]=x("h2",null,"产品管理",-1)),t(ce,null,{default:o(()=>[x("div",ze,[t(n,{type:"primary",onClick:te},{default:o(()=>[...e[18]||(e[18]=[y("创建产品",-1)])]),_:1}),t(d,{modelValue:M.value,"onUpdate:modelValue":e[0]||(e[0]=a=>M.value=a),placeholder:"筛选景区",clearable:"",style:{width:"200px","margin-left":"10px"},onChange:K},{default:o(()=>[(f(!0),h(j,null,A(b.value,a=>(f(),Y(r,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(d,{modelValue:T.value,"onUpdate:modelValue":e[1]||(e[1]=a=>T.value=a),placeholder:"筛选状态",clearable:"",style:{width:"150px","margin-left":"10px"},onChange:K},{default:o(()=>[t(r,{label:"启用",value:!0}),t(r,{label:"禁用",value:!1})]),_:1},8,["modelValue"]),t(u,{modelValue:E.value,"onUpdate:modelValue":e[2]||(e[2]=a=>E.value=a),placeholder:"搜索产品名称或编码",style:{width:"300px","margin-left":"10px"},clearable:"",onInput:le},{prefix:o(()=>[t(_,null,{default:o(()=>[t(X(ke))]),_:1})]),_:1},8,["modelValue"])]),he((f(),Y(ue,{data:$.value,border:""},{default:o(()=>[t(i,{prop:"name",label:"产品名称",width:"200"}),t(i,{prop:"code",label:"产品编码",width:"150"}),t(i,{prop:"external_code",label:"外部产品编码",width:"150"}),t(i,{label:"所属景区",width:"150"},{default:o(({row:a})=>{var C;return[y(N(((C=a.scenic_spot)==null?void 0:C.name)||"-"),1)]}),_:1}),t(i,{prop:"description",label:"描述","show-overflow-tooltip":""}),t(i,{prop:"price_source",label:"价格来源",width:"120"},{default:o(({row:a})=>[t(B,{type:a.price_source==="manual"?"primary":"success"},{default:o(()=>[y(N(a.price_source==="manual"?"人工维护":"接口推送"),1)]),_:2},1032,["type"])]),_:1}),t(i,{prop:"is_active",label:"状态",width:"100"},{default:o(({row:a})=>[t(B,{type:a.is_active?"success":"danger"},{default:o(()=>[y(N(a.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),t(i,{prop:"created_at",label:"创建时间",width:"180"},{default:o(({row:a})=>[y(N(de(a.created_at)),1)]),_:1}),t(i,{label:"操作",width:"350",fixed:"right"},{default:o(({row:a})=>[t(n,{size:"small",onClick:C=>se(a)},{default:o(()=>[...e[19]||(e[19]=[y("详情",-1)])]),_:1},8,["onClick"]),t(n,{size:"small",onClick:C=>oe(a)},{default:o(()=>[...e[20]||(e[20]=[y("编辑",-1)])]),_:1},8,["onClick"]),t(n,{size:"small",type:"success",onClick:C=>ie(a),loading:L.value[a.id]},{default:o(()=>[t(_,null,{default:o(()=>[t(X(De))]),_:1}),e[21]||(e[21]=y(" 导出 ",-1))]),_:1},8,["onClick","loading"]),t(n,{size:"small",type:"danger",onClick:C=>re(a)},{default:o(()=>[...e[22]||(e[22]=[y("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ge,R.value]]),t(pe,{"current-page":z.value,"onUpdate:currentPage":e[3]||(e[3]=a=>z.value=a),"page-size":F.value,"onUpdate:pageSize":e[4]||(e[4]=a=>F.value=a),"page-sizes":[10,20,50,100],total:O.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"},onSizeChange:V,onCurrentChange:V},null,8,["current-page","page-size","total"])]),_:1}),t(fe,{modelValue:D.value,"onUpdate:modelValue":e[17]||(e[17]=a=>D.value=a),title:ee.value,width:"600px",onClose:P},{footer:o(()=>[t(n,{onClick:e[16]||(e[16]=a=>D.value=!1)},{default:o(()=>[...e[29]||(e[29]=[y("取消",-1)])]),_:1}),t(n,{type:"primary",onClick:ne,loading:I.value},{default:o(()=>[...e[30]||(e[30]=[y("确定",-1)])]),_:1},8,["loading"])]),default:o(()=>[t(ve,{ref_key:"formRef",ref:U,model:s.value,rules:ae,"label-width":"120px"},{default:o(()=>[t(g,{label:"所属景区",prop:"scenic_spot_id"},{default:o(()=>[t(d,{modelValue:s.value.scenic_spot_id,"onUpdate:modelValue":e[5]||(e[5]=a=>s.value.scenic_spot_id=a),placeholder:"请选择景区",style:{width:"100%"},disabled:q.value,onChange:G},{default:o(()=>[(f(!0),h(j,null,A(b.value,a=>(f(),Y(r,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),t(g,{label:"软件服务商",prop:"software_provider_id",required:""},{default:o(()=>[t(d,{modelValue:s.value.software_provider_id,"onUpdate:modelValue":e[6]||(e[6]=a=>s.value.software_provider_id=a),placeholder:"请先选择景区",style:{width:"100%"},disabled:!s.value.scenic_spot_id},{default:o(()=>[(f(!0),h(j,null,A(w.value,a=>(f(),Y(r,{key:a.id,label:`${a.name} (${a.api_type||"无类型"})`,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),s.value.scenic_spot_id?w.value.length===0?(f(),h("div",Ye," 该景区尚未配置服务商，请先在景区管理页面添加服务商 ")):(f(),h("div",$e," 选择产品使用的软件服务商（必填） ")):(f(),h("div",Se," 请先选择景区，然后选择该景区下的服务商 "))]),_:1}),t(g,{label:"产品名称",prop:"name"},{default:o(()=>[t(u,{modelValue:s.value.name,"onUpdate:modelValue":e[7]||(e[7]=a=>s.value.name=a),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),q.value?(f(),Y(g,{key:0,label:"产品编码",prop:"code"},{default:o(()=>[t(u,{modelValue:s.value.code,"onUpdate:modelValue":e[8]||(e[8]=a=>s.value.code=a),placeholder:"系统自动生成",disabled:""},null,8,["modelValue"]),e[23]||(e[23]=x("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品编码由系统自动生成，不可修改 ",-1))]),_:1})):Ce("",!0),t(g,{label:"外部产品编码",prop:"external_code"},{default:o(()=>[t(u,{modelValue:s.value.external_code,"onUpdate:modelValue":e[9]||(e[9]=a=>s.value.external_code=a),placeholder:"请输入外部产品编码（可选，用于和景区系统对接，如横店）"},null,8,["modelValue"]),e[24]||(e[24]=x("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 用于和景区系统（如横店）对接的产品编码，如果产品不需要对接外部系统，可留空 ",-1))]),_:1}),t(g,{label:"描述",prop:"description"},{default:o(()=>[t(u,{modelValue:s.value.description,"onUpdate:modelValue":e[10]||(e[10]=a=>s.value.description=a),type:"textarea",rows:4,placeholder:"请输入产品描述"},null,8,["modelValue"])]),_:1}),t(g,{label:"价格来源",prop:"price_source"},{default:o(()=>[t(d,{modelValue:s.value.price_source,"onUpdate:modelValue":e[11]||(e[11]=a=>s.value.price_source=a),placeholder:"请选择价格来源",style:{width:"100%"}},{default:o(()=>[t(r,{label:"人工维护",value:"manual"}),t(r,{label:"接口推送",value:"api"})]),_:1},8,["modelValue"]),e[25]||(e[25]=x("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 选择接口推送后，价格将通过资源方接口自动更新 ",-1))]),_:1}),t(g,{label:"入住天数",prop:"stay_days",required:""},{default:o(()=>[t(_e,{modelValue:s.value.stay_days,"onUpdate:modelValue":e[12]||(e[12]=a=>s.value.stay_days=a),min:1,max:30,placeholder:"请输入入住天数（必填）",style:{width:"100%"}},null,8,["modelValue"]),e[26]||(e[26]=x("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品需要连续入住的天数，至少为1 ",-1))]),_:1}),t(g,{label:"销售开始日期",prop:"sale_start_date"},{default:o(()=>[t(Q,{modelValue:s.value.sale_start_date,"onUpdate:modelValue":e[13]||(e[13]=a=>s.value.sale_start_date=a),type:"date",placeholder:"选择销售开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":a=>s.value.sale_end_date&&a>new Date(s.value.sale_end_date)},null,8,["modelValue","disabled-date"]),e[27]||(e[27]=x("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品开始销售的日期（必填） ",-1))]),_:1}),t(g,{label:"销售结束日期",prop:"sale_end_date"},{default:o(()=>[t(Q,{modelValue:s.value.sale_end_date,"onUpdate:modelValue":e[14]||(e[14]=a=>s.value.sale_end_date=a),type:"date",placeholder:"选择销售结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":a=>s.value.sale_start_date&&a<new Date(s.value.sale_start_date)},null,8,["modelValue","disabled-date"]),e[28]||(e[28]=x("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}}," 产品结束销售的日期（必填），不能早于开始日期 ",-1))]),_:1}),t(g,{label:"状态",prop:"is_active"},{default:o(()=>[t(me,{modelValue:s.value.is_active,"onUpdate:modelValue":e[15]||(e[15]=a=>s.value.is_active=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Be=ye(Ee,[["__scopeId","data-v-983a7e4e"]]);export{Be as default};
