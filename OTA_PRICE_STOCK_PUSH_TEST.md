# OTA价库推送功能测试指南

## 功能概述

本功能实现了向携程平台推送产品价格和库存的功能，支持：
- 按"产品-酒店-房型"组合推送
- 产品编码格式：`产品编码|酒店编码|房型编码`
- 定时推送（每半小时）
- 变化检测（只推送有变化的数据）
- 产品状态控制（未启用产品不推送）

## 前置条件

### 1. 环境配置

在 `.env` 文件中添加以下配置：

```env
# 携程正式环境配置
CTRIP_ACCOUNT_ID=f4f74fea0b245fb6
CTRIP_SECRET_KEY=12b5c42b74ef4dacbec5a24951327705
CTRIP_ENCRYPT_KEY=523bd2dcf179a217
CTRIP_ENCRYPT_IV=45042d64866cf6d1
CTRIP_ORDER_API_URL=https://ttdopen.ctrip.com/api/order/notice.do
CTRIP_PRICE_API_URL=https://ttdopen.ctrip.com/api/product/price.do
CTRIP_STOCK_API_URL=https://ttdopen.ctrip.com/api/product/stock.do
CTRIP_WEBHOOK_URL=https://www.laidoulaile.online/api/webhooks/ctrip
```

### 2. 数据库迁移

已运行迁移，创建了 `ota_product_sync_logs` 表。

### 3. 数据准备

确保有以下数据：
- 产品（`products`）：必须有 `code` 字段
- 酒店（`hotels`）：必须有 `code` 字段
- 房型（`room_types`）：必须有 `code` 字段
- 价格数据（`prices`）：产品关联房型的价格
- 库存数据（`inventories`）：房型的库存

## 测试步骤

### 1. 测试单个产品的价库推送

使用测试命令：

```bash
php artisan test:ota-push {product_id}
```

例如：
```bash
php artisan test:ota-push 1
```

该命令会：
- 检查产品是否存在
- 检查产品编码、酒店编码、房型编码是否齐全
- 列出所有"产品-酒店-房型"组合
- 逐个测试价格推送
- 逐个测试库存推送
- 显示测试结果

### 2. 通过前端测试

#### 2.1 推送产品到OTA平台

1. 登录管理后台
2. 进入"产品管理"页面
3. 点击某个产品的"详情"按钮
4. 切换到"OTA推送"标签页
5. 点击"推送到OTA平台"按钮
6. 选择"携程"平台
7. 点击"确定"

系统会：
- 检查产品是否关联酒店和房型
- 检查编码是否齐全
- 为每个"产品-酒店-房型"组合推送价格和库存
- 创建或更新 `ota_products` 记录

#### 2.2 导出产品信息

1. 在"产品管理"页面
2. 点击"导出Excel"按钮
3. 系统会下载CSV文件，包含：
   - 产品ID
   - 产品名称
   - 酒店名称
   - 房型名称
   - 携程PLU编号（格式：产品编码|酒店编码|房型编码）

### 3. 测试定时推送

#### 3.1 手动触发定时任务

```bash
php artisan ota:sync-price-stock
```

该命令会：
- 扫描所有已推送到携程的产品
- 获取每个产品的所有"产品-酒店-房型"组合
- 为每个组合创建队列任务
- 队列任务会检查数据是否有变化，只推送有变化的数据

#### 3.2 启动队列Worker

```bash
php artisan queue:work
```

队列任务会在后台处理推送请求。

#### 3.3 配置定时任务

在服务器 crontab 中添加：

```bash
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

这样系统会每半小时自动推送一次。

## 测试检查点

### 1. 产品编码格式

推送到携程的产品编码应该是：`产品编码|酒店编码|房型编码`

例如：
- 产品编码：`1002`
- 酒店编码：`H001`
- 房型编码：`RT001`
- 携程产品编码：`1002|H001|RT001`

### 2. 价格推送

- 价格应该应用加价规则
- 每个日期一个价格项
- 价格单位是元（不是分）

### 3. 库存推送

- 如果库存设置为关闭（`is_closed = true`），推送的库存应该是 0
- 如果产品设置了 `stay_days > 1`，需要检查连续入住天数的库存
- 库存单位是个数（整数）

### 4. 变化检测

- 首次推送：全量推送
- 后续推送：只推送有变化的数据
- 变化检测使用哈希值对比

### 5. 产品状态控制

- 产品未启用（`is_active = false`）时，不推送
- OTA产品未启用（`ota_products.is_active = false`）时，不推送

## 日志查看

推送过程的日志会记录在 `storage/logs/laravel.log` 中，可以查看：
- 推送请求的详细信息
- 推送结果
- 错误信息

## 常见问题

### 1. 推送失败：产品编码为空

**原因**：产品、酒店或房型的 `code` 字段为空

**解决**：在后台设置产品编码、酒店编码和房型编码

### 2. 推送失败：产品未关联酒店和房型

**原因**：产品没有价格数据（价格数据关联了房型）

**解决**：在后台为产品添加价格数据

### 3. 推送失败：请求失败

**原因**：可能是网络问题、API配置错误或携程接口返回错误

**解决**：
- 检查网络连接
- 检查 `.env` 配置是否正确
- 查看日志获取详细错误信息

### 4. 定时任务不执行

**原因**：队列Worker未启动或定时任务未配置

**解决**：
- 启动队列Worker：`php artisan queue:work`
- 配置crontab定时任务

## 测试数据示例

假设有以下测试数据：

- 产品ID：1
- 产品编码：`1002`
- 酒店ID：1，酒店编码：`H001`
- 房型ID：1，房型编码：`RT001`
- 价格数据：2025-12-27 到 2025-12-31
- 库存数据：2025-12-27 到 2025-12-31

测试命令：
```bash
php artisan test:ota-push 1
```

预期结果：
- 找到1个组合：H001 - RT001
- 携程产品编码：1002|H001|RT001
- 价格推送成功
- 库存推送成功

## 注意事项

1. **正式环境测试**：当前配置的是正式环境参数，推送会实际发送到携程平台
2. **数据准确性**：确保产品编码、酒店编码、房型编码的唯一性和准确性
3. **推送频率**：定时推送每半小时执行一次，避免频繁推送
4. **队列处理**：大量数据推送时，建议使用队列处理，避免阻塞请求

